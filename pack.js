class GFX{width;height;mesh;buffer;texture;flush;free;constructor(t,e,r,i,n,s,a){this.width=t,this.height=e,this.mesh=r,this.buffer=i,this.texture=n,this.flush=s,this.free=a}}class Buffer{width;height;draw;clear;color;depth;free;constructor(t,e,r,i,n,s,a){this.width=t,this.height=e,this.draw=r,this.clear=i,this.color=n,this.depth=s,this.free=a}}let Texture$2=class{width;height;set;free;constructor(t,e,r,i){this.width=t,this.height=e,this.set=r,this.free=i}};class Mesh{free;constructor(t){this.free=t}}class MeshData{indices;positions;uvs;normals;tangents;joints;weights;constructor(t,e,r,i,n,s,a){this.indices=t,this.positions=e,this.uvs=r,this.normals=i,this.tangents=n,this.joints=s,this.weights=a}}class UniformFloat{f;constructor(t){this.f=t}}class UniformInt{i;constructor(t){this.i=t}}class UniformArray{type;value;constructor(t,e){this.type=t,this.value=e}}const GL={DEPTH_BUFFER_BIT:256,STENCIL_BUFFER_BIT:1024,COLOR_BUFFER_BIT:16384,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,ZERO:0,ONE:1,SRC_COLOR:768,ONE_MINUS_SRC_COLOR:769,SRC_ALPHA:770,ONE_MINUS_SRC_ALPHA:771,DST_ALPHA:772,ONE_MINUS_DST_ALPHA:773,DST_COLOR:774,ONE_MINUS_DST_COLOR:775,SRC_ALPHA_SATURATE:776,FUNC_ADD:32774,BLEND_EQUATION:32777,BLEND_EQUATION_RGB:32777,BLEND_EQUATION_ALPHA:34877,FUNC_SUBTRACT:32778,FUNC_REVERSE_SUBTRACT:32779,BLEND_DST_RGB:32968,BLEND_SRC_RGB:32969,BLEND_DST_ALPHA:32970,BLEND_SRC_ALPHA:32971,CONSTANT_COLOR:32769,ONE_MINUS_CONSTANT_COLOR:32770,CONSTANT_ALPHA:32771,ONE_MINUS_CONSTANT_ALPHA:32772,BLEND_COLOR:32773,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,ARRAY_BUFFER_BINDING:34964,ELEMENT_ARRAY_BUFFER_BINDING:34965,STREAM_DRAW:35040,STATIC_DRAW:35044,DYNAMIC_DRAW:35048,BUFFER_SIZE:34660,BUFFER_USAGE:34661,CURRENT_VERTEX_ATTRIB:34342,FRONT:1028,BACK:1029,FRONT_AND_BACK:1032,CULL_FACE:2884,BLEND:3042,DITHER:3024,STENCIL_TEST:2960,DEPTH_TEST:2929,SCISSOR_TEST:3089,POLYGON_OFFSET_FILL:32823,SAMPLE_ALPHA_TO_COVERAGE:32926,SAMPLE_COVERAGE:32928,NO_ERROR:0,INVALID_ENUM:1280,INVALID_VALUE:1281,INVALID_OPERATION:1282,OUT_OF_MEMORY:1285,CW:2304,CCW:2305,LINE_WIDTH:2849,ALIASED_POINT_SIZE_RANGE:33901,ALIASED_LINE_WIDTH_RANGE:33902,CULL_FACE_MODE:2885,FRONT_FACE:2886,DEPTH_RANGE:2928,DEPTH_WRITEMASK:2930,DEPTH_CLEAR_VALUE:2931,DEPTH_FUNC:2932,STENCIL_CLEAR_VALUE:2961,STENCIL_FUNC:2962,STENCIL_FAIL:2964,STENCIL_PASS_DEPTH_FAIL:2965,STENCIL_PASS_DEPTH_PASS:2966,STENCIL_REF:2967,STENCIL_VALUE_MASK:2963,STENCIL_WRITEMASK:2968,STENCIL_BACK_FUNC:34816,STENCIL_BACK_FAIL:34817,STENCIL_BACK_PASS_DEPTH_FAIL:34818,STENCIL_BACK_PASS_DEPTH_PASS:34819,STENCIL_BACK_REF:36003,STENCIL_BACK_VALUE_MASK:36004,STENCIL_BACK_WRITEMASK:36005,VIEWPORT:2978,SCISSOR_BOX:3088,COLOR_CLEAR_VALUE:3106,COLOR_WRITEMASK:3107,UNPACK_ALIGNMENT:3317,PACK_ALIGNMENT:3333,MAX_TEXTURE_SIZE:3379,MAX_VIEWPORT_DIMS:3386,SUBPIXEL_BITS:3408,RED_BITS:3410,GREEN_BITS:3411,BLUE_BITS:3412,ALPHA_BITS:3413,DEPTH_BITS:3414,STENCIL_BITS:3415,POLYGON_OFFSET_UNITS:10752,POLYGON_OFFSET_FACTOR:32824,TEXTURE_BINDING_2D:32873,SAMPLE_BUFFERS:32936,SAMPLES:32937,SAMPLE_COVERAGE_VALUE:32938,SAMPLE_COVERAGE_INVERT:32939,COMPRESSED_TEXTURE_FORMATS:34467,DONT_CARE:4352,FASTEST:4353,NICEST:4354,GENERATE_MIPMAP_HINT:33170,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DEPTH_COMPONENT:6402,ALPHA:6406,RGB:6407,RGBA:6408,LUMINANCE:6409,LUMINANCE_ALPHA:6410,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,FRAGMENT_SHADER:35632,VERTEX_SHADER:35633,MAX_VERTEX_ATTRIBS:34921,MAX_VERTEX_UNIFORM_VECTORS:36347,MAX_VARYING_VECTORS:36348,MAX_COMBINED_TEXTURE_IMAGE_UNITS:35661,MAX_VERTEX_TEXTURE_IMAGE_UNITS:35660,MAX_TEXTURE_IMAGE_UNITS:34930,MAX_FRAGMENT_UNIFORM_VECTORS:36349,SHADER_TYPE:35663,DELETE_STATUS:35712,LINK_STATUS:35714,VALIDATE_STATUS:35715,ATTACHED_SHADERS:35717,ACTIVE_UNIFORMS:35718,ACTIVE_ATTRIBUTES:35721,SHADING_LANGUAGE_VERSION:35724,CURRENT_PROGRAM:35725,NEVER:512,LESS:513,EQUAL:514,LEQUAL:515,GREATER:516,NOTEQUAL:517,GEQUAL:518,ALWAYS:519,KEEP:7680,REPLACE:7681,INCR:7682,DECR:7683,INVERT:5386,INCR_WRAP:34055,DECR_WRAP:34056,VENDOR:7936,RENDERER:7937,VERSION:7938,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,TEXTURE_2D:3553,TEXTURE:5890,TEXTURE_CUBE_MAP:34067,TEXTURE_BINDING_CUBE_MAP:34068,TEXTURE_CUBE_MAP_POSITIVE_X:34069,TEXTURE_CUBE_MAP_NEGATIVE_X:34070,TEXTURE_CUBE_MAP_POSITIVE_Y:34071,TEXTURE_CUBE_MAP_NEGATIVE_Y:34072,TEXTURE_CUBE_MAP_POSITIVE_Z:34073,TEXTURE_CUBE_MAP_NEGATIVE_Z:34074,MAX_CUBE_MAP_TEXTURE_SIZE:34076,TEXTURE0:33984,TEXTURE1:33985,TEXTURE2:33986,TEXTURE3:33987,TEXTURE4:33988,TEXTURE5:33989,TEXTURE6:33990,TEXTURE7:33991,TEXTURE8:33992,TEXTURE9:33993,TEXTURE10:33994,TEXTURE11:33995,TEXTURE12:33996,TEXTURE13:33997,TEXTURE14:33998,TEXTURE15:33999,TEXTURE16:34e3,TEXTURE17:34001,TEXTURE18:34002,TEXTURE19:34003,TEXTURE20:34004,TEXTURE21:34005,TEXTURE22:34006,TEXTURE23:34007,TEXTURE24:34008,TEXTURE25:34009,TEXTURE26:34010,TEXTURE27:34011,TEXTURE28:34012,TEXTURE29:34013,TEXTURE30:34014,TEXTURE31:34015,ACTIVE_TEXTURE:34016,REPEAT:10497,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_CUBE:35680,VERTEX_ATTRIB_ARRAY_ENABLED:34338,VERTEX_ATTRIB_ARRAY_SIZE:34339,VERTEX_ATTRIB_ARRAY_STRIDE:34340,VERTEX_ATTRIB_ARRAY_TYPE:34341,VERTEX_ATTRIB_ARRAY_NORMALIZED:34922,VERTEX_ATTRIB_ARRAY_POINTER:34373,VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:34975,IMPLEMENTATION_COLOR_READ_TYPE:35738,IMPLEMENTATION_COLOR_READ_FORMAT:35739,COMPILE_STATUS:35713,LOW_FLOAT:36336,MEDIUM_FLOAT:36337,HIGH_FLOAT:36338,LOW_INT:36339,MEDIUM_INT:36340,HIGH_INT:36341,FRAMEBUFFER:36160,RENDERBUFFER:36161,RGBA4:32854,RGB5_A1:32855,RGB565:36194,DEPTH_COMPONENT16:33189,STENCIL_INDEX:6401,STENCIL_INDEX8:36168,DEPTH_STENCIL:34041,RENDERBUFFER_WIDTH:36162,RENDERBUFFER_HEIGHT:36163,RENDERBUFFER_INTERNAL_FORMAT:36164,RENDERBUFFER_RED_SIZE:36176,RENDERBUFFER_GREEN_SIZE:36177,RENDERBUFFER_BLUE_SIZE:36178,RENDERBUFFER_ALPHA_SIZE:36179,RENDERBUFFER_DEPTH_SIZE:36180,RENDERBUFFER_STENCIL_SIZE:36181,FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE:36048,FRAMEBUFFER_ATTACHMENT_OBJECT_NAME:36049,FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL:36050,FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE:36051,COLOR_ATTACHMENT0:36064,DEPTH_ATTACHMENT:36096,STENCIL_ATTACHMENT:36128,DEPTH_STENCIL_ATTACHMENT:33306,NONE:0,FRAMEBUFFER_COMPLETE:36053,FRAMEBUFFER_INCOMPLETE_ATTACHMENT:36054,FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:36055,FRAMEBUFFER_INCOMPLETE_DIMENSIONS:36057,FRAMEBUFFER_UNSUPPORTED:36061,FRAMEBUFFER_BINDING:36006,RENDERBUFFER_BINDING:36007,MAX_RENDERBUFFER_SIZE:34024,INVALID_FRAMEBUFFER_OPERATION:1286,UNPACK_FLIP_Y_WEBGL:37440,UNPACK_PREMULTIPLY_ALPHA_WEBGL:37441,CONTEXT_LOST_WEBGL:37442,UNPACK_COLORSPACE_CONVERSION_WEBGL:37443,BROWSER_DEFAULT_WEBGL:37444,READ_BUFFER:3074,UNPACK_ROW_LENGTH:3314,UNPACK_SKIP_ROWS:3315,UNPACK_SKIP_PIXELS:3316,PACK_ROW_LENGTH:3330,PACK_SKIP_ROWS:3331,PACK_SKIP_PIXELS:3332,COLOR:6144,DEPTH:6145,STENCIL:6146,RED:6403,RGB8:32849,RGBA8:32856,RGB10_A2:32857,TEXTURE_BINDING_3D:32874,UNPACK_SKIP_IMAGES:32877,UNPACK_IMAGE_HEIGHT:32878,TEXTURE_3D:32879,TEXTURE_WRAP_R:32882,MAX_3D_TEXTURE_SIZE:32883,UNSIGNED_INT_2_10_10_10_REV:33640,MAX_ELEMENTS_VERTICES:33e3,MAX_ELEMENTS_INDICES:33001,TEXTURE_MIN_LOD:33082,TEXTURE_MAX_LOD:33083,TEXTURE_BASE_LEVEL:33084,TEXTURE_MAX_LEVEL:33085,MIN:32775,MAX:32776,DEPTH_COMPONENT24:33190,MAX_TEXTURE_LOD_BIAS:34045,TEXTURE_COMPARE_MODE:34892,TEXTURE_COMPARE_FUNC:34893,CURRENT_QUERY:34917,QUERY_RESULT:34918,QUERY_RESULT_AVAILABLE:34919,STREAM_READ:35041,STREAM_COPY:35042,STATIC_READ:35045,STATIC_COPY:35046,DYNAMIC_READ:35049,DYNAMIC_COPY:35050,MAX_DRAW_BUFFERS:34852,DRAW_BUFFER0:34853,DRAW_BUFFER1:34854,DRAW_BUFFER2:34855,DRAW_BUFFER3:34856,DRAW_BUFFER4:34857,DRAW_BUFFER5:34858,DRAW_BUFFER6:34859,DRAW_BUFFER7:34860,DRAW_BUFFER8:34861,DRAW_BUFFER9:34862,DRAW_BUFFER10:34863,DRAW_BUFFER11:34864,DRAW_BUFFER12:34865,DRAW_BUFFER13:34866,DRAW_BUFFER14:34867,DRAW_BUFFER15:34868,MAX_FRAGMENT_UNIFORM_COMPONENTS:35657,MAX_VERTEX_UNIFORM_COMPONENTS:35658,SAMPLER_3D:35679,SAMPLER_2D_SHADOW:35682,FRAGMENT_SHADER_DERIVATIVE_HINT:35723,PIXEL_PACK_BUFFER:35051,PIXEL_UNPACK_BUFFER:35052,PIXEL_PACK_BUFFER_BINDING:35053,PIXEL_UNPACK_BUFFER_BINDING:35055,FLOAT_MAT2x3:35685,FLOAT_MAT2x4:35686,FLOAT_MAT3x2:35687,FLOAT_MAT3x4:35688,FLOAT_MAT4x2:35689,FLOAT_MAT4x3:35690,SRGB:35904,SRGB8:35905,SRGB8_ALPHA8:35907,COMPARE_REF_TO_TEXTURE:34894,RGBA32F:34836,RGB32F:34837,RGBA16F:34842,RGB16F:34843,VERTEX_ATTRIB_ARRAY_INTEGER:35069,MAX_ARRAY_TEXTURE_LAYERS:35071,MIN_PROGRAM_TEXEL_OFFSET:35076,MAX_PROGRAM_TEXEL_OFFSET:35077,MAX_VARYING_COMPONENTS:35659,TEXTURE_2D_ARRAY:35866,TEXTURE_BINDING_2D_ARRAY:35869,R11F_G11F_B10F:35898,UNSIGNED_INT_10F_11F_11F_REV:35899,RGB9_E5:35901,UNSIGNED_INT_5_9_9_9_REV:35902,TRANSFORM_FEEDBACK_BUFFER_MODE:35967,MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS:35968,TRANSFORM_FEEDBACK_VARYINGS:35971,TRANSFORM_FEEDBACK_BUFFER_START:35972,TRANSFORM_FEEDBACK_BUFFER_SIZE:35973,TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN:35976,RASTERIZER_DISCARD:35977,MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS:35978,MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS:35979,INTERLEAVED_ATTRIBS:35980,SEPARATE_ATTRIBS:35981,TRANSFORM_FEEDBACK_BUFFER:35982,TRANSFORM_FEEDBACK_BUFFER_BINDING:35983,RGBA32UI:36208,RGB32UI:36209,RGBA16UI:36214,RGB16UI:36215,RGBA8UI:36220,RGB8UI:36221,RGBA32I:36226,RGB32I:36227,RGBA16I:36232,RGB16I:36233,RGBA8I:36238,RGB8I:36239,RED_INTEGER:36244,RGB_INTEGER:36248,RGBA_INTEGER:36249,SAMPLER_2D_ARRAY:36289,SAMPLER_2D_ARRAY_SHADOW:36292,SAMPLER_CUBE_SHADOW:36293,UNSIGNED_INT_VEC2:36294,UNSIGNED_INT_VEC3:36295,UNSIGNED_INT_VEC4:36296,INT_SAMPLER_2D:36298,INT_SAMPLER_3D:36299,INT_SAMPLER_CUBE:36300,INT_SAMPLER_2D_ARRAY:36303,UNSIGNED_INT_SAMPLER_2D:36306,UNSIGNED_INT_SAMPLER_3D:36307,UNSIGNED_INT_SAMPLER_CUBE:36308,UNSIGNED_INT_SAMPLER_2D_ARRAY:36311,DEPTH_COMPONENT32F:36012,DEPTH32F_STENCIL8:36013,FLOAT_32_UNSIGNED_INT_24_8_REV:36269,FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING:33296,FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE:33297,FRAMEBUFFER_ATTACHMENT_RED_SIZE:33298,FRAMEBUFFER_ATTACHMENT_GREEN_SIZE:33299,FRAMEBUFFER_ATTACHMENT_BLUE_SIZE:33300,FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE:33301,FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE:33302,FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE:33303,FRAMEBUFFER_DEFAULT:33304,UNSIGNED_INT_24_8:34042,DEPTH24_STENCIL8:35056,UNSIGNED_NORMALIZED:35863,DRAW_FRAMEBUFFER_BINDING:36006,READ_FRAMEBUFFER:36008,DRAW_FRAMEBUFFER:36009,READ_FRAMEBUFFER_BINDING:36010,RENDERBUFFER_SAMPLES:36011,FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER:36052,MAX_COLOR_ATTACHMENTS:36063,COLOR_ATTACHMENT1:36065,COLOR_ATTACHMENT2:36066,COLOR_ATTACHMENT3:36067,COLOR_ATTACHMENT4:36068,COLOR_ATTACHMENT5:36069,COLOR_ATTACHMENT6:36070,COLOR_ATTACHMENT7:36071,COLOR_ATTACHMENT8:36072,COLOR_ATTACHMENT9:36073,COLOR_ATTACHMENT10:36074,COLOR_ATTACHMENT11:36075,COLOR_ATTACHMENT12:36076,COLOR_ATTACHMENT13:36077,COLOR_ATTACHMENT14:36078,COLOR_ATTACHMENT15:36079,FRAMEBUFFER_INCOMPLETE_MULTISAMPLE:36182,MAX_SAMPLES:36183,HALF_FLOAT:5131,RG:33319,RG_INTEGER:33320,R8:33321,RG8:33323,R16F:33325,R32F:33326,RG16F:33327,RG32F:33328,R8I:33329,R8UI:33330,R16I:33331,R16UI:33332,R32I:33333,R32UI:33334,RG8I:33335,RG8UI:33336,RG16I:33337,RG16UI:33338,RG32I:33339,RG32UI:33340,VERTEX_ARRAY_BINDING:34229,R8_SNORM:36756,RG8_SNORM:36757,RGB8_SNORM:36758,RGBA8_SNORM:36759,SIGNED_NORMALIZED:36764,COPY_READ_BUFFER:36662,COPY_WRITE_BUFFER:36663,COPY_READ_BUFFER_BINDING:36662,COPY_WRITE_BUFFER_BINDING:36663,UNIFORM_BUFFER:35345,UNIFORM_BUFFER_BINDING:35368,UNIFORM_BUFFER_START:35369,UNIFORM_BUFFER_SIZE:35370,MAX_VERTEX_UNIFORM_BLOCKS:35371,MAX_FRAGMENT_UNIFORM_BLOCKS:35373,MAX_COMBINED_UNIFORM_BLOCKS:35374,MAX_UNIFORM_BUFFER_BINDINGS:35375,MAX_UNIFORM_BLOCK_SIZE:35376,MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS:35377,MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS:35379,UNIFORM_BUFFER_OFFSET_ALIGNMENT:35380,ACTIVE_UNIFORM_BLOCKS:35382,UNIFORM_TYPE:35383,UNIFORM_SIZE:35384,UNIFORM_BLOCK_INDEX:35386,UNIFORM_OFFSET:35387,UNIFORM_ARRAY_STRIDE:35388,UNIFORM_MATRIX_STRIDE:35389,UNIFORM_IS_ROW_MAJOR:35390,UNIFORM_BLOCK_BINDING:35391,UNIFORM_BLOCK_DATA_SIZE:35392,UNIFORM_BLOCK_ACTIVE_UNIFORMS:35394,UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES:35395,UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER:35396,UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER:35398,INVALID_INDEX:4294967295,MAX_VERTEX_OUTPUT_COMPONENTS:37154,MAX_FRAGMENT_INPUT_COMPONENTS:37157,MAX_SERVER_WAIT_TIMEOUT:37137,OBJECT_TYPE:37138,SYNC_CONDITION:37139,SYNC_STATUS:37140,SYNC_FLAGS:37141,SYNC_FENCE:37142,SYNC_GPU_COMMANDS_COMPLETE:37143,UNSIGNALED:37144,SIGNALED:37145,ALREADY_SIGNALED:37146,TIMEOUT_EXPIRED:37147,CONDITION_SATISFIED:37148,WAIT_FAILED:37149,SYNC_FLUSH_COMMANDS_BIT:1,VERTEX_ATTRIB_ARRAY_DIVISOR:35070,ANY_SAMPLES_PASSED:35887,ANY_SAMPLES_PASSED_CONSERVATIVE:36202,SAMPLER_BINDING:35097,RGB10_A2UI:36975,INT_2_10_10_10_REV:36255,TRANSFORM_FEEDBACK:36386,TRANSFORM_FEEDBACK_PAUSED:36387,TRANSFORM_FEEDBACK_ACTIVE:36388,TRANSFORM_FEEDBACK_BINDING:36389,TEXTURE_IMMUTABLE_FORMAT:37167,MAX_ELEMENT_INDEX:36203,TEXTURE_IMMUTABLE_LEVELS:33503,TIMEOUT_IGNORED:-1,MAX_CLIENT_WAIT_TIMEOUT_WEBGL:37447,QUERY_COUNTER_BITS_EXT:34916,TIME_ELAPSED_EXT:35007,TIMESTAMP_EXT:36392,GPU_DISJOINT_EXT:36795,TEXTURE_MAX_ANISOTROPY_EXT:34046,MAX_TEXTURE_MAX_ANISOTROPY_EXT:34047,UNMASKED_VENDOR_WEBGL:37445,UNMASKED_RENDERER_WEBGL:37446,COMPLETION_STATUS_KHR:37297,COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT1_EXT:33777,COMPRESSED_RGBA_S3TC_DXT3_EXT:33778,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779,COMPRESSED_SRGB_S3TC_DXT1_EXT:35916,COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:35917,COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT:35918,COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:35919,COMPRESSED_R11_EAC:37488,COMPRESSED_SIGNED_R11_EAC:37489,COMPRESSED_RG11_EAC:37490,COMPRESSED_SIGNED_RG11_EAC:37491,COMPRESSED_RGB8_ETC2:37492,COMPRESSED_SRGB8_ETC2:37493,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:37494,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:37495,COMPRESSED_RGBA8_ETC2_EAC:37496,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:37497,COMPRESSED_RGB_PVRTC_4BPPV1_IMG:35840,COMPRESSED_RGB_PVRTC_2BPPV1_IMG:35841,COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:35842,COMPRESSED_RGBA_PVRTC_2BPPV1_IMG:35843,COMPRESSED_RGBA_ASTC_4x4_KHR:37808,COMPRESSED_RGBA_ASTC_5x4_KHR:37809,COMPRESSED_RGBA_ASTC_5x5_KHR:37810,COMPRESSED_RGBA_ASTC_6x5_KHR:37811,COMPRESSED_RGBA_ASTC_6x6_KHR:37812,COMPRESSED_RGBA_ASTC_8x5_KHR:37813,COMPRESSED_RGBA_ASTC_8x6_KHR:37814,COMPRESSED_RGBA_ASTC_8x8_KHR:37815,COMPRESSED_RGBA_ASTC_10x5_KHR:37816,COMPRESSED_RGBA_ASTC_10x6_KHR:37817,COMPRESSED_RGBA_ASTC_10x8_KHR:37818,COMPRESSED_RGBA_ASTC_10x10_KHR:37819,COMPRESSED_RGBA_ASTC_12x10_KHR:37820,COMPRESSED_RGBA_ASTC_12x12_KHR:37821,COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:37840,COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:37841,COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:37842,COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:37843,COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:37844,COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:37845,COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:37846,COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:37847,COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:37848,COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:37849,COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:37850,COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:37851,COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:37852,COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:37853},TYPE_SIZE={[GL.BYTE]:1,[GL.UNSIGNED_BYTE]:1,[GL.SHORT]:2,[GL.UNSIGNED_SHORT]:2,[GL.INT]:4,[GL.UNSIGNED_INT]:4,[GL.FLOAT]:4},TEXTURE_FORMATS={[GL.R8]:[GL.RED,GL.UNSIGNED_BYTE],[GL.R8_SNORM]:[GL.RED,GL.BYTE],[GL.R16F]:[GL.RED,GL.FLOAT],[GL.R32F]:[GL.RED,GL.FLOAT],[GL.R8UI]:[GL.RED_INTEGER,GL.UNSIGNED_BYTE],[GL.R8I]:[GL.RED_INTEGER,GL.BYTE],[GL.R16UI]:[GL.RED_INTEGER,GL.UNSIGNED_SHORT],[GL.R16I]:[GL.RED_INTEGER,GL.SHORT],[GL.R32UI]:[GL.RED_INTEGER,GL.UNSIGNED_INT],[GL.R32I]:[GL.RED_INTEGER,GL.INT],[GL.RG8]:[GL.RG,GL.UNSIGNED_BYTE],[GL.RG8_SNORM]:[GL.RG,GL.BYTE],[GL.RG16F]:[GL.RG,GL.FLOAT],[GL.RG32F]:[GL.RG,GL.FLOAT],[GL.RG8UI]:[GL.RG_INTEGER,GL.UNSIGNED_BYTE],[GL.RG8I]:[GL.RG_INTEGER,GL.BYTE],[GL.RG16UI]:[GL.RG_INTEGER,GL.UNSIGNED_SHORT],[GL.RG16I]:[GL.RG_INTEGER,GL.SHORT],[GL.RG32UI]:[GL.RG_INTEGER,GL.UNSIGNED_INT],[GL.RG32I]:[GL.RG_INTEGER,GL.INT],[GL.RGB8]:[GL.RGB,GL.UNSIGNED_BYTE],[GL.SRGB8]:[GL.RGB,GL.UNSIGNED_BYTE],[GL.RGB565]:[GL.RGB,GL.UNSIGNED_SHORT_5_6_5],[GL.RGB8_SNORM]:[GL.RGB,GL.BYTE],[GL.R11F_G11F_B10F]:[GL.RGB,GL.UNSIGNED_INT_10F_11F_11F_REV],[GL.RGB9_E5]:[GL.RGB,GL.UNSIGNED_INT_5_9_9_9_REV],[GL.RGB16F]:[GL.RGB,GL.FLOAT],[GL.RGB32F]:[GL.RGB,GL.FLOAT],[GL.RGB8UI]:[GL.RGB_INTEGER,GL.UNSIGNED_BYTE],[GL.RGB8I]:[GL.RGB_INTEGER,GL.BYTE],[GL.RGB16UI]:[GL.RGB_INTEGER,GL.UNSIGNED_SHORT],[GL.RGB16I]:[GL.RGB_INTEGER,GL.SHORT],[GL.RGB32UI]:[GL.RGB_INTEGER,GL.UNSIGNED_INT],[GL.RGB32I]:[GL.RGB_INTEGER,GL.INT],[GL.RGBA8]:[GL.RGBA,GL.UNSIGNED_BYTE],[GL.SRGB8_ALPHA8]:[GL.RGBA,GL.UNSIGNED_BYTE],[GL.RGBA8_SNORM]:[GL.RGBA,GL.BYTE],[GL.RGB5_A1]:[GL.RGBA,GL.UNSIGNED_SHORT_5_5_5_1],[GL.RGBA4]:[GL.RGBA,GL.UNSIGNED_SHORT_4_4_4_4],[GL.RGB10_A2]:[GL.RGBA,GL.UNSIGNED_INT_2_10_10_10_REV],[GL.RGBA16F]:[GL.RGBA,GL.FLOAT],[GL.RGBA32F]:[GL.RGBA,GL.FLOAT],[GL.RGBA8UI]:[GL.RGBA_INTEGER,GL.UNSIGNED_BYTE],[GL.RGBA8I]:[GL.RGBA_INTEGER,GL.BYTE],[GL.RGB10_A2UI]:[GL.RGBA_INTEGER,GL.UNSIGNED_INT_2_10_10_10_REV],[GL.RGBA16UI]:[GL.RGBA_INTEGER,GL.UNSIGNED_SHORT],[GL.RGBA16I]:[GL.RGBA_INTEGER,GL.SHORT],[GL.RGBA32I]:[GL.RGBA_INTEGER,GL.INT],[GL.RGBA32UI]:[GL.RGBA_INTEGER,GL.UNSIGNED_INT],[GL.DEPTH_COMPONENT16]:[GL.DEPTH_COMPONENT,GL.UNSIGNED_SHORT],[GL.DEPTH_COMPONENT24]:[GL.DEPTH_COMPONENT,GL.UNSIGNED_INT],[GL.DEPTH_COMPONENT32F]:[GL.DEPTH_COMPONENT,GL.FLOAT],[GL.DEPTH24_STENCIL8]:[GL.DEPTH_STENCIL,GL.UNSIGNED_INT_24_8],[GL.DEPTH32F_STENCIL8]:[GL.DEPTH_STENCIL,GL.FLOAT_32_UNSIGNED_INT_24_8_REV]},COMPRESSED_TEXTURE_TYPES={[GL.COMPRESSED_RGB_S3TC_DXT1_EXT]:!0,[GL.COMPRESSED_RGBA_S3TC_DXT1_EXT]:!0,[GL.COMPRESSED_RGBA_S3TC_DXT3_EXT]:!0,[GL.COMPRESSED_RGBA_S3TC_DXT5_EXT]:!0,[GL.COMPRESSED_SRGB_S3TC_DXT1_EXT]:!0,[GL.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT]:!0,[GL.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT]:!0,[GL.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT]:!0,[GL.COMPRESSED_R11_EAC]:!0,[GL.COMPRESSED_SIGNED_R11_EAC]:!0,[GL.COMPRESSED_RG11_EAC]:!0,[GL.COMPRESSED_SIGNED_RG11_EAC]:!0,[GL.COMPRESSED_RGB8_ETC2]:!0,[GL.COMPRESSED_SRGB8_ETC2]:!0,[GL.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2]:!0,[GL.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2]:!0,[GL.COMPRESSED_RGBA8_ETC2_EAC]:!0,[GL.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC]:!0,[GL.COMPRESSED_RGBA_ASTC_4x4_KHR]:!0,[GL.COMPRESSED_RGBA_ASTC_5x4_KHR]:!0,[GL.COMPRESSED_RGBA_ASTC_5x5_KHR]:!0,[GL.COMPRESSED_RGBA_ASTC_6x5_KHR]:!0,[GL.COMPRESSED_RGBA_ASTC_6x6_KHR]:!0,[GL.COMPRESSED_RGBA_ASTC_8x5_KHR]:!0,[GL.COMPRESSED_RGBA_ASTC_8x6_KHR]:!0,[GL.COMPRESSED_RGBA_ASTC_8x8_KHR]:!0,[GL.COMPRESSED_RGBA_ASTC_10x5_KHR]:!0,[GL.COMPRESSED_RGBA_ASTC_10x6_KHR]:!0,[GL.COMPRESSED_RGBA_ASTC_10x8_KHR]:!0,[GL.COMPRESSED_RGBA_ASTC_10x10_KHR]:!0,[GL.COMPRESSED_RGBA_ASTC_12x10_KHR]:!0,[GL.COMPRESSED_RGBA_ASTC_12x12_KHR]:!0,[GL.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR]:!0,[GL.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR]:!0,[GL.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR]:!0,[GL.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR]:!0,[GL.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR]:!0,[GL.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR]:!0,[GL.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR]:!0,[GL.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR]:!0,[GL.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR]:!0,[GL.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR]:!0,[GL.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR]:!0,[GL.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR]:!0,[GL.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR]:!0,[GL.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR]:!0,[GL.COMPRESSED_RGB_PVRTC_4BPPV1_IMG]:!0,[GL.COMPRESSED_RGB_PVRTC_2BPPV1_IMG]:!0,[GL.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG]:!0,[GL.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG]:!0},WEBGL_INFO={},DUMMY_UNIT_ARRAY=new Array(1),DUMMY_OBJECT={},TEXTURE_FORMAT_DEFAULTS={[GL.UNSIGNED_BYTE]:{[GL.RED]:GL.R8,[GL.RG]:GL.RG8,[GL.RGB]:GL.RGB8,[GL.RGBA]:GL.RGBA8},[GL.UNSIGNED_SHORT]:{[GL.DEPTH_COMPONENT]:GL.DEPTH_COMPONENT16},[GL.FLOAT]:{[GL.RED]:GL.R16F,[GL.RG]:GL.RG16F,[GL.RGB]:GL.RGB16F,[GL.RGBA]:GL.RGBA16F,[GL.DEPTH_COMPONENT]:GL.DEPTH_COMPONENT32F}};class Cubemap{constructor(t,e,r){if(this.gl=t,this.texture=null,this.appState=e,this.compressed=COMPRESSED_TEXTURE_TYPES[r.internalFormat],void 0!==r.format&&(console.warn("Cubemap option 'format' is deprecated and will be removed. Use 'internalFormat' with a sized format instead."),this.compressed=Boolean(COMPRESSED_TEXTURE_TYPES[r.format]),void 0===r.type&&(r.type=r.format===GL.DEPTH_COMPONENT?GL.UNSIGNED_SHORT:GL.UNSIGNED_BYTE),void 0===r.internalFormat&&(this.compressed?r.internalFormat=r.format:r.internalFormat=TEXTURE_FORMAT_DEFAULTS[r.type][r.format])),this.compressed)this.internalFormat=r.internalFormat,this.format=r.internalFormat,this.type=GL.UNSIGNED_BYTE;else{this.internalFormat=void 0!==r.internalFormat?r.internalFormat:GL.RGBA8;let t=TEXTURE_FORMATS[this.internalFormat];this.format=t[0],this.type=void 0!==r.type?r.type:t[1]}this.currentUnit=-1;let i=Array.isArray(r.negX),n=i?r.negX[0]:r.negX,{width:s=n.width,height:a=n.height,flipY:o=!1,premultiplyAlpha:h=!1,minFilter:c=(n?GL.LINEAR_MIPMAP_NEAREST:GL.NEAREST),magFilter:l=(n?GL.LINEAR:GL.NEAREST),wrapS:u=GL.REPEAT,wrapT:d=GL.REPEAT,compareMode:p=GL.NONE,compareFunc:_=GL.LEQUAL,minLOD:m=null,maxLOD:f=null,baseLevel:E=null,maxLevel:T=null,maxAnisotropy:g=1}=r;this.width=s,this.height=a,this.flipY=o,this.premultiplyAlpha=h,this.minFilter=c,this.magFilter=l,this.wrapS=u,this.wrapT=d,this.compareMode=p,this.compareFunc=_,this.minLOD=m,this.maxLOD=f,this.baseLevel=E,this.maxLevel=T,this.maxAnisotropy=Math.min(g,WEBGL_INFO.MAX_TEXTURE_ANISOTROPY),this.mipmaps=c===GL.LINEAR_MIPMAP_NEAREST||c===GL.LINEAR_MIPMAP_LINEAR,this.miplevelsProvided=i&&r.negX.length>1,this.levels=this.mipmaps?Math.floor(Math.log2(Math.min(this.width,this.height)))+1:1,this.restore(r)}restore(t=DUMMY_OBJECT){this.texture=this.gl.createTexture(),-1!==this.currentUnit&&(this.appState.textures[this.currentUnit]=null),this.bind(0),this.gl.pixelStorei(GL.UNPACK_FLIP_Y_WEBGL,this.flipY),this.gl.pixelStorei(GL.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),this.gl.texParameteri(GL.TEXTURE_CUBE_MAP,GL.TEXTURE_MAG_FILTER,this.magFilter),this.gl.texParameteri(GL.TEXTURE_CUBE_MAP,GL.TEXTURE_MIN_FILTER,this.minFilter),this.gl.texParameteri(GL.TEXTURE_CUBE_MAP,GL.TEXTURE_WRAP_S,this.wrapS),this.gl.texParameteri(GL.TEXTURE_CUBE_MAP,GL.TEXTURE_WRAP_T,this.wrapT),this.gl.texParameteri(GL.TEXTURE_CUBE_MAP,GL.TEXTURE_COMPARE_FUNC,this.compareFunc),this.gl.texParameteri(GL.TEXTURE_CUBE_MAP,GL.TEXTURE_COMPARE_MODE,this.compareMode),null!==this.baseLevel&&this.gl.texParameteri(GL.TEXTURE_CUBE_MAP,GL.TEXTURE_BASE_LEVEL,this.baseLevel),null!==this.maxLevel&&this.gl.texParameteri(GL.TEXTURE_CUBE_MAP,GL.TEXTURE_MAX_LEVEL,this.maxLevel),null!==this.minLOD&&this.gl.texParameteri(GL.TEXTURE_CUBE_MAP,GL.TEXTURE_MIN_LOD,this.minLOD),null!==this.maxLOD&&this.gl.texParameteri(GL.TEXTURE_CUBE_MAP,GL.TEXTURE_MAX_LOD,this.maxLOD),this.maxAnisotropy>1&&this.gl.texParameteri(GL.TEXTURE_CUBE_MAP,GL.TEXTURE_MAX_ANISOTROPY_EXT,this.maxAnisotropy),this.gl.texStorage2D(GL.TEXTURE_CUBE_MAP,this.levels,this.internalFormat,this.width,this.height);let{negX:e,posX:r,negY:i,posY:n,negZ:s,posZ:a}=t;return e&&(this.faceData(GL.TEXTURE_CUBE_MAP_NEGATIVE_X,e),this.faceData(GL.TEXTURE_CUBE_MAP_POSITIVE_X,r),this.faceData(GL.TEXTURE_CUBE_MAP_NEGATIVE_Y,i),this.faceData(GL.TEXTURE_CUBE_MAP_POSITIVE_Y,n),this.faceData(GL.TEXTURE_CUBE_MAP_NEGATIVE_Z,s),this.faceData(GL.TEXTURE_CUBE_MAP_POSITIVE_Z,a)),this.mipmaps&&!this.miplevelsProvided&&this.gl.generateMipmap(GL.TEXTURE_CUBE_MAP),this}delete(){return this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null,this.appState.textures[this.currentUnit]=null,this.currentUnit=-1),this}faceData(t,e){Array.isArray(e)||(DUMMY_UNIT_ARRAY[0]=e,e=DUMMY_UNIT_ARRAY);let r,i=this.mipmaps?e.length:1,n=this.width,s=this.height;if(this.compressed)for(r=0;r<i;++r)this.gl.compressedTexSubImage2D(t,r,0,0,n,s,this.format,e[r]),n=Math.max(n>>1,1),s=Math.max(s>>1,1);else for(r=0;r<i;++r)this.gl.texSubImage2D(t,r,0,0,n,s,this.format,this.type,e[r]),n=Math.max(n>>1,1),s=Math.max(s>>1,1);return this}bind(t){let e=this.appState.textures[t];return e!==this&&(e&&(e.currentUnit=-1),-1!==this.currentUnit&&(this.appState.textures[this.currentUnit]=null),this.gl.activeTexture(GL.TEXTURE0+t),this.gl.bindTexture(GL.TEXTURE_CUBE_MAP,this.texture),this.appState.textures[t]=this,this.currentUnit=t),this}}class DrawCall{constructor(t,e,r,i=null,n){this.gl=t,this.currentProgram=r,this.drawPrimitive=GL.TRIANGLES,this.currentVertexArray=i,this.currentTransformFeedback=null,this.appState=e,this.uniformIndices={},this.uniformNames=new Array(WEBGL_INFO.MAX_UNIFORMS),this.uniformValues=new Array(WEBGL_INFO.MAX_UNIFORMS),this.uniformCount=0,this.uniformBuffers=new Array(WEBGL_INFO.MAX_UNIFORM_BUFFERS),this.uniformBlockNames=new Array(WEBGL_INFO.MAX_UNIFORM_BUFFERS),this.uniformBlockCount=0,this.textures=new Array(WEBGL_INFO.MAX_TEXTURE_UNITS),this.textureCount=0,this.offsets=new Int32Array(1),this.numElements=new Int32Array(1),this.numInstances=new Int32Array(1),this.currentVertexArray&&(this.numElements[0]=this.currentVertexArray.numElements,this.numInstances[0]=this.currentVertexArray.numInstances),this.numDraws=1,void 0!==n&&(console.warn("Primitive argument to 'App.createDrawCall' is deprecated and will be removed. Use 'DrawCall.primitive' instead."),this.primitive(n))}primitive(t){return this.drawPrimitive=t,this}transformFeedback(t){return this.currentTransformFeedback=t,this}uniform(t,e){let r=this.uniformIndices[t];return void 0===r&&(r=this.uniformCount++,this.uniformIndices[t]=r,this.uniformNames[r]=t),this.uniformValues[r]=e,this}texture(t,e){let r=this.currentProgram.samplers[t];return this.textures[r]=e,this}uniformBlock(t,e){let r=this.currentProgram.uniformBlocks[t];return this.uniformBuffers[r]=e,this}drawRanges(...t){this.numDraws=t.length,this.offsets.length<this.numDraws&&(this.offsets=new Int32Array(this.numDraws)),this.numElements.length<this.numDraws&&(this.numElements=new Int32Array(this.numDraws)),this.numInstances.length<this.numDraws&&(this.numInstances=new Int32Array(this.numDraws));for(let e=0;e<this.numDraws;++e){let r=t[e];this.offsets[e]=r[0],this.numElements[e]=r[1],this.numInstances[e]=r[2]||1}return this}draw(){let t=this.uniformNames,e=this.uniformValues,r=this.uniformBuffers,i=this.currentProgram.uniformBlockCount,n=this.textures,s=this.currentProgram.samplerCount,a=!1;this.currentProgram.bind(),this.currentVertexArray&&(this.currentVertexArray.bind(),a=this.currentVertexArray.indexed);for(let r=0;r<this.uniformCount;++r)this.currentProgram.uniform(t[r],e[r]);for(let t=0;t<i;++t)r[t].bind(t);for(let t=0;t<s;++t)n[t].bind(t);if(this.currentTransformFeedback?(this.currentTransformFeedback.bind(),this.gl.beginTransformFeedback(this.drawPrimitive)):this.appState.transformFeedback&&(this.gl.bindTransformFeedback(GL.TRANSFORM_FEEDBACK,null),this.appState.transformFeedback=null),WEBGL_INFO.MULTI_DRAW_INSTANCED){let t=this.appState.extensions.multiDrawInstanced;a?t.multiDrawElementsInstancedWEBGL(this.drawPrimitive,this.numElements,0,this.currentVertexArray.indexType,this.offsets,0,this.numInstances,0,this.numDraws):t.multiDrawArraysInstancedWEBGL(this.drawPrimitive,this.offsets,0,this.numElements,0,this.numInstances,0,this.numDraws)}else if(a)for(let t=0;t<this.numDraws;++t)this.gl.drawElementsInstanced(this.drawPrimitive,this.numElements[t],this.currentVertexArray.indexType,this.offsets[t],this.numInstances[t]);else for(let t=0;t<this.numDraws;++t)this.gl.drawArraysInstanced(this.drawPrimitive,this.offsets[t],this.numElements[t],this.numInstances[t]);return this.currentTransformFeedback&&this.gl.endTransformFeedback(),this}}let Texture$1=class{constructor(t,e,r,i,n=i.width,s=i.height,a,o,h=DUMMY_OBJECT){if(this.gl=t,this.binding=r,this.texture=null,this.width=n||0,this.height=s||0,this.depth=a||0,this.is3D=o,this.appState=e,this.compressed=Boolean(COMPRESSED_TEXTURE_TYPES[h.internalFormat]),void 0!==h.format&&(console.warn("Texture option 'format' is deprecated and will be removed. Use 'internalFormat' with a sized format instead."),this.compressed=Boolean(COMPRESSED_TEXTURE_TYPES[h.format]),void 0===h.type&&(h.type=h.format===GL.DEPTH_COMPONENT?GL.UNSIGNED_SHORT:GL.UNSIGNED_BYTE),void 0===h.internalFormat&&(this.compressed?h.internalFormat=h.format:h.internalFormat=TEXTURE_FORMAT_DEFAULTS[h.type][h.format])),this.compressed)this.internalFormat=h.internalFormat,this.format=this.internalFormat,this.type=GL.UNSIGNED_BYTE;else{this.internalFormat=void 0!==h.internalFormat?h.internalFormat:GL.RGBA8;let t=TEXTURE_FORMATS[this.internalFormat];this.format=t[0],this.type=void 0!==h.type?h.type:t[1]}this.currentUnit=-1;let{minFilter:c=(i?GL.LINEAR_MIPMAP_NEAREST:GL.NEAREST),magFilter:l=(i?GL.LINEAR:GL.NEAREST),wrapS:u=GL.REPEAT,wrapT:d=GL.REPEAT,wrapR:p=GL.REPEAT,compareMode:_=GL.NONE,compareFunc:m=GL.LEQUAL,minLOD:f=null,maxLOD:E=null,baseLevel:T=null,maxLevel:g=null,maxAnisotropy:y=1,flipY:R=!1,premultiplyAlpha:x=!1}=h;this.minFilter=c,this.magFilter=l,this.wrapS=u,this.wrapT=d,this.wrapR=p,this.compareMode=_,this.compareFunc=m,this.minLOD=f,this.maxLOD=E,this.baseLevel=T,this.maxLevel=g,this.maxAnisotropy=Math.min(y,WEBGL_INFO.MAX_TEXTURE_ANISOTROPY),this.flipY=R,this.premultiplyAlpha=x,this.mipmaps=c===GL.LINEAR_MIPMAP_NEAREST||c===GL.LINEAR_MIPMAP_LINEAR,this.restore(i)}restore(t){return this.texture=null,this.resize(this.width,this.height,this.depth),t&&this.data(t),this}resize(t,e,r){if(r=r||0,this.texture&&t===this.width&&e===this.height&&r===this.depth)return this;let i;return this.gl.deleteTexture(this.texture),-1!==this.currentUnit&&(this.appState.textures[this.currentUnit]=null),this.texture=this.gl.createTexture(),this.bind(Math.max(this.currentUnit,0)),this.width=t,this.height=e,this.depth=r,this.gl.texParameteri(this.binding,GL.TEXTURE_MIN_FILTER,this.minFilter),this.gl.texParameteri(this.binding,GL.TEXTURE_MAG_FILTER,this.magFilter),this.gl.texParameteri(this.binding,GL.TEXTURE_WRAP_S,this.wrapS),this.gl.texParameteri(this.binding,GL.TEXTURE_WRAP_T,this.wrapT),this.gl.texParameteri(this.binding,GL.TEXTURE_WRAP_R,this.wrapR),this.gl.texParameteri(this.binding,GL.TEXTURE_COMPARE_FUNC,this.compareFunc),this.gl.texParameteri(this.binding,GL.TEXTURE_COMPARE_MODE,this.compareMode),null!==this.minLOD&&this.gl.texParameterf(this.binding,GL.TEXTURE_MIN_LOD,this.minLOD),null!==this.maxLOD&&this.gl.texParameterf(this.binding,GL.TEXTURE_MAX_LOD,this.maxLOD),null!==this.baseLevel&&this.gl.texParameteri(this.binding,GL.TEXTURE_BASE_LEVEL,this.baseLevel),null!==this.maxLevel&&this.gl.texParameteri(this.binding,GL.TEXTURE_MAX_LEVEL,this.maxLevel),this.maxAnisotropy>1&&this.gl.texParameteri(this.binding,GL.TEXTURE_MAX_ANISOTROPY_EXT,this.maxAnisotropy),this.is3D?(i=this.mipmaps?Math.floor(Math.log2(Math.max(Math.max(this.width,this.height),this.depth)))+1:1,this.gl.texStorage3D(this.binding,i,this.internalFormat,this.width,this.height,this.depth)):(i=this.mipmaps?Math.floor(Math.log2(Math.max(this.width,this.height)))+1:1,this.gl.texStorage2D(this.binding,i,this.internalFormat,this.width,this.height)),this}data(t){Array.isArray(t)||(DUMMY_UNIT_ARRAY[0]=t,t=DUMMY_UNIT_ARRAY);let e,r=this.mipmaps?t.length:1,i=this.width,n=this.height,s=this.depth,a=this.mipmaps&&1===t.length;if(this.bind(Math.max(this.currentUnit,0)),this.gl.pixelStorei(GL.UNPACK_FLIP_Y_WEBGL,this.flipY),this.gl.pixelStorei(GL.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),this.compressed)if(this.is3D)for(e=0;e<r;++e)this.gl.compressedTexSubImage3D(this.binding,e,0,0,0,i,n,s,this.format,t[e]),i=Math.max(i>>1,1),n=Math.max(n>>1,1),s=Math.max(s>>1,1);else for(e=0;e<r;++e)this.gl.compressedTexSubImage2D(this.binding,e,0,0,i,n,this.format,t[e]),i=Math.max(i>>1,1),n=Math.max(n>>1,1);else if(this.is3D)for(e=0;e<r;++e)this.gl.texSubImage3D(this.binding,e,0,0,0,i,n,s,this.format,this.type,t[e]),i=Math.max(i>>1,1),n=Math.max(n>>1,1),s=Math.max(s>>1,1);else for(e=0;e<r;++e)this.gl.texSubImage2D(this.binding,e,0,0,i,n,this.format,this.type,t[e]),i=Math.max(i>>1,1),n=Math.max(n>>1,1);return a&&this.gl.generateMipmap(this.binding),this}delete(){return this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null,-1!==this.currentUnit&&this.appState.textures[this.currentUnit]===this&&(this.appState.textures[this.currentUnit]=null,this.currentUnit=-1)),this}bind(t){let e=this.appState.textures[t];return this.appState.activeTexture!==t&&(this.gl.activeTexture(GL.TEXTURE0+t),this.appState.activeTexture=t),e!==this&&(e&&(e.currentUnit=-1),-1!==this.currentUnit&&(this.appState.textures[this.currentUnit]=null),this.gl.bindTexture(this.binding,this.texture),this.appState.textures[t]=this,this.currentUnit=t),this}};class Renderbuffer{constructor(t,e,r,i,n=0){this.gl=t,this.renderbuffer=null,this.width=e,this.height=r,this.internalFormat=i,this.samples=n,this.restore()}restore(){return this.renderbuffer=this.gl.createRenderbuffer(),this.resize(this.width,this.height),this}resize(t,e){return this.width=t,this.height=e,this.gl.bindRenderbuffer(GL.RENDERBUFFER,this.renderbuffer),this.gl.renderbufferStorageMultisample(GL.RENDERBUFFER,this.samples,this.internalFormat,this.width,this.height),this.gl.bindRenderbuffer(GL.RENDERBUFFER,null),this}delete(){return this.gl.deleteRenderbuffer(this.renderbuffer),this.renderbuffer=null,this}}class Framebuffer{constructor(t,e){this.gl=t,this.framebuffer=null,this.appState=e,this.numColorTargets=0,this.colorAttachments=[],this.colorAttachmentEnums=[],this.colorAttachmentTargets=[],this.depthAttachment=null,this.depthAttachmentTarget=null,this.width=0,this.height=0,this.restore()}restore(){return this.appState.drawFramebuffer===this&&(this.appState.drawFramebuffer=null),this.appState.readFramebuffer===this&&(this.appState.readFramebuffer=null),this.framebuffer=this.gl.createFramebuffer(),this}colorTarget(t,e,r=(e.is3D?0:GL.TEXTURE_2D)){if(t>=this.numColorTargets){let e=t+1;this.colorAttachmentEnums.length=e,this.colorAttachments.length=e,this.colorAttachmentTargets.length=e;for(let t=this.numColorTargets;t<e-1;++t)this.colorAttachmentEnums[t]=GL.NONE,this.colorAttachments[t]=null,this.colorAttachmentTargets[t]=0;this.numColorTargets=e}this.colorAttachmentEnums[t]=GL.COLOR_ATTACHMENT0+t,this.colorAttachments[t]=e,this.colorAttachmentTargets[t]=r;let i=this.bindAndCaptureState();return e instanceof Renderbuffer?this.gl.framebufferRenderbuffer(GL.DRAW_FRAMEBUFFER,this.colorAttachmentEnums[t],GL.RENDERBUFFER,e.renderbuffer):e.is3D?this.gl.framebufferTextureLayer(GL.DRAW_FRAMEBUFFER,this.colorAttachmentEnums[t],e.texture,0,r):this.gl.framebufferTexture2D(GL.DRAW_FRAMEBUFFER,this.colorAttachmentEnums[t],r,e.texture,0),this.gl.drawBuffers(this.colorAttachmentEnums),this.width=e.width,this.height=e.height,this.restoreState(i),this}depthTarget(t,e=(t.is3D?0:GL.TEXTURE_2D)){let r=this.bindAndCaptureState();return this.depthAttachment=t,this.depthAttachmentTarget=e,t instanceof Renderbuffer?this.gl.framebufferRenderbuffer(GL.DRAW_FRAMEBUFFER,GL.DEPTH_ATTACHMENT,GL.RENDERBUFFER,t.renderbuffer):t.is3D?this.gl.framebufferTextureLayer(GL.DRAW_FRAMEBUFFER,GL.DEPTH_ATTACHMENT,t.texture,0,e):this.gl.framebufferTexture2D(GL.DRAW_FRAMEBUFFER,GL.DEPTH_ATTACHMENT,e,t.texture,0),this.width=t.width,this.height=t.height,this.restoreState(r),this}resize(t=this.gl.drawingBufferWidth,e=this.gl.drawingBufferHeight){let r=this.bindAndCaptureState();for(let r=0;r<this.numColorTargets;++r){let i=this.colorAttachments[r];i&&(i.resize(t,e),i instanceof Texture$1&&(i.is3D?this.gl.framebufferTextureLayer(GL.DRAW_FRAMEBUFFER,this.colorAttachmentEnums[r],i.texture,0,this.colorAttachmentTargets[r]):this.gl.framebufferTexture2D(GL.DRAW_FRAMEBUFFER,this.colorAttachmentEnums[r],this.colorAttachmentTargets[r],i.texture,0)))}return this.depthAttachment&&(this.depthAttachment.resize(t,e),this.depthAttachment instanceof Texture$1&&(this.depthAttachment.is3D?this.gl.framebufferTextureLayer(GL.DRAW_FRAMEBUFFER,GL.DEPTH_ATTACHMENT,this.depthAttachment.texture,0,this.depthAttachmentTarget):this.gl.framebufferTexture2D(GL.DRAW_FRAMEBUFFER,GL.DEPTH_ATTACHMENT,this.depthAttachmentTarget,this.depthAttachment.texture,0))),this.width=t,this.height=e,this.restoreState(r),this}delete(){return this.framebuffer&&(this.gl.deleteFramebuffer(this.framebuffer),this.framebuffer=null,this.appState.drawFramebuffer===this&&(this.gl.bindFramebuffer(GL.DRAW_FRAMEBUFFER,null),this.appState.drawFramebuffer=null),this.appState.readFramebuffer===this&&(this.gl.bindFramebuffer(GL.READ_FRAMEBUFFER,null),this.appState.readFramebuffer=null)),this}getStatus(){let t=this.bindAndCaptureState(),e=this.gl.checkFramebufferStatus(GL.DRAW_FRAMEBUFFER);return this.restoreState(t),e}bindForDraw(){return this.appState.drawFramebuffer!==this&&(this.gl.bindFramebuffer(GL.DRAW_FRAMEBUFFER,this.framebuffer),this.appState.drawFramebuffer=this),this}bindForRead(){return this.appState.readFramebuffer!==this&&(this.gl.bindFramebuffer(this.gl.READ_FRAMEBUFFER,this.framebuffer),this.appState.readFramebuffer=this),this}bindAndCaptureState(){let t=this.appState.drawFramebuffer;return t!==this&&this.gl.bindFramebuffer(GL.DRAW_FRAMEBUFFER,this.framebuffer),t}restoreState(t){return t!==this&&this.gl.bindFramebuffer(GL.DRAW_FRAMEBUFFER,t?t.framebuffer:null),this}get colorTextures(){return console.error("Framebuffer.colorTextures is deprecated and will be removed. Please use Framebuffer.colorAttachments."),this.colorAttachments}get depthTexture(){return console.error("Framebuffer.depthTexture is deprecated and will be removed. Please use Framebuffer.depthAttachment."),this.depthAttachment}}class Shader{constructor(t,e,r,i){this.gl=t,this.appState=e,this.shader=null,this.type=r,this.source=i.trim(),this.restore()}restore(){return this.shader=this.gl.createShader(this.type),this.gl.shaderSource(this.shader,this.source),this.gl.compileShader(this.shader),this}translatedSource(){return WEBGL_INFO.DEBUG_SHADERS?this.appState.extensions.debugShaders.getTranslatedShaderSource(this.shader):"(Unavailable)"}delete(){return this.shader&&(this.gl.deleteShader(this.shader),this.shader=null),this}checkCompilation(){return(()=>{if(35632==this.type)return!0;let t="//// code",e=t=>t.split(":").slice(3).join(":");if(this.source.includes(t)){let r=(e=>{let r=0,i=e.split("");for(let n=0;n<i.length;n++)if("\n"==i[n]&&r++,e.substr(n,9)===t)return r;return-1})(this.source);return this.gl.getShaderInfoLog(this.shader).split("\n").slice(0,-1).forEach((i=>{let n=(t=>parseInt(t.split(":")[2]))(i);n<r&&console.error("error before "+t);let s=t=>"    "+this.source.split("\n")[n-1+t];console.error(["line:"+(n-r),"    "+s(-2),"    "+s(-1),">>>>"+s(0),"    "+s(1),"    "+s(2),e(i)].join("\n"))})),!0}})(),this}}const UNIFORM_FUNC_NAME={};UNIFORM_FUNC_NAME[GL.BOOL]="uniform1i",UNIFORM_FUNC_NAME[GL.INT]="uniform1i",UNIFORM_FUNC_NAME[GL.SAMPLER_2D]="uniform1i",UNIFORM_FUNC_NAME[GL.INT_SAMPLER_2D]="uniform1i",UNIFORM_FUNC_NAME[GL.UNSIGNED_INT_SAMPLER_2D]="uniform1i",UNIFORM_FUNC_NAME[GL.SAMPLER_2D_SHADOW]="uniform1i",UNIFORM_FUNC_NAME[GL.SAMPLER_2D_ARRAY]="uniform1i",UNIFORM_FUNC_NAME[GL.INT_SAMPLER_2D_ARRAY]="uniform1i",UNIFORM_FUNC_NAME[GL.UNSIGNED_INT_SAMPLER_2D_ARRAY]="uniform1i",UNIFORM_FUNC_NAME[GL.SAMPLER_2D_ARRAY_SHADOW]="uniform1i",UNIFORM_FUNC_NAME[GL.SAMPLER_CUBE]="uniform1i",UNIFORM_FUNC_NAME[GL.INT_SAMPLER_CUBE]="uniform1i",UNIFORM_FUNC_NAME[GL.UNSIGNED_INT_SAMPLER_CUBE]="uniform1i",UNIFORM_FUNC_NAME[GL.SAMPLER_CUBE_SHADOW]="uniform1i",UNIFORM_FUNC_NAME[GL.SAMPLER_3D]="uniform1i",UNIFORM_FUNC_NAME[GL.INT_SAMPLER_3D]="uniform1i",UNIFORM_FUNC_NAME[GL.UNSIGNED_INT_SAMPLER_3D]="uniform1i",UNIFORM_FUNC_NAME[GL.UNSIGNED_INT]="uniform1ui",UNIFORM_FUNC_NAME[GL.FLOAT]="uniform1f",UNIFORM_FUNC_NAME[GL.FLOAT_VEC2]="uniform2f",UNIFORM_FUNC_NAME[GL.FLOAT_VEC3]="uniform3f",UNIFORM_FUNC_NAME[GL.FLOAT_VEC4]="uniform4f",UNIFORM_FUNC_NAME[GL.INT_VEC2]="uniform2i",UNIFORM_FUNC_NAME[GL.INT_VEC3]="uniform3i",UNIFORM_FUNC_NAME[GL.INT_VEC4]="uniform4i",UNIFORM_FUNC_NAME[GL.UNSIGNED_INT_VEC2]="uniform2ui",UNIFORM_FUNC_NAME[GL.UNSIGNED_INT_VEC3]="uniform3ui",UNIFORM_FUNC_NAME[GL.UNSIGNED_INT_VEC4]="uniform4ui",UNIFORM_FUNC_NAME[GL.BOOL_VEC2]="uniform2i",UNIFORM_FUNC_NAME[GL.BOOL_VEC3]="uniform3i",UNIFORM_FUNC_NAME[GL.BOOL_VEC4]="uniform4i",UNIFORM_FUNC_NAME[GL.FLOAT_MAT2]="uniformMatrix2fv",UNIFORM_FUNC_NAME[GL.FLOAT_MAT3]="uniformMatrix3fv",UNIFORM_FUNC_NAME[GL.FLOAT_MAT4]="uniformMatrix4fv",UNIFORM_FUNC_NAME[GL.FLOAT_MAT2x3]="uniformMatrix2x3fv",UNIFORM_FUNC_NAME[GL.FLOAT_MAT2x4]="uniformMatrix2x4fv",UNIFORM_FUNC_NAME[GL.FLOAT_MAT3x2]="uniformMatrix3x2fv",UNIFORM_FUNC_NAME[GL.FLOAT_MAT3x4]="uniformMatrix3x4fv",UNIFORM_FUNC_NAME[GL.FLOAT_MAT4x2]="uniformMatrix4x2fv",UNIFORM_FUNC_NAME[GL.FLOAT_MAT4x3]="uniformMatrix4x3fv";const UNIFORM_COMPONENT_COUNT={};UNIFORM_COMPONENT_COUNT[GL.BOOL]=1,UNIFORM_COMPONENT_COUNT[GL.INT]=1,UNIFORM_COMPONENT_COUNT[GL.SAMPLER_2D]=1,UNIFORM_COMPONENT_COUNT[GL.INT_SAMPLER_2D]=1,UNIFORM_COMPONENT_COUNT[GL.UNSIGNED_INT_SAMPLER_2D]=1,UNIFORM_COMPONENT_COUNT[GL.SAMPLER_2D_SHADOW]=1,UNIFORM_COMPONENT_COUNT[GL.SAMPLER_2D_ARRAY]=1,UNIFORM_COMPONENT_COUNT[GL.INT_SAMPLER_2D_ARRAY]=1,UNIFORM_COMPONENT_COUNT[GL.UNSIGNED_INT_SAMPLER_2D_ARRAY]=1,UNIFORM_COMPONENT_COUNT[GL.SAMPLER_2D_ARRAY_SHADOW]=1,UNIFORM_COMPONENT_COUNT[GL.SAMPLER_CUBE]=1,UNIFORM_COMPONENT_COUNT[GL.INT_SAMPLER_CUBE]=1,UNIFORM_COMPONENT_COUNT[GL.UNSIGNED_INT_SAMPLER_CUBE]=1,UNIFORM_COMPONENT_COUNT[GL.SAMPLER_CUBE_SHADOW]=1,UNIFORM_COMPONENT_COUNT[GL.SAMPLER_3D]=1,UNIFORM_COMPONENT_COUNT[GL.INT_SAMPLER_3D]=1,UNIFORM_COMPONENT_COUNT[GL.UNSIGNED_INT_SAMPLER_3D]=1,UNIFORM_COMPONENT_COUNT[GL.UNSIGNED_INT]=1,UNIFORM_COMPONENT_COUNT[GL.FLOAT]=1,UNIFORM_COMPONENT_COUNT[GL.FLOAT_VEC2]=2,UNIFORM_COMPONENT_COUNT[GL.FLOAT_VEC3]=3,UNIFORM_COMPONENT_COUNT[GL.FLOAT_VEC4]=4,UNIFORM_COMPONENT_COUNT[GL.INT_VEC2]=2,UNIFORM_COMPONENT_COUNT[GL.INT_VEC3]=3,UNIFORM_COMPONENT_COUNT[GL.INT_VEC4]=4,UNIFORM_COMPONENT_COUNT[GL.UNSIGNED_INT_VEC2]=2,UNIFORM_COMPONENT_COUNT[GL.UNSIGNED_INT_VEC3]=3,UNIFORM_COMPONENT_COUNT[GL.UNSIGNED_INT_VEC4]=4,UNIFORM_COMPONENT_COUNT[GL.BOOL_VEC2]=2,UNIFORM_COMPONENT_COUNT[GL.BOOL_VEC3]=3,UNIFORM_COMPONENT_COUNT[GL.BOOL_VEC4]=4,UNIFORM_COMPONENT_COUNT[GL.FLOAT_MAT2]=4,UNIFORM_COMPONENT_COUNT[GL.FLOAT_MAT3]=9,UNIFORM_COMPONENT_COUNT[GL.FLOAT_MAT4]=16,UNIFORM_COMPONENT_COUNT[GL.FLOAT_MAT2x3]=6,UNIFORM_COMPONENT_COUNT[GL.FLOAT_MAT2x4]=8,UNIFORM_COMPONENT_COUNT[GL.FLOAT_MAT3x2]=6,UNIFORM_COMPONENT_COUNT[GL.FLOAT_MAT3x4]=12,UNIFORM_COMPONENT_COUNT[GL.FLOAT_MAT4x2]=8,UNIFORM_COMPONENT_COUNT[GL.FLOAT_MAT4x3]=12;const UNIFORM_CACHE_CLASS={};UNIFORM_CACHE_CLASS[GL.INT]=Int32Array,UNIFORM_CACHE_CLASS[GL.SAMPLER_2D]=Int32Array,UNIFORM_CACHE_CLASS[GL.INT_SAMPLER_2D]=Int32Array,UNIFORM_CACHE_CLASS[GL.UNSIGNED_INT_SAMPLER_2D]=Int32Array,UNIFORM_CACHE_CLASS[GL.SAMPLER_2D_SHADOW]=Int32Array,UNIFORM_CACHE_CLASS[GL.SAMPLER_2D_ARRAY]=Int32Array,UNIFORM_CACHE_CLASS[GL.INT_SAMPLER_2D_ARRAY]=Int32Array,UNIFORM_CACHE_CLASS[GL.UNSIGNED_INT_SAMPLER_2D_ARRAY]=Int32Array,UNIFORM_CACHE_CLASS[GL.SAMPLER_2D_ARRAY_SHADOW]=Int32Array,UNIFORM_CACHE_CLASS[GL.SAMPLER_CUBE]=Int32Array,UNIFORM_CACHE_CLASS[GL.INT_SAMPLER_CUBE]=Int32Array,UNIFORM_CACHE_CLASS[GL.UNSIGNED_INT_SAMPLER_CUBE]=Int32Array,UNIFORM_CACHE_CLASS[GL.SAMPLER_CUBE_SHADOW]=Int32Array,UNIFORM_CACHE_CLASS[GL.SAMPLER_3D]=Int32Array,UNIFORM_CACHE_CLASS[GL.INT_SAMPLER_3D]=Int32Array,UNIFORM_CACHE_CLASS[GL.UNSIGNED_INT_SAMPLER_3D]=Int32Array,UNIFORM_CACHE_CLASS[GL.UNSIGNED_INT]=Uint32Array,UNIFORM_CACHE_CLASS[GL.FLOAT]=Float32Array,UNIFORM_CACHE_CLASS[GL.FLOAT_VEC2]=Float32Array,UNIFORM_CACHE_CLASS[GL.FLOAT_VEC3]=Float32Array,UNIFORM_CACHE_CLASS[GL.FLOAT_VEC4]=Float32Array,UNIFORM_CACHE_CLASS[GL.INT_VEC2]=Int32Array,UNIFORM_CACHE_CLASS[GL.INT_VEC3]=Int32Array,UNIFORM_CACHE_CLASS[GL.INT_VEC4]=Int32Array,UNIFORM_CACHE_CLASS[GL.UNSIGNED_INT_VEC2]=Uint32Array,UNIFORM_CACHE_CLASS[GL.UNSIGNED_INT_VEC3]=Uint32Array,UNIFORM_CACHE_CLASS[GL.UNSIGNED_INT_VEC4]=Uint32Array;class SingleComponentUniform{constructor(t,e,r){this.gl=t,this.handle=e,this.glFuncName=UNIFORM_FUNC_NAME[r],this.cache=r!==GL.BOOL&&0}set(t){this.cache!==t&&(this.gl[this.glFuncName](this.handle,t),this.cache=t)}}class MultiNumericUniform{constructor(t,e,r,i){this.gl=t,this.handle=e,this.glFuncName=UNIFORM_FUNC_NAME[r]+"v",this.count=i,this.cache=new UNIFORM_CACHE_CLASS[r](UNIFORM_COMPONENT_COUNT[r]*i)}set(t){for(let e=0,r=t.length;e<r;++e)if(this.cache[e]!==t[e])return this.gl[this.glFuncName](this.handle,t),void this.cache.set(t)}}class MultiBoolUniform{constructor(t,e,r,i){this.gl=t,this.handle=e,this.glFuncName=UNIFORM_FUNC_NAME[r]+"v",this.count=i,this.cache=new Array(UNIFORM_COMPONENT_COUNT[r]*i).fill(!1)}set(t){for(let e=0,r=t.length;e<r;++e)if(this.cache[e]!==t[e]){this.gl[this.glFuncName](this.handle,t);for(let i=e;i<r;i++)this.cache[i]=t[i];return}}}class MatrixUniform{constructor(t,e,r,i){this.gl=t,this.handle=e,this.glFuncName=UNIFORM_FUNC_NAME[r],this.count=i,this.cache=new Float32Array(UNIFORM_COMPONENT_COUNT[r]*i)}set(t){for(let e=0,r=t.length;e<r;++e)if(this.cache[e]!==t[e])return this.gl[this.glFuncName](this.handle,!1,t),void this.cache.set(t)}}class Program{constructor(t,e,r,i,n){this.gl=t,this.appState=e,this.program=null,this.transformFeedbackVaryings=n||null,this.uniforms={},this.uniformBlocks={},this.uniformBlockCount=0,this.samplers={},this.samplerCount=0,this.vertexSource=null,this.vertexShader=null,this.fragmentSource=null,this.fragmentShader=null,this.linked=!1,"string"==typeof r?this.vertexSource=r:this.vertexShader=r,"string"==typeof i?this.fragmentSource=i:this.fragmentShader=i,this.initialize()}restore(){return this.initialize(),this.link(),this.checkLinkage(),this}translatedVertexSource(){if(this.vertexShader)return this.vertexShader.translatedSource();{let t=new Shader(this.gl,this.appState,GL.VERTEX_SHADER,this.vertexSource),e=t.translatedSource();return t.delete(),e}}translatedFragmentSource(){if(this.fragmentShader)return this.fragmentShader.translatedSource();{let t=new Shader(this.gl,this.appState,GL.FRAGMENT_SHADER,this.fragmentSource),e=t.translatedSource();return t.delete(),e}}delete(){return this.program&&(this.gl.deleteProgram(this.program),this.program=null,this.appState.program===this&&(this.gl.useProgram(null),this.appState.program=null)),this}initialize(){return this.appState.program===this&&(this.gl.useProgram(null),this.appState.program=null),this.linked=!1,this.uniformBlockCount=0,this.samplerCount=0,this.vertexSource&&(this.vertexShader=new Shader(this.gl,this.appState,GL.VERTEX_SHADER,this.vertexSource)),this.fragmentSource&&(this.fragmentShader=new Shader(this.gl,this.appState,GL.FRAGMENT_SHADER,this.fragmentSource)),this.program=this.gl.createProgram(),this}link(){return this.gl.attachShader(this.program,this.vertexShader.shader),this.gl.attachShader(this.program,this.fragmentShader.shader),this.transformFeedbackVaryings&&this.gl.transformFeedbackVaryings(this.program,this.transformFeedbackVaryings,GL.SEPARATE_ATTRIBS),this.gl.linkProgram(this.program),this}checkCompletion(){return!WEBGL_INFO.PARALLEL_SHADER_COMPILE||this.gl.getProgramParameter(this.program,GL.COMPLETION_STATUS_KHR)}checkLinkage(){return this.linked||(this.gl.getProgramParameter(this.program,GL.LINK_STATUS)?(this.linked=!0,this.initVariables()):(console.error(this.gl.getProgramInfoLog(this.program)),this.vertexShader.checkCompilation(),this.fragmentShader.checkCompilation()),this.vertexSource&&(this.vertexShader.delete(),this.vertexShader=null),this.fragmentSource&&(this.fragmentShader.delete(),this.fragmentShader=null)),this}initVariables(){this.bind();let t,e=this.gl.getProgramParameter(this.program,GL.ACTIVE_UNIFORMS);for(let r=0;r<e;++r){let e=this.gl.getActiveUniform(this.program,r),i=this.gl.getUniformLocation(this.program,e.name),n=null,s=e.type,a=e.size;switch(s){case GL.SAMPLER_2D:case GL.INT_SAMPLER_2D:case GL.UNSIGNED_INT_SAMPLER_2D:case GL.SAMPLER_2D_SHADOW:case GL.SAMPLER_2D_ARRAY:case GL.INT_SAMPLER_2D_ARRAY:case GL.UNSIGNED_INT_SAMPLER_2D_ARRAY:case GL.SAMPLER_2D_ARRAY_SHADOW:case GL.SAMPLER_CUBE:case GL.INT_SAMPLER_CUBE:case GL.UNSIGNED_INT_SAMPLER_CUBE:case GL.SAMPLER_CUBE_SHADOW:case GL.SAMPLER_3D:case GL.INT_SAMPLER_3D:case GL.UNSIGNED_INT_SAMPLER_3D:t=this.samplerCount++,this.samplers[e.name]=t,this.gl.uniform1i(i,t);break;case GL.INT:case GL.UNSIGNED_INT:case GL.FLOAT:n=a>1?MultiNumericUniform:SingleComponentUniform;break;case GL.BOOL:n=a>1?MultiBoolUniform:SingleComponentUniform;break;case GL.FLOAT_VEC2:case GL.INT_VEC2:case GL.UNSIGNED_INT_VEC2:case GL.FLOAT_VEC3:case GL.INT_VEC3:case GL.UNSIGNED_INT_VEC3:case GL.FLOAT_VEC4:case GL.INT_VEC4:case GL.UNSIGNED_INT_VEC4:n=MultiNumericUniform;break;case GL.BOOL_VEC2:case GL.BOOL_VEC3:case GL.BOOL_VEC4:n=MultiBoolUniform;break;case GL.FLOAT_MAT2:case GL.FLOAT_MAT3:case GL.FLOAT_MAT4:case GL.FLOAT_MAT2x3:case GL.FLOAT_MAT2x4:case GL.FLOAT_MAT3x2:case GL.FLOAT_MAT3x4:case GL.FLOAT_MAT4x2:case GL.FLOAT_MAT4x3:n=MatrixUniform;break;default:console.error("Unrecognized type for uniform ",e.name)}n&&(this.uniforms[e.name]=new n(this.gl,i,s,a))}let r=this.gl.getProgramParameter(this.program,GL.ACTIVE_UNIFORM_BLOCKS);for(let t=0;t<r;++t){let e=this.gl.getActiveUniformBlockName(this.program,t),r=this.gl.getUniformBlockIndex(this.program,e),i=this.uniformBlockCount++;this.gl.uniformBlockBinding(this.program,r,i),this.uniformBlocks[e]=i}}uniform(t,e){return this.uniforms[t]&&this.uniforms[t].set(e),this}bind(){return this.appState.program!==this&&(this.gl.useProgram(this.program),this.appState.program=this),this}}class Query{constructor(t,e){this.gl=t,this.query=null,this.target=e,this.active=!1,this.result=null,this.restore()}restore(){return this.query=this.gl.createQuery(),this.active=!1,this.result=null,this}begin(){return this.active||(this.gl.beginQuery(this.target,this.query),this.result=null),this}end(){return this.active||(this.gl.endQuery(this.target),this.active=!0),this}ready(){return!(!this.active||!this.gl.getQueryParameter(this.query,GL.QUERY_RESULT_AVAILABLE))&&(this.active=!1,this.result=Number(this.gl.getQueryParameter(this.query,GL.QUERY_RESULT)),!0)}delete(){return this.query&&(this.gl.deleteQuery(this.query),this.query=null),this}}class Timer{constructor(t){this.gl=t,this.cpuTimer=window.performance||window.Date,this.gpuTimerQuery=null,this.cpuStartTime=0,this.cpuTime=0,this.gpuTime=0,this.restore()}restore(){return WEBGL_INFO.GPU_TIMER&&(this.gpuTimerQuery?this.gpuTimerQuery.restore():this.gpuTimerQuery=new Query(this.gl,GL.TIME_ELAPSED_EXT)),this.cpuStartTime=0,this.cpuTime=0,this.gpuTime=0,this}start(){return WEBGL_INFO.GPU_TIMER?this.gpuTimerQuery.active||(this.gpuTimerQuery.begin(),this.cpuStartTime=this.cpuTimer.now()):this.cpuStartTime=this.cpuTimer.now(),this}end(){return WEBGL_INFO.GPU_TIMER?this.gpuTimerQuery.active||(this.gpuTimerQuery.end(),this.cpuTime=this.cpuTimer.now()-this.cpuStartTime):this.cpuTime=this.cpuTimer.now()-this.cpuStartTime,this}ready(){if(WEBGL_INFO.GPU_TIMER){if(!this.gpuTimerQuery.active)return!1;var t=this.gpuTimerQuery.ready(),e=this.gl.getParameter(GL.GPU_DISJOINT_EXT);return!(!t||e)&&(this.gpuTime=this.gpuTimerQuery.result/1e6,!0)}return Boolean(this.cpuStartTime)}delete(){return this.gpuTimerQuery&&(this.gpuTimerQuery.delete(),this.gpuTimerQuery=null),this}}class TransformFeedback{constructor(t,e){this.gl=t,this.appState=e,this.transformFeedback=null,this.restore()}restore(){return this.appState.transformFeedback===this&&(this.appState.transformFeedback=null),this.transformFeedback=this.gl.createTransformFeedback(),this}feedbackBuffer(t,e){return this.gl.bindTransformFeedback(GL.TRANSFORM_FEEDBACK,this.transformFeedback),this.gl.bindBufferBase(GL.TRANSFORM_FEEDBACK_BUFFER,t,e.buffer),this.gl.bindTransformFeedback(GL.TRANSFORM_FEEDBACK,null),this.gl.bindBufferBase(GL.TRANSFORM_FEEDBACK_BUFFER,t,null),this}delete(){return this.transformFeedback&&(this.gl.deleteTransformFeedback(this.transformFeedback),this.transformFeedback=null,this.appState.transformFeedback===this&&(this.gl.bindTransformFeedback(GL.TRANSFORM_FEEDBACK,null),this.appState.transformFeedback=null)),this}bind(){return this.appState.transformFeedback!==this&&(this.gl.bindTransformFeedback(GL.TRANSFORM_FEEDBACK,this.transformFeedback),this.appState.transformFeedback=this),this}}class UniformBuffer{constructor(t,e,r,i=t.DYNAMIC_DRAW){this.gl=t,this.buffer=null,this.dataViews={},this.offsets=new Array(r.length),this.sizes=new Array(r.length),this.types=new Array(r.length),this.size=0,this.usage=i,this.appState=e,this.currentBase=-1;for(let t=0,e=r.length;t<e;++t){let e=r[t];switch(e){case GL.FLOAT:case GL.INT:case GL.UNSIGNED_INT:case GL.BOOL:this.offsets[t]=this.size,this.sizes[t]=1,e===GL.INT?this.types[t]=GL.INT:e===GL.UNSIGNED_INT?this.types[t]=GL.UNSIGNED_INT:this.types[t]=GL.FLOAT,this.size++;break;case GL.FLOAT_VEC2:case GL.INT_VEC2:case GL.UNSIGNED_INT_VEC2:case GL.BOOL_VEC2:this.size+=this.size%2,this.offsets[t]=this.size,this.sizes[t]=2,e===GL.INT_VEC2?this.types[t]=GL.INT:e===GL.UNSIGNED_INT_VEC2?this.types[t]=GL.UNSIGNED_INT:this.types[t]=GL.FLOAT,this.size+=2;break;case GL.FLOAT_VEC3:case GL.INT_VEC3:case GL.UNSIGNED_INT_VEC3:case GL.BOOL_VEC3:case GL.FLOAT_VEC4:case GL.INT_VEC4:case GL.UNSIGNED_INT_VEC4:case GL.BOOL_VEC4:this.size+=(4-this.size%4)%4,this.offsets[t]=this.size,this.sizes[t]=4,e===GL.INT_VEC4||e===GL.INT_VEC3?this.types[t]=GL.INT:e===GL.UNSIGNED_INT_VEC4||e===GL.UNSIGNED_INT_VEC3?this.types[t]=GL.UNSIGNED_INT:this.types[t]=GL.FLOAT,this.size+=4;break;case GL.FLOAT_MAT2:case GL.FLOAT_MAT2x3:case GL.FLOAT_MAT2x4:this.size+=(4-this.size%4)%4,this.offsets[t]=this.size,this.sizes[t]=8,this.types[t]=GL.FLOAT,this.size+=8;break;case GL.FLOAT_MAT3:case GL.FLOAT_MAT3x2:case GL.FLOAT_MAT3x4:this.size+=(4-this.size%4)%4,this.offsets[t]=this.size,this.sizes[t]=12,this.types[t]=GL.FLOAT,this.size+=12;break;case GL.FLOAT_MAT4:case GL.FLOAT_MAT4x2:case GL.FLOAT_MAT4x3:this.size+=(4-this.size%4)%4,this.offsets[t]=this.size,this.sizes[t]=16,this.types[t]=GL.FLOAT,this.size+=16;break;default:console.error("Unsupported type for uniform buffer.")}}this.size+=(4-this.size%4)%4,this.data=new Float32Array(this.size),this.dataViews[GL.FLOAT]=this.data,this.dataViews[GL.INT]=new Int32Array(this.data.buffer),this.dataViews[GL.UNSIGNED_INT]=new Uint32Array(this.data.buffer),this.dirtyStart=this.size,this.dirtyEnd=0,this.restore()}restore(){return-1!==this.currentBase&&this.appState.uniformBuffers[this.currentBase]===this&&(this.appState.uniformBuffers[this.currentBase]=null),this.buffer=this.gl.createBuffer(),this.gl.bindBuffer(GL.UNIFORM_BUFFER,this.buffer),this.gl.bufferData(GL.UNIFORM_BUFFER,4*this.size,this.usage),this.gl.bindBuffer(GL.UNIFORM_BUFFER,null),this}set(t,e){let r=this.dataViews[this.types[t]],i=this.offsets[t],n=this.sizes[t];return 1===this.sizes[t]?r[i]=e:r.set(e,i),i<this.dirtyStart&&(this.dirtyStart=i),this.dirtyEnd<i+n&&(this.dirtyEnd=i+n),this}update(){if(this.dirtyStart>=this.dirtyEnd)return this;let t=this.data.subarray(this.dirtyStart,this.dirtyEnd),e=4*this.dirtyStart;return this.gl.bindBuffer(this.gl.UNIFORM_BUFFER,this.buffer),this.gl.bufferSubData(this.gl.UNIFORM_BUFFER,e,t),this.gl.bindBuffer(this.gl.UNIFORM_BUFFER,null),this.dirtyStart=this.size,this.dirtyEnd=0,this}delete(){return this.buffer&&(this.gl.deleteBuffer(this.buffer),this.buffer=null,-1!==this.currentBase&&this.appState.uniformBuffers[this.currentBase]===this&&(this.appState.uniformBuffers[this.currentBase]=null)),this}bind(t){let e=this.appState.uniformBuffers[t];return e!==this&&(e&&(e.currentBase=-1),-1!==this.currentBase&&(this.appState.uniformBuffers[this.currentBase]=null),this.gl.bindBufferBase(this.gl.UNIFORM_BUFFER,t,this.buffer),this.appState.uniformBuffers[t]=this,this.currentBase=t),this}}class VertexArray{constructor(t,e){this.gl=t,this.appState=e,this.vertexArray=null,this.indexType=null,this.indexed=!1,this.numElements=0,this.numInstances=1,this.offsets=0,this.numDraws=1}restore(){return this.appState.vertexArray===this&&(this.appState.vertexArray=null),null!==this.vertexArray&&(this.vertexArray=this.gl.createVertexArray()),this}vertexAttributeBuffer(t,e,r=DUMMY_OBJECT){return this.attributeBuffer(t,e,r,!1),this}instanceAttributeBuffer(t,e,r=DUMMY_OBJECT){return this.attributeBuffer(t,e,r,!0),this}indexBuffer(t){return null===this.vertexArray&&(this.vertexArray=this.gl.createVertexArray()),this.bind(),this.gl.bindBuffer(GL.ELEMENT_ARRAY_BUFFER,t.buffer),this.numElements=3*t.numItems,this.indexType=t.type,this.indexed=!0,this}delete(){return this.vertexArray&&(this.gl.deleteVertexArray(this.vertexArray),this.vertexArray=null,this.appState.vertexArray===this&&(this.gl.bindVertexArray(null),this.appState.vertexArray=null)),this}bind(){return this.appState.vertexArray!==this&&(this.gl.bindVertexArray(this.vertexArray),this.appState.vertexArray=this),this}attributeBuffer(t,e,r={},i){null===this.vertexArray&&(this.vertexArray=this.gl.createVertexArray()),this.bind(),this.gl.bindBuffer(GL.ARRAY_BUFFER,e.buffer);let{type:n=e.type,size:s=e.itemSize,stride:a=0,offset:o=0,normalized:h=!1,integer:c=Boolean(e.integer&&!h)}=r,l=e.numColumns;0===a&&(a=l*s*TYPE_SIZE[n]);for(let e=0;e<l;++e)c?this.gl.vertexAttribIPointer(t+e,s,n,a,o+e*s*TYPE_SIZE[n]):this.gl.vertexAttribPointer(t+e,s,n,h,a,o+e*s*TYPE_SIZE[n]),i&&this.gl.vertexAttribDivisor(t+e,1),this.gl.enableVertexAttribArray(t+e);return 1===this.numDraws&&(i?this.numInstances=e.numItems:this.numElements=this.numElements||e.numItems),this.gl.bindBuffer(GL.ARRAY_BUFFER,null),this}}const INTEGER_TYPES={[GL.BYTE]:!0,[GL.UNSIGNED_BYTE]:!0,[GL.SHORT]:!0,[GL.UNSIGNED_SHORT]:!0,[GL.INT]:!0,[GL.UNSIGNED_INT]:!0};class VertexBuffer{constructor(t,e,r,i,n,s=t.STATIC_DRAW,a){let o,h,c;switch(r){case GL.FLOAT_MAT4:case GL.FLOAT_MAT4x2:case GL.FLOAT_MAT4x3:o=4;break;case GL.FLOAT_MAT3:case GL.FLOAT_MAT3x2:case GL.FLOAT_MAT3x4:o=3;break;case GL.FLOAT_MAT2:case GL.FLOAT_MAT2x3:case GL.FLOAT_MAT2x4:o=2;break;default:o=1}switch(r){case GL.FLOAT_MAT4:case GL.FLOAT_MAT3x4:case GL.FLOAT_MAT2x4:i=4,r=GL.FLOAT;break;case GL.FLOAT_MAT3:case GL.FLOAT_MAT4x3:case GL.FLOAT_MAT2x3:i=3,r=GL.FLOAT;break;case GL.FLOAT_MAT2:case GL.FLOAT_MAT3x2:case GL.FLOAT_MAT4x2:i=2,r=GL.FLOAT}"number"==typeof n?(h=n,r&&(n*=TYPE_SIZE[r]),c=n):(h=n.length,c=n.byteLength),this.gl=t,this.buffer=null,this.appState=e,this.type=r,this.itemSize=i,this.numItems=r?h/(i*o):c/i,this.numColumns=o,this.byteLength=c,this.usage=s,this.indexArray=Boolean(a),this.integer=Boolean(INTEGER_TYPES[this.type]),this.binding=this.indexArray?GL.ELEMENT_ARRAY_BUFFER:GL.ARRAY_BUFFER,this.restore(n)}restore(t){return t||(t=this.byteLength),this.appState.vertexArray&&(this.gl.bindVertexArray(null),this.appState.vertexArray=null),this.buffer=this.gl.createBuffer(),this.gl.bindBuffer(this.binding,this.buffer),this.gl.bufferData(this.binding,t,this.usage),this.gl.bindBuffer(this.binding,null),this}data(t){return this.appState.vertexArray&&(this.gl.bindVertexArray(null),this.appState.vertexArray=null),this.gl.bindBuffer(this.binding,this.buffer),this.gl.bufferSubData(this.binding,0,t),this.gl.bindBuffer(this.binding,null),this}delete(){return this.buffer&&(this.gl.deleteBuffer(this.buffer),this.buffer=null),this}}class App{constructor(t,e){this.canvas=e,this.gl=t,this.width=this.gl.drawingBufferWidth,this.height=this.gl.drawingBufferHeight,this.viewportX=0,this.viewportY=0,this.viewportWidth=0,this.viewportHeight=0,this.currentDrawCalls=null,this.emptyFragmentShader=null,this.state={program:null,vertexArray:null,transformFeedback:null,activeTexture:-1,textures:new Array(WEBGL_INFO.MAX_TEXTURE_UNITS),uniformBuffers:new Array(WEBGL_INFO.MAX_UNIFORM_BUFFERS),freeUniformBufferBases:[],drawFramebuffer:null,readFramebuffer:null,extensions:{}},this.clearBits=this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT|this.gl.STENCIL_BUFFER_BIT,this.cpuTime=0,this.gpuTime=0,this.viewport(0,0,this.width,this.height),this.contextLostExt=null,this.contextRestoredHandler=null,this.initExtensions(),this.canvas.addEventListener("webglcontextlost",(t=>{t.preventDefault()})),this.canvas.addEventListener("webglcontextrestored",(()=>{this.initExtensions(),this.contextRestoredHandler&&this.contextRestoredHandler()}))}loseContext(){return this.contextLostExt&&this.contextLostExt.loseContext(),this}restoreContext(){return this.contextLostExt&&this.contextLostExt.restoreContext(),this}onContextRestored(t){return this.contextRestoredHandler=t,this}colorMask(t,e,r,i){return this.gl.colorMask(t,e,r,i),this}clearColor(t,e,r,i){return this.gl.clearColor(t,e,r,i),this}clearMask(t){return this.clearBits=t,this}clear(){return this.gl.clear(this.clearBits),this}drawFramebuffer(t){return t.bindForDraw(),this}readFramebuffer(t){return t.bindForRead(),this}defaultDrawFramebuffer(){return null!==this.state.drawFramebuffer&&(this.gl.bindFramebuffer(this.gl.DRAW_FRAMEBUFFER,null),this.state.drawFramebuffer=null),this}defaultReadFramebuffer(){return null!==this.state.readFramebuffer&&(this.gl.bindFramebuffer(this.gl.READ_FRAMEBUFFER,null),this.state.readFramebuffer=null),this}blitFramebuffer(t,e=DUMMY_OBJECT){let r=this.state.readFramebuffer,i=this.state.drawFramebuffer,n=r?r.width:this.width,s=r?r.height:this.height,a=i?i.width:this.width,o=i?i.height:this.height,{srcStartX:h=0,srcStartY:c=0,srcEndX:l=n,srcEndY:u=s,dstStartX:d=0,dstStartY:p=0,dstEndX:_=a,dstEndY:m=o,filter:f=GL.NEAREST}=e;return this.gl.blitFramebuffer(h,c,l,u,d,p,_,m,t,f),this}depthRange(t,e){return this.gl.depthRange(t,e),this}depthTest(){return this.gl.enable(this.gl.DEPTH_TEST),this}noDepthTest(){return this.gl.disable(this.gl.DEPTH_TEST),this}depthMask(t){return this.gl.depthMask(t),this}depthFunc(t){return this.gl.depthFunc(t),this}blend(){return this.gl.enable(this.gl.BLEND),this}noBlend(){return this.gl.disable(this.gl.BLEND),this}blendFunc(t,e){return this.gl.blendFunc(t,e),this}blendFuncSeparate(t,e,r,i){return this.gl.blendFuncSeparate(t,e,r,i),this}blendEquation(t){return this.gl.blendEquation(t),this}stencilTest(){return this.gl.enable(this.gl.STENCIL_TEST),this}noStencilTest(){return this.gl.disable(this.gl.STENCIL_TEST),this}stencilMask(t){return this.gl.stencilMask(t),this}stencilMaskSeparate(t,e){return this.gl.stencilMaskSeparate(t,e),this}stencilFunc(t,e,r){return this.gl.stencilFunc(t,e,r),this}stencilFuncSeparate(t,e,r,i){return this.gl.stencilFuncSeparate(t,e,r,i),this}stencilOp(t,e,r){return this.gl.stencilOp(t,e,r),this}stencilOpSeparate(t,e,r,i){return this.gl.stencilOpSeparate(t,e,r,i),this}scissorTest(){return this.gl.enable(this.gl.SCISSOR_TEST),this}noScissorTest(){return this.gl.disable(this.gl.SCISSOR_TEST),this}scissor(t,e,r,i){return this.gl.scissor(t,e,r,i),this}rasterize(){return this.gl.disable(this.gl.RASTERIZER_DISCARD),this}noRasterize(){return this.gl.enable(this.gl.RASTERIZER_DISCARD),this}cullBackfaces(){return this.gl.enable(this.gl.CULL_FACE),this}drawBackfaces(){return this.gl.disable(this.gl.CULL_FACE),this}readPixel(t,e,r,i=DUMMY_OBJECT){let{format:n=GL.RGBA,type:s=GL.UNSIGNED_BYTE}=i;return this.gl.readPixels(t,e,1,1,n,s,r),this}viewport(t,e,r,i){return this.viewportWidth===r&&this.viewportHeight===i&&this.viewportX===t&&this.viewportY===e||(this.viewportX=t,this.viewportY=e,this.viewportWidth=r,this.viewportHeight=i,this.gl.viewport(t,e,this.viewportWidth,this.viewportHeight)),this}defaultViewport(){return this.viewport(0,0,this.width,this.height),this}resize(t,e){return this.canvas.width=t,this.canvas.height=e,this.width=this.gl.drawingBufferWidth,this.height=this.gl.drawingBufferHeight,this.viewport(0,0,this.width,this.height),this}createProgram(t,e,r){return new Program(this.gl,this.state,t,e,r).link().checkLinkage()}createPrograms(...t){return new Promise(((e,r)=>{let i=t.length,n=new Array(i),s=new Array(i),a=i;for(let e=0;e<i;++e){let r=t[e],i=r[0],a=r[1],o=r[2];n[e]=new Program(this.gl,this.state,i,a,o),s[e]=n[e]}for(let t=0;t<i;++t)n[t].link();let o=()=>{let t=0;for(let e=0;e<a;++e)if(s[e].checkCompletion()){if(s[e].checkLinkage(),!s[e].linked)return void r(new Error("Program linkage failed"));++t}else s[e-t]=s[e];a-=t,0===a?e(n):requestAnimationFrame(o)};o()}))}restorePrograms(...t){return new Promise(((e,r)=>{let i=t.length,n=t.slice(),s=i;for(let e=0;e<i;++e)t[e].initialize();for(let e=0;e<i;++e)t[e].link();for(let e=0;e<i;++e)t[e].checkCompletion();let a=()=>{let t=0;for(let e=0;e<s;++e)if(n[e].checkCompletion()){if(n[e].checkLinkage(),!n[e].linked)return void r(new Error("Program linkage failed"));++t}else n[e-t]=n[e];s-=t,0===s?e():requestAnimationFrame(a)};a()}))}createShader(t,e){return new Shader(this.gl,this.state,t,e)}createVertexArray(){return new VertexArray(this.gl,this.state)}createTransformFeedback(){return new TransformFeedback(this.gl,this.state)}createVertexBuffer(t,e,r,i){return new VertexBuffer(this.gl,this.state,t,e,r,i)}createMatrixBuffer(t,e,r){return new VertexBuffer(this.gl,this.state,t,0,e,r)}createInterleavedBuffer(t,e,r){return new VertexBuffer(this.gl,this.state,null,t,e,r)}createIndexBuffer(t,e,r,i){return new VertexBuffer(this.gl,this.state,t,e,r,i,!0)}createUniformBuffer(t,e){return new UniformBuffer(this.gl,this.state,t,e)}createTexture2D(t,e,r,i){return"number"==typeof t?(i=r,r=e,e=t,t=null):void 0===r&&(i=e,e=t.width,r=t.height),new Texture$1(this.gl,this.state,this.gl.TEXTURE_2D,t,e,r,void 0,!1,i)}createTextureArray(t,e,r,i,n){return"number"==typeof t&&(n=i,i=r,r=e,e=t,t=null),new Texture$1(this.gl,this.state,this.gl.TEXTURE_2D_ARRAY,t,e,r,i,!0,n)}createTexture3D(t,e,r,i,n){return"number"==typeof t&&(n=i,i=r,r=e,e=t,t=null),new Texture$1(this.gl,this.state,this.gl.TEXTURE_3D,t,e,r,i,!0,n)}createCubemap(t){return new Cubemap(this.gl,this.state,t)}createRenderbuffer(t,e,r,i=0){return new Renderbuffer(this.gl,t,e,r,i)}createFramebuffer(){return new Framebuffer(this.gl,this.state)}createQuery(t){return new Query(this.gl,t)}createTimer(){return new Timer(this.gl)}createDrawCall(t,e,r){return new DrawCall(this.gl,this.state,t,e,r)}initExtensions(){this.gl.getExtension("EXT_color_buffer_float"),this.gl.getExtension("OES_texture_float_linear"),this.gl.getExtension("WEBGL_compressed_texture_s3tc"),this.gl.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this.gl.getExtension("WEBGL_compressed_texture_etc"),this.gl.getExtension("WEBGL_compressed_texture_astc"),this.gl.getExtension("WEBGL_compressed_texture_pvrtc"),this.gl.getExtension("EXT_disjoint_timer_query_webgl2"),this.gl.getExtension("EXT_disjoint_timer_query"),this.gl.getExtension("EXT_texture_filter_anisotropic"),this.state.extensions.debugShaders=this.gl.getExtension("WEBGL_debug_shaders"),this.contextLostExt=this.gl.getExtension("WEBGL_lose_context"),this.gl.getExtension("KHR_parallel_shader_compile"),this.state.extensions.multiDrawInstanced=this.gl.getExtension("WEBGL_multi_draw_instanced")}}let webglInfoInitialized=!1;const PicoGL=Object.assign({version:"0.15.1",WEBGL_INFO:WEBGL_INFO,createApp(t,e){let r=t.getContext("webgl2",e);return webglInfoInitialized||(WEBGL_INFO.MAX_TEXTURE_UNITS=r.getParameter(GL.MAX_COMBINED_TEXTURE_IMAGE_UNITS),WEBGL_INFO.MAX_UNIFORM_BUFFERS=r.getParameter(GL.MAX_UNIFORM_BUFFER_BINDINGS),WEBGL_INFO.MAX_UNIFORMS=Math.min(r.getParameter(GL.MAX_VERTEX_UNIFORM_VECTORS),r.getParameter(GL.MAX_FRAGMENT_UNIFORM_VECTORS)),WEBGL_INFO.SAMPLES=r.getParameter(GL.SAMPLES),WEBGL_INFO.VENDOR="(Unknown)",WEBGL_INFO.RENDERER="(Unknown)",WEBGL_INFO.FLOAT_RENDER_TARGETS=Boolean(r.getExtension("EXT_color_buffer_float")),WEBGL_INFO.LINEAR_FLOAT_TEXTURES=Boolean(r.getExtension("OES_texture_float_linear")),WEBGL_INFO.S3TC_TEXTURES=Boolean(r.getExtension("WEBGL_compressed_texture_s3tc")),WEBGL_INFO.S3TC_SRGB_TEXTURES=Boolean(r.getExtension("WEBGL_compressed_texture_s3tc_srgb")),WEBGL_INFO.ETC_TEXTURES=Boolean(r.getExtension("WEBGL_compressed_texture_etc")),WEBGL_INFO.ASTC_TEXTURES=Boolean(r.getExtension("WEBGL_compressed_texture_astc")),WEBGL_INFO.PVRTC_TEXTURES=Boolean(r.getExtension("WEBGL_compressed_texture_pvrtc")),WEBGL_INFO.LOSE_CONTEXT=Boolean(r.getExtension("WEBGL_lose_context")),WEBGL_INFO.DEBUG_SHADERS=Boolean(r.getExtension("WEBGL_debug_shaders")),WEBGL_INFO.GPU_TIMER=Boolean(r.getExtension("EXT_disjoint_timer_query_webgl2")||r.getExtension("EXT_disjoint_timer_query")),WEBGL_INFO.TEXTURE_ANISOTROPY=Boolean(r.getExtension("EXT_texture_filter_anisotropic")),WEBGL_INFO.MAX_TEXTURE_ANISOTROPY=WEBGL_INFO.TEXTURE_ANISOTROPY?r.getParameter(GL.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1,WEBGL_INFO.DEBUG_RENDERER_INFO=Boolean(r.getExtension("WEBGL_debug_renderer_info")),WEBGL_INFO.DEBUG_RENDERER_INFO&&(WEBGL_INFO.VENDOR=r.getParameter(GL.UNMASKED_VENDOR_WEBGL),WEBGL_INFO.RENDERER=r.getParameter(GL.UNMASKED_RENDERER_WEBGL)),WEBGL_INFO.PARALLEL_SHADER_COMPILE=Boolean(r.getExtension("KHR_parallel_shader_compile")),WEBGL_INFO.MULTI_DRAW_INSTANCED=Boolean(r.getExtension("WEBGL_multi_draw_instanced")),webglInfoInitialized=!0),new App(r,t)}},GL),mapget=(t,e,r)=>{t.has(e)||t.set(e,r());let i=t.get(e);return void 0===i?r():i};let prefix="x_",math="\n    const float pi = 3.1415926535897932384626433832795;\n    // https://en.wikipedia.org/wiki/Waveform\n    // #define sine(x)     smoothstep(0., 1., wave(x))\n    // #define square(x)   step(0.5, wave(x))\n    // #define sawtooth(x) mod(wave(x), 1.)\n    float priv_lwave(float t) {\n        return 1. - abs(mod(t, 1.) * 2. - 1.);\n    }\n    float wave(float t) {\n        return smoothstep(0., 1., priv_lwave(t));\n        // not the same: ...\n        // return sin(t * pi * 2. - pi * 0.5) * 0.5 + 0.5; // CHECK\n    }\n    /*\n        vec2 bezier(vec2 a, vec2 b, vec2 c, vec2 d, float t) {\n            return pow(1. - t, 3.) * a + 3. * pow(1. - t, 2.) * t * b + 3. * (1. - t) * pow(t, 2.) * c + pow(t, 3.) * d;\n        }\n        float ease(float x, float y, float a, float b, float t) {\n            return bezier(vec2(0.), vec2(x, y), vec2(a, b), vec2(1.), t).y;\n        }\n    */\n    // rescale: a/b == rescale(a, 0, b, 0, 1)\n    float rescale(float x, float amin, float amax, float bmin, float bmax) {\n        float a = amax - amin;\n        float b = bmax - bmin;\n        return (x - amin) * b / a + bmin;\n    }\n    // float range(float amin, float amax, float bmin, float bmax, float x) {\n    //     float a = amax - amin;\n    //     float b = bmax - bmin;\n    //     return (x - amin) * b / a + bmin;\n    // }\n",matrices="\n    mat4 translate(float x, float y, float z) {\n        return mat4(\n            1, 0, 0, 0,\n            0, 1, 0, 0,\n            0, 0, 1, 0,\n            x, y, z, 1\n        );\n    }\n    mat4 rotatex(float a) {\n        float c = cos(a);\n        float s = sin(a);\n        return mat4(\n            1, 0, 0, 0,\n            0, c, s, 0,\n            0,-s, c, 0,\n            0, 0, 0, 1\n        );\n    }\n    mat4 rotatey(float a) {\n        float c = cos(a);\n        float s = sin(a);\n        return mat4(\n            c, 0,-s, 0,\n            0, 1, 0, 0,\n            s, 0, c, 0,\n            0, 0, 0, 1\n        );\n    }\n    mat4 rotatez(float a) {\n        float c = cos(a);\n        float s = sin(a);\n        return mat4(\n            c, s, 0, 0,\n           -s, c, 0, 0,\n            0, 0, 1, 0,\n            0, 0, 0, 1\n        );\n    }\n    mat4 scale(float x, float y, float z) {\n        return mat4(\n            x, 0, 0, 0,\n            0, y, 0, 0,\n            0, 0, z, 0,\n            0, 0, 0, 1\n        );\n    }\n\n\n    float hfov2v(float hfov, float aspect) {\n        return 2. * atan(tan(hfov * 0.5) / aspect);\n    }\n    float vfov2h(float vfov, float aspect) {\n        return 2. * atan(tan(vfov * 0.5) * aspect);\n    }\n    // float f = 1. / tan(radians(fov) * 0.5);\n    // infinite far: [10]: -1, [14]: -2 * near\n    mat4 perspective_vfov_r(float vfov, float aspect, float near, float far) {\n        float f = tan(pi * 0.5 - 0.5 * vfov);\n        float rangeinv = 1.0 / (near - far);\n        return mat4(\n            f / aspect, 0,                            0,  0,\n                     0, f,                            0,  0,\n                     0, 0, (near + far) * rangeinv * 1., -1,\n                     0, 0,  near * far  * rangeinv * 2.,  0\n        );\n    }\n    mat4 perspective(float fov, float aspect, float near, float far) {\n        return perspective_vfov_r(radians(fov), aspect, near, far);\n    }\n\n\n\n\n\n    mat4 frustum(float left, float right, float bottom, float top, float near, float far) {\n        float dx = right - left;\n        float dy = top - bottom;\n        float dz = near - far;\n        return mat4(\n            2. * near / dx, 0, 0, 0,\n            0, 2. * near / dy, 0, 0,\n            (left + right) / dx, (top + bottom) / dy, far / dz, -1,\n            0, 0, near * far / dz, 0\n        );\n    }\n\n    mat4 ortho(float left, float right, float top, float bottom, float near, float far) {\n        float w = 1. / (right - left);\n        float h = 1. / (top - bottom);\n        float p = 1. / (far - near);\n        float x = (right + left) * w;     // far + near is 1, far - near is 1\n        float y = (top + bottom) * h;\n        float z = (far + near) * p;\n        return transpose(mat4(\n            2. * w,      0,       0, -x,\n                0, 2. * h,       0, -y,\n                0,      0, -2. * p, -z,\n                0,      0,       0,  1\n        ));\n    }\n\n\n    // mat4 ortho_2(float left, float right, float top, float bottom, float near, float far) {\n    //     return mat4(\n    //         2. / (right - left),      0,       0, 0,\n    //         0,                     2. / (top - bottom),       0, 0,\n    //             0,      0,                     2. / (far - near), 0,\n    //         (right + left) / (right-left), (top + bottom) / (top-bottom), (far + near) / (far-near),  1\n    //     );\n    // }\n\n\n\n\n    const mat4 orthoquad = mat4( // ortho(-0.5, 0.5, 0.5, -0.5, 0., 1.)\n        2., 0,  0,   0,\n        0,  2., 0,  -0,\n        0,  0, -2., -1.,\n        0,  0,  0,   1.\n    );\n    // const mat4 orthoquad = mat4(\n    //     1, 0, 0, -0,\n    //     0, 1, 0, -0,\n    //     0, 0, -1, -0,\n    //     0, 0, 0, 1\n    // );\n\n\n\n\n    // vec3 rvec_dir(mat3 m, vec3 dir) {\n    //     return vec3(\n    //         m[0].x * dir.x + m[1].x * dir.y + m[2].x * dir.z,\n    //         m[0].y * dir.x + m[1].y * dir.y + m[2].y * dir.z,\n    //         m[0].z * dir.x + m[1].z * dir.y + m[2].z * dir.z\n    //     );\n    // }\n    vec3 position(mat4 m) {\n        return m[3].xyz;\n    }\n    // mat3 rotation(mat3 m, vec3 scale) {\n    //     return mat3(m[0] * (1./scale.x), m[1] * (1./scale.y), m[2] * (1./scale.z));\n    // }\n        //  position\n        //  rotation\n        //  scaledup\n    vec3 get_scale(mat4 m) {\n        vec3 s = vec3(length(m[0].xyz), length(m[1].xyz), length(m[2].xyz));\n        float det = determinant(m);\n        if(det < 0.) s.x = -s.x;\n        return s;\n    }\n    vec3[3] decompose_unsafe(mat4 m) {\n        vec3 p = position(m);\n        vec3 s = get_scale(m);\n        m[0].xyz *= 1. / s.x;\n        m[1].xyz *= 1. / s.y;\n        m[2].xyz *= 1. / s.z;\n\t\tfloat m11 = m[0].x, m12 = m[1].x, m13 = m[2].x;\n        float m21 = m[0].y, m22 = m[1].y, m23 = m[2].y;\n\t\tfloat m31 = m[0].z, m32 = m[1].z, m33 = m[2].z;\n        // euler xyz\n        float y = asin(clamp(m13, -1., 1.));\n        float x, z;\n        if(abs(m13) < 0.9999999) {\n            x = atan(-m23, m33);\n            z = atan(-m12, m11);\n        }\n        else {\n            x = atan(m32, m22);\n            z = 0.;\n        }\n        vec3[3] r;\n        r[0] = p;\n        r[1] = vec3(x, y, z);\n        r[2] = s;\n        return r;\n    }\n\n    mat4 lookatup(vec3 eye, vec3 t, vec3 up) {\n        vec3 p = eye;\n        vec3 z = normalize(p - t);\n        vec3 x = normalize(cross(up, z));\n        vec3 y = normalize(cross(z, x));\n        return mat4(\n            x[0], x[1], x[2], 0,\n            y[0], y[1], y[2], 0,\n            z[0], z[1], z[2], 0,\n            p[0], p[1], p[2], 1\n        );\n    }\n    mat4 lookat(vec3 eye, vec3 t) {\n        return lookatup(eye, t, vec3(0, 1, 0));\n    }\n\n    // float length_sq(vec3 a) {\n    //     return a.x * a.x + a.y *a. y + a.z * a.z;\n    // }\n    // mat4 threejs_lookat(vec3 eye, vec3 target, vec3 up) {\n    //     vec3 z = eye - target;\n    //     if(length_sq(z) == 0.) z.z = 1.; // eye and target are in the same position\n    //     z = normalize(z);\n    //     vec3 x = cross(up, z);\n    //     if(length_sq(x) == 0.) { // up and z are parallel\n    //         if(abs(up.z) == 1.) z.x += 0.0001;\n    //         else                z.z += 0.0001;\n    //         z = normalize(z);\n    //         x = cross(up, z);\n    //     }\n    //     x = normalize(x);\n    //     vec3 y = cross(z, x);\n    //     return mat4(\n    //         x[0], x[1], x[2], 0,\n    //         y[0], y[1], y[2], 0,\n    //         z[0], z[1], z[2], 0,\n    //         eye[0], eye[1], eye[2], 1\n    //     );\n    // }\n    // mat4 lookat(mat4 m, vec3 target) {\n    //     vec3 eye = position(m);\n    //     vec3 up = vec3(0, 1, 0);\n    //     return threejs_lookat(eye, target, up);\n    // }\n\n\n    // mat4 lookatz(mat4 m, vec3 t) {\n    //     vec3 up = upvec(m);\n    //     return lookatup(m, t, up);\n    // }\n\n    // vec3 upvec(mat4 m) {\n    //     return normalize(vec3(m[1][0], m[1][1], m[1][2]));\n    // }\n\n    // mat4 billboard(mat4 m, mat4 camera) {\n    //     vec3 up = upvec(camera);\n    //     return lookatup(m, -position(camera), up);\n    // }\n    // mat4 billboardz(mat4 m, mat4 camera) {\n    //     return lookatup(m, -position(camera), vec3(0, 1, 0));\n    // }\n",lights="\n\nbool wrap(vec2 uv) {\n    return uv.x < 0. || uv.x > 1. || uv.y < 0. || uv.y > 1.;\n}\n\n    float diffuse(vec3 light, vec3 pos, vec3 normal) {\n        vec3 dist = light - pos.xyz;\n        return max(0., dot(normal, normalize(dist)));\n    }\n    float specular(vec3 light, vec3 pos, vec3 normal, vec3 eye, float shininess) {\n        vec3 lightpos = light;\n        vec3 eyedir = normalize(eye - pos.xyz);\n        vec3 lightdir = normalize(lightpos - pos.xyz);\n        vec3 halfv = normalize(eyedir + lightdir);\n        return pow(max(dot(normal, halfv), 0.), shininess);\n    }\n    // https://danielilett.com/2019-06-12-tut2-3-fresnel/\n    float fresnel(vec3 pos, vec3 normal, vec3 eye) {\n        vec3 v = normalize(eye - pos.xyz);\n        return 1. - dot(normal, v);\n    }\n\n    // projective texture mapping\n    // vec2 projuv(mat4 view, mat4 proj, vec3 pos) {\n    //     vec4 uv = proj * inverse(view) * vec4(pos, 1);\n    //     if(uv.w < 0.) return vec2(-1);\n    //     return (uv.xy / uv.w) * 0.5 + 0.5;\n    // }\n\n\n    bool do_light(vec3 light, vec3 pos, vec3 normal) {\n        vec3 dir = normalize(light - pos);\n        return dot(dir, normal) >= 0.;\n    }\n\n    vec2 projuv(mat4 view, mat4 proj, vec3 pos, vec3 normal) {\n        if(!do_light(position(view), pos, normal)) return vec2(-1);\n        vec4 uv = proj * inverse(view) * vec4(pos, 1);\n        if(uv.w <= 0.) return vec2(-1);\n        if(-uv.w <= uv.x && uv.x <= uv.w && -uv.w <= uv.y && uv.y <= uv.w && -uv.w <= uv.z && uv.z <= uv.w) {\n            return (uv.xy / uv.w) * 0.5 + 0.5;\n        }        \n        return vec2(-1);\n    }\n    vec2 sphereuv(vec3 n) {\n        return vec2(\n            0.5 + atan(n.z, n.x) / (pi * 2.),\n            0.5 - asin(n.y) / pi\n        );\n    }\n    vec2 spotmap_x(mat4 view, vec3 pos) {\n        vec3 dist = normalize(position(view) - pos.xyz);\n        vec3 ray = dist * mat3(view);\n        return sphereuv(ray * mat3(rotatey(pi / -2.)));\n    }\n    vec2 spotmap_nope(mat4 view, vec3 pos, float angle) {\n        if(angle != 1.) return vec2(-1);\n        return spotmap_x(view, pos);\n    }\n\n    vec2 spotuv(mat4 light, vec3 pos, vec3 normal) {\n        if(!do_light(position(light), pos, normal)) return vec2(-1);\n        // light *= rotatex(0.000000001);\n        return spotmap_x(light, pos);\n    }\n\n    float dist(vec3 light, vec3 pos, float d) {\n        float n = distance(light, pos);\n        return 1. - rescale(clamp(n, 0., d), 0., d, 0., 1.);\n    }\n\n\n\n    float shadow(mat4 light, mat4 proj, sampler2D map, vec4 pos, float bias) {\n        vec4 fpos = proj * inverse(light) * pos;\n        vec3 uv = fpos.xyz / fpos.w;\n        uv = uv * 0.5 + 0.5;\n        float r = 0.;\n        if(!wrap(uv.xy)) {\n            float closestDepth = texture(map, uv.xy).r; \n            float currentDepth = uv.z;\n            r = currentDepth - bias > closestDepth  ? 1.0 : 0.0; \n        }\n        return r;\n    }\n\n\n    vec3 cubeuv(vec3 v) {\n        float faceIndex;\n        vec3 vAbs = abs(v);\n        float ma;\n        vec2 uv;\n        if(vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {\n            faceIndex = v.z < 0.0 ? 5.0 : 4.0;\n            ma = 0.5 / vAbs.z;\n            uv = vec2(v.z < 0.0 ? -v.x : v.x, -v.y);\n        }\n        else if(vAbs.y >= vAbs.x) {\n            faceIndex = v.y < 0.0 ? 2.0 : 3.0;\n            ma = 0.5 / vAbs.y;\n            uv = vec2(v.x, v.y < 0.0 ? -v.z : v.z);\n        }\n        else {\n            faceIndex = v.x < 0.0 ? 1.0 : 0.0;\n            ma = 0.5 / vAbs.x;\n            uv = vec2(v.x < 0.0 ? v.z : -v.z, -v.y);\n        }\n        return vec3(uv * ma + 0.5, faceIndex);\n    }\n\n    vec4 cubemap(vec3 dir, sampler2D right, sampler2D left, sampler2D top, sampler2D bottom, sampler2D front, sampler2D back) {\n        vec3 st = cubeuv(dir);\n        if(st[2] == 0.) return texture(right,  st.xy);\n        if(st[2] == 1.) return texture(left,   st.xy);\n        if(st[2] == 2.) return texture(top,    st.xy);\n        if(st[2] == 3.) return texture(bottom, st.xy);\n        if(st[2] == 4.) return texture(front,  st.xy);\n        // if(st[2] == 5.)\n        return texture(back,   st.xy);\n    }\n\n\n    vec3 reflex(vec3 pos, vec3 normal, vec3 eye) {\n        vec3 I = normalize(eye - pos);\n        vec3 R = reflect(I, normalize(normal));              \n        return R;\n    }\n    vec3 refrax(vec3 pos, vec3 normal, vec3 eye, float ratio) {\n        vec3 I = -normalize(eye - pos);\n        vec3 R = -refract(I, normalize(normal), ratio);\n        return R;\n    }\n\n    // https://www.clicktorelease.com/blog/creating-spherical-environment-mapping-shader/\n    vec2 matcap(vec3 eye, vec3 normal) {\n        vec3 r = reflect(eye, normal);\n        float m = 2. * sqrt( pow( r.x, 2. ) + pow( r.y, 2. ) + pow( r.z + 1., 2. ) );\n        vec2 vN = r.xy / m + .5;\n        return vN;\n    }\n",surface="\n    // mr doob\n    // vec3 normalgen(sampler2D h, vec2 uv) {\n    //     ivec2 size = textureSize(h, 0);\n    //     float px = 1. / float(size.x);// + 0.01;\n    //     float py = 1. / float(size.y);// + 0.01;\n    //     // px = 0.1;\n    //     // px = 0.1;\n    //  // float h00 = texture(h, uv + vec2(-px, -py)).r;\n    //     float h10 = texture(h, uv + vec2( 0., -py)).r;\n    //  // float h20 = texture(h, uv + vec2( px, -py)).r;\n    //     float h01 = texture(h, uv + vec2(-px,  0.)).r;\n    //     float h21 = texture(h, uv + vec2( px,  0.)).r;\n    //  // float h02 = texture(h, uv + vec2(-px,  py)).r;\n    //     float h12 = texture(h, uv + vec2( 0.,  py)).r;\n    //  // float h22 = texture(h, uv + vec2( px,  py)).r;\n    //     vec3 c = vec3((h21 - h01) + 0.5, (h12 - h10) + 0.5, 1);\n    //     return c;\n    // }\n    float sampleSobel(sampler2D t, vec2 uv)\n    {\n        float weight = 1.0;\n        float f = 1. - texture(t, uv).r;\n        return f * weight - (weight * 0.5);\n    }\n    // https://www.shadertoy.com/view/Xtd3DS\n    vec3 normalgen(sampler2D t, vec2 uv)\n    {   \n        ivec2 size = textureSize(t, 0);\n        float x = 1. / float(size.x);\n        float y = 1. / float(size.y);\n        // float x = 1. / 900.;\n        // float y = 1. / 900.;\n        \n        // |-1  0  1|\n        // |-2  0  2| \n        // |-1  0  1|\n        \n        float gX = 0.0;\n        gX += -1.0 * sampleSobel(t, uv + vec2(-x, -y));\n        gX += -2.0 * sampleSobel(t, uv + vec2(-x,  0));\n        gX += -1.0 * sampleSobel(t, uv + vec2(-x, +y));\n        gX += +1.0 * sampleSobel(t, uv + vec2(+x, -y));\n        gX += +2.0 * sampleSobel(t, uv + vec2(+x,  0));\n        gX += +1.0 * sampleSobel(t, uv + vec2(+x, +y));\n        \n        // |-1 -2 -1|\n        // | 0  0  0| \n        // | 1  2  1|\n        \n        float gY = 0.0;\n        gY += -1.0 * sampleSobel(t, uv + vec2(-x, -y));\n        gY += -2.0 * sampleSobel(t, uv + vec2( 0, -y));\n        gY += -1.0 * sampleSobel(t, uv + vec2(+x, -y));\n        gY += +1.0 * sampleSobel(t, uv + vec2(-x, +y));\n        gY += +2.0 * sampleSobel(t, uv + vec2( 0, +y));\n        gY += +1.0 * sampleSobel(t, uv + vec2(+x, +y));\n        \n    \n        vec2 f = vec2(sqrt(gX * gX + gY * gY), atan(-gY, -gX));\n        vec2 gradientDirection = f.x * vec2(cos(f.y), sin(f.y));\n        vec3 normal = normalize(vec3(gradientDirection, 1.0));\n        // normal.x = -normal.x;\n        return normal * 0.5 + 0.5;\n    }    \n    //vec3 normalmap(vec3 normal, vec3 tangent, vec3 bitangent, sampler2D t, vec2 uv, float scale) {\n    vec3 normalmap(mat3 tbn, sampler2D t, vec2 uv, float scale) {\n        vec3 n = texture(t, uv).xyz * 2.0 - 1.0;\n        // n.z *= -0.01;\n        n.xy *= scale;\n        return normalize(tbn * n);\n    }\n    vec2 parallax_f(vec2 uv, vec3 viewdir, sampler2D hmap, float scale, float quality) {\n        const float min = 10.;\n        float max = 512. * quality;\n        float n = mix(max, min, abs(dot(vec3(0, 0, 1), viewdir)));  \n        float depth = 1. / n;\n        float c = 0.;\n        vec2 P = viewdir.xy / viewdir.z * scale;\n        vec2 delta = P / n;\n        vec2 cuv = uv;\n        float ch = texture(hmap, cuv).r;\n        while(c < ch) {\n            cuv -= delta;\n            ch = texture(hmap, cuv).r;  \n            c += depth;  \n        }\n        vec2 prev = cuv + delta;\n        float after  = ch - c;\n        float before = texture(hmap, prev).r - c + depth;\n        float weight = after / (after - before);\n        vec2 r = prev * weight + cuv * (1. - weight);\n        return r;\n    }\n    // vec2 parallax(vec3 normal, vec3 tangent, vec3 bitangent, vec3 eye, vec3 pos, vec2 uv, sampler2D hmap, float scale) {\n    // vec2 parallax(vec3 normal, vec3 tangent, vec3 bitangent, sampler2D hmap, vec2 uv, float scale, vec3 pos, vec3 eye) {\n    vec2 parallax(mat3 tbn, sampler2D t, vec2 uv, float scale, float quality, vec3 pos, vec3 eye) {\n        mat3 ttbn = transpose(tbn);\n        \n        ivec2 size = textureSize(t, 0);\n        float asp = float(size.x) / float(size.y);\n\n        // asp = 1.;\n\n        eye.y *= asp;\n        pos.y *= asp;\n\n        vec3 tbnv = ttbn * eye;\n        vec3 tbnp = ttbn * pos.xyz;\n        vec3 vdir = normalize(tbnv - tbnp);\n        return parallax_f(uv, vdir, t, scale, quality);\n    }\n",particles="\n    // float[4] catmullrom_init_c(float x0, float x1, float t0, float t1) {\n    //     return float[4](\n    //         x0,\n    //         t0,\n    //         -3. * x0 + 3. * x1 - 2. * t0 - t1,\n    //         2. * x0 - 2. * x1 + t0 + t1\n    //     );\n    // }\n    // float[4] catmullrom_init(float x0, float x1, float x2, float x3, float tension) {\n    //     return catmullrom_init_c(x1, x2, tension * (x2 - x0), tension * (x3 - x1));\n    // }\n    // float[4] catmullrom_init_nonuni(float x0, float x1, float x2, float x3, float dt0, float dt1, float dt2) {\n    //     float t1 = (x1 - x0) / dt0 - (x2 - x0) / (dt0 + dt1) + (x2 - x1) / dt1;\n    //     float t2 = (x2 - x1) / dt1 - (x3 - x1) / (dt1 + dt2) + (x3 - x2) / dt2;\n    //     t1 *= dt1;\n    //     t2 *= dt1;\n    //     return catmullrom_init_c(x1, x2, t1, t2);\n    // }\n    // float catmullrom_calc(float[4] c, float t) {\n    //     float t2 = t * t;\n    //     float t3 = t2 * t;\n    //     return c[0] + c[1] * t + c[2] * t2 + c[3] * t3;\n    // }\n    // float distance_to_squared(vec3 a, vec3 b) {\n    //     float dx = a.x - b.x;\n    //     float dy = a.y - b.y;\n    //     float dz = a.z - b.z;\n    //     return dx * dx + dy * dy + dz * dz;\n    // }\n    // vec3 catmullrom(vec3[4] p, float tension, float t) {\n    //     t = mod(t, 1.);\n    //     int LENGTH = 4;\n    //     float pp = float(LENGTH - 1) * t;\n    //     int ip = int(floor(pp));\n    //     float weight = pp - float(ip);\n    //     if(weight == 0. && ip == (LENGTH - 1)) {\n    //         ip = LENGTH - 2;\n    //         weight = 1.;\n    //     }\n    //     vec3 p0 = (p[0] - p[1]) + p[0];\n    //     vec3 p1 = p[ip % LENGTH];\n    //     vec3 p2 = p[(ip + 1) % LENGTH];\n    //     vec3 p3 = (p[LENGTH - 1] - p[LENGTH - 2]) + p[LENGTH - 1];\n    //     // non-uniform\n    //     float centripetal = 0.25;\n    //     float chordal = 0.5;\n    //     float pw = centripetal;\n    //     float dt0 = pow(distance_to_squared(p0, p1), pw);\n    //     float dt1 = pow(distance_to_squared(p1, p2), pw);\n    //     float dt2 = pow(distance_to_squared(p2, p3), pw);\n    //     if(dt1 < 1e-4) dt1 = 1.;\n    //     if(dt0 < 1e-4) dt0 = dt1;\n    //     if(dt2 < 1e-4) dt2 = dt1;\n    //     return vec3(\n    //         catmullrom_calc(catmullrom_init_nonuni(p0.x, p1.x, p2.x, p3.x, dt0, dt1, dt2), weight),\n    //         catmullrom_calc(catmullrom_init_nonuni(p0.y, p1.y, p2.y, p3.y, dt0, dt1, dt2), weight),\n    //         catmullrom_calc(catmullrom_init_nonuni(p0.z, p1.z, p2.z, p3.z, dt0, dt1, dt2), weight)\n    //     );\n    //     // uniform\n    //     // tension = 0.7;\n    //     return vec3(\n    //         catmullrom_calc(catmullrom_init(p0.x, p1.x, p2.x, p3.x, tension), weight),\n    //         catmullrom_calc(catmullrom_init(p0.y, p1.y, p2.y, p3.y, tension), weight),\n    //         catmullrom_calc(catmullrom_init(p0.z, p1.z, p2.z, p3.z, tension), weight)\n    //     );\n    // }\n    vec3 catmullrom(vec3[4] p, float tension, float t) {\n        // Cardinal Spline Matrix\n        // https://www.shadertoy.com/view/MlGSz3\n        float T = tension;\n        mat4 CRM = mat4(-T,        2.0 - T,  T - 2.0,         T,\n                               2.0 * T,  T - 3.0,  3.0 - 2.0 * T,  -T,\n                              -T,        0.0,      T,               0.0,\n                               0.0,      1.0,      0.0,             0.0);\n        vec3 G1 = p[0];\n        vec3 G2 = p[1];\n        vec3 G3 = p[2];\n        vec3 G4 = p[3];\n        vec3 A = G1 * CRM[0][0] + G2 * CRM[0][1] + G3 * CRM[0][2] + G4 * CRM[0][3];\n        vec3 B = G1 * CRM[1][0] + G2 * CRM[1][1] + G3 * CRM[1][2] + G4 * CRM[1][3];\n        vec3 C = G1 * CRM[2][0] + G2 * CRM[2][1] + G3 * CRM[2][2] + G4 * CRM[2][3];\n        vec3 D = G1 * CRM[3][0] + G2 * CRM[3][1] + G3 * CRM[3][2] + G4 * CRM[3][3];\n        return t * (t * (t * A + B) + C) + D;\n    }\n    // vec3 curvepath(vec3[16] p, int size, float t) {\n    //     t = mod(t, 1.);\n    //     int i = int(floor(rescale(t, 0., 1., 0., float(size - 3))));\n    //     float d = 1. / float(size - 3);\n    //     float dt = mod(t, d);\n    //     vec3[4] v = vec3[4](p[i], p[i + 1], p[i + 2], p[i + 3]);\n    //     float x = 1. / 3.;\n    //     return catmullrom(v, 1., rescale(dt, 0., d, x, x + x));\n    // }\n    vec3 curvepath(vec3[64] p, float[64] ts, int size, float t) {\n        t = mod(t, 1.);\n        int i = int(floor(rescale(t, 0., 1., 0., float(size - 3))));\n        float d = 1. / float(size - 3);\n        float dt = mod(t, d);\n        vec3[4] v = vec3[4](p[i], p[i + 1], p[i + 2], p[i + 3]);\n        return catmullrom(v, ts[i + 1], rescale(dt, 0., d, 0., 1.));\n    }\n//\n//let span =\n    float randi2(int a, int b) {\n        vec2 st = vec2(a, b);\n        return fract(\n            sin(\n                dot(st, vec2(12.9898, 78.233))\n            ) * 43758.5453123\n        );\n    }\n    vec3 span(int seed, float range, float min, float offset, float time) {\n        float life = randi2(seed, 0) * range + min;\n        float off = randi2(seed, 1) * offset;\n        float n = off + time / life;\n        int cycle = int(n) + 2; // +2 to avoid overlap of randi2\n        float t = fract(n);\n        return vec3(cycle, t, seed);\n    }\n    const int START = 0;\n    const int START_RAND = 1;\n    const int END = 2;\n    const int END_RAND = 3;\n    float emit_field(float[4] v, float t, float r1, float r2) {\n        return mix(\n            v[START] + rescale(r1, 0., 1., -v[START_RAND], v[START_RAND]),\n            v[END]   + rescale(r2, 0., 1., -v[END_RAND],   v[END_RAND]),\n            t\n        );\n    }\n    mat4 emit(vec3 span, vec3[4] points, float[4] angle, float[4] size) {\n        int c = int(span.x);\n        float t = span.y;\n        int seed = int(span.z);\n        #define r() randi2(seed, c++)\n        vec3 a = points[START];\n        vec3 ar = points[START_RAND];\n        vec3 b = points[END];\n        vec3 br = points[END_RAND];\n        a.x += rescale(r(), 0., 1., -ar.x, ar.x);\n        a.y += rescale(r(), 0., 1., -ar.y, ar.y);\n        a.z += rescale(r(), 0., 1., -ar.z, ar.z);\n        b.x += rescale(r(), 0., 1., -br.x, br.x);\n        b.y += rescale(r(), 0., 1., -br.y, br.y);\n        b.z += rescale(r(), 0., 1., -br.z, br.z);\n        vec3 p_ = mix(a, b, t);\n        float an = emit_field(angle, t, r(), r());\n        float sz = emit_field(size,  t, r(), r());\n        #undef r\n        return translate(p_.x, p_.y, p_.z) * rotatez(an) * scale(sz, sz, sz);\n    }\n    mat4 emitcurve(vec3 span, vec3[64] ps, vec3[64] ds, float[64] ts, int length, float[4] angle, float[4] size) {\n        int c = int(span.x);\n        float t = span.y;\n        int seed = int(span.z);\n        #define r() randi2(seed, c++)\n        vec3[64] q;\n        for(int i = 0; i < length; i++) {\n            q[i] = vec3(\n                ps[i].x + rescale(r(), 0., 1., -ds[i].x, ds[i].x),\n                ps[i].y + rescale(r(), 0., 1., -ds[i].y, ds[i].y),\n                ps[i].z + rescale(r(), 0., 1., -ds[i].z, ds[i].z)\n            );\n        }\n        vec3 p_ = curvepath(q, ts, length, t);\n        float an = emit_field(angle, t, r(), r());\n        float sz = emit_field(size,  t, r(), r());\n        #undef r\n        return translate(p_.x, p_.y, p_.z) * rotatez(an) * scale(sz, sz, sz);\n    }\n//\n// let slash = \n    float slash_hard(vec4 p_, float a, float b, float c, float d, float time) {\n        float t = mod(time, a + b + c + d);\n        if(t < a) return (t / a - p_.r) > 0.? p_.a : 0.;\n        t -= a;\n        if(t < b) return p_.a;\n        t -= b;\n        if(t < c) return (t / c - p_.r) > 0.? 0. : p_.a;\n        return 0.;\n    }\n    float slash_one(float r, float a, float t, float n) {\n        float tn = t / n;\n        float f = tn - r;\n        float o = 0.5;\n        o = mix(o, 0., tn); // float o = 1. - tn;\n        if(f < 0.) return 0.;\n        if(f < o) {\n            return mix(0., a, rescale(f, 0., o, 0., 1.));\n        }\n        return 1.;\n    }\n    float slash(float pr, float pa, float a, float b, float c, float d, float time) {\n        float t = mod(time, a + b + abs(c) + d);\n        if(t < a) {\n            return slash_one(pr, pa, t, a);\n        }\n        t -= a;\n        if(t < b) {\n            return pa;\n        }\n        t -= b;\n        if(c < 0. && t < -c) {\n            return slash_one(pr, pa, -c - t, -c);\n        }\n        if(t < c) {\n            return 1. - slash_one(pr, pa, t, c);\n        }\n        return 0.;\n    }\n",color="\n    vec3 rgbtohsv(vec3 c) {\n        vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);\n        vec4 p_ = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));\n        vec4 q = mix(vec4(p_.xyw, c.r), vec4(c.r, p_.yzx), step(p_.x, c.r));\n        float d = q.x - min(q.w, q.y);\n        float e = 1.0e-10;\n        return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);\n    }\n    vec3 hsvtorgb(vec3 c) {\n        vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\n        vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n        return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\n    }\n    vec4 hue(vec4 c, float v) {\n        vec3 hsv = rgbtohsv(c.rgb);\n        hsv.x += v;\n        c.rgb = hsvtorgb(hsv);\n        return c;\n    }\n    vec4 invert(vec4 c) {\n        return vec4(1.-c.r, 1.-c.g, 1.-c.b, c.a);\n    }\n",filters="\n    // vec4 blur_13(sampler2D image, vec2 uv, vec2 strength) {\n    //     vec4 color = vec4(0.0);\n    //     vec2 off1 = vec2(1.411764705882353) * strength;\n    //     vec2 off2 = vec2(3.2941176470588234) * strength;\n    //     vec2 off3 = vec2(5.176470588235294) * strength;\n    //     color += texture(image, uv) * 0.1964825501511404;\n    //     color += texture(image, uv + off1) * 0.2969069646728344;\n    //     color += texture(image, uv - off1) * 0.2969069646728344;\n    //     color += texture(image, uv + off2) * 0.09447039785044732;\n    //     color += texture(image, uv - off2) * 0.09447039785044732;\n    //     color += texture(image, uv + off3) * 0.010381362401148057;\n    //     color += texture(image, uv - off3) * 0.010381362401148057;\n    //     return color;\n    // }\n    // vec4 hblur(sampler2D t, vec2 uv, float strength) {\n    //     return blur_13(t, uv, vec2(strength, 0));\n    // }\n    // vec4 vblur(sampler2D t, vec2 uv, float strength) {\n    //     return blur_13(t, uv, vec2(0, strength));\n    // }\n\n    vec4 blur_13(sampler2D image, vec2 uv, vec2 direction) {\t\n        vec4 color = vec4(0.0);\t\n        vec2 off1 = vec2(1.411764705882353) * direction;\t\n        vec2 off2 = vec2(3.2941176470588234) * direction;\t\n        vec2 off3 = vec2(5.176470588235294) * direction;\t\n        color += texture(image, uv) * 0.1964825501511404;\t\n        color += texture(image, uv + off1) * 0.2969069646728344;\t\n        color += texture(image, uv - off1) * 0.2969069646728344;\t\n        color += texture(image, uv + off2) * 0.09447039785044732;\t\n        color += texture(image, uv - off2) * 0.09447039785044732;\t\n        color += texture(image, uv + off3) * 0.010381362401148057;\t\n        color += texture(image, uv - off3) * 0.010381362401148057;\t\n        return color;\t\n    }\t\n    vec4 hblur(sampler2D t, vec2 uv, float strength) {\t\n        return blur_13(t, uv, vec2(strength, 0));\t\n    }\t\n    vec4 vblur(sampler2D t, vec2 uv, float strength) {\n        return blur_13(t, uv, vec2(0, strength));\n    }\n//\n//let zoomblur = \n    vec4 zoomblur(sampler2D img, vec2 uv, float x, float y, float strength) {\n        vec2 inc = (vec2(x, 1. - y) - uv) * strength;\n        vec4 sum;\n        sum += texture(img, uv - inc * 4.) * 0.051;\n        sum += texture(img, uv - inc * 3.) * 0.0918;\n        sum += texture(img, uv - inc * 2.) * 0.12245;\n        sum += texture(img, uv - inc * 1.) * 0.1531;\n        sum += texture(img, uv + inc * 0.) * 0.1633;\n        sum += texture(img, uv + inc * 1.) * 0.1531;\n        sum += texture(img, uv + inc * 2.) * 0.12245;\n        sum += texture(img, uv + inc * 3.) * 0.0918;\n        sum += texture(img, uv + inc * 4.) * 0.051;\n        return sum;\n    }\n    // vec4 zoomblur2(sampler2D img, vec2 uv, float x, float y, float sa, float sb) {\n    //     vec2 inc = (vec2(x, 1. - y) - uv) * vec2(sa, sb);\n    //     vec4 sum;\n    //     sum += texture(img, uv - inc * 4.) * 0.051;\n    //     sum += texture(img, uv - inc * 3.) * 0.0918;\n    //     sum += texture(img, uv - inc * 2.) * 0.12245;\n    //     sum += texture(img, uv - inc * 1.) * 0.1531;\n    //     sum += texture(img, uv + inc * 0.) * 0.1633;\n    //     sum += texture(img, uv + inc * 1.) * 0.1531;\n    //     sum += texture(img, uv + inc * 2.) * 0.12245;\n    //     sum += texture(img, uv + inc * 3.) * 0.0918;\n    //     sum += texture(img, uv + inc * 4.) * 0.051;\n    //     return sum;\n    // }\n    float sobel(sampler2D t, vec2 uv, float x, float y) { // x and y are strength\n        vec4 h = vec4(0);\n        h -= texture(t, vec2(uv.x - x, uv.y - y)) * 1.;\n        h -= texture(t, vec2(uv.x - x, uv.y    )) * 2.;\n        h -= texture(t, vec2(uv.x - x, uv.y + y)) * 1.;\n        h += texture(t, vec2(uv.x + x, uv.y - y)) * 1.;\n        h += texture(t, vec2(uv.x + x, uv.y    )) * 2.;\n        h += texture(t, vec2(uv.x + x, uv.y + y)) * 1.;\n        vec4 v_ = vec4(0);\n        v_ -= texture(t, vec2(uv.x - x, uv.y - y)) * 1.;\n        v_ -= texture(t, vec2(uv.x    , uv.y - y)) * 2.;\n        v_ -= texture(t, vec2(uv.x + x, uv.y - y)) * 1.;\n        v_ += texture(t, vec2(uv.x - x, uv.y + y)) * 1.;\n        v_ += texture(t, vec2(uv.x    , uv.y + y)) * 2.;\n        v_ += texture(t, vec2(uv.x + x, uv.y + y)) * 1.;\n        vec3 edge = sqrt(h.rgb * h.rgb + v_.rgb * v_.rgb);\n        return (edge.x + edge.y + edge.z) / 3.;\n    }\n    // https://www.shadertoy.com/view/XlsXRB\n    float outline_x(sampler2D t, vec2 uv, float samples_dx, bool inside) {\n        vec2 size = vec2(textureSize(t, 0));\n        ivec2 iuv = ivec2(int(uv.x * size.x), int(uv.y * size.y));\n        float samples = round(samples_dx * size.x);\n        int isamples = int(samples);\n        float d = samples;\n        for(int x = -isamples; x != isamples; x++) {\n            for(int y = -isamples; y != isamples; y++) {\n                float a = texelFetch(t, iuv + ivec2(x, y), 0).a;\n                if(inside) a = 1. - a;\n                // if(dot(normalize(vec2(x, y)), normalize(vec2(0, -5))) < 0.75) continue;\n                if(a > 0.5) {\n                    d = min(d, length(vec2(x, y)));\n                }\n            }\n        }\n        d = clamp(d, 0., samples) / samples;\n        // d = clamp(d, 0., 1.); // may be over -0.00000001\n        return 1. - d;\n    }\n    float outline(sampler2D t, vec2 uv, float samples_dx) {\n        return outline_x(t, uv, samples_dx, false);\n    }\n\n\n\n\n\n    const float[64] ssao_noise = float[64](\n        -0.7123168110847473, 0.7018580436706543, 0., 0., -0.6823078393936157, -0.7310649752616882, 0., 0., 0.8779285550117493, -0.47879165410995483, 0., 0., 0.7977963089942932, 0.602927029132843, 0., 0., 0.15651366114616394, -0.9876757860183716, 0., 0., 0.9920237064361572, -0.12605135142803192, 0., 0., -0.8378090262413025, -0.5459634065628052, 0., 0., 0.6735560297966003, 0.7391361594200134, 0., 0., 0.02000349946320057, 0.999799907207489, 0., 0., 0.30650821328163147, -0.9518679976463318, 0., 0., -0.4286597669124603, 0.903465986251831, 0., 0., 0.7592897415161133, 0.6507527232170105, 0., 0., 0.9918479919433594, -0.1274268627166748, 0., 0., 0.7089933753013611, -0.7052151560783386, 0., 0., 0.9855568408966064, 0.1693449169397354, 0., 0., 0.4421997368335724, -0.8969166278839111, 0., 0.\n    );\n    vec4 table_get(vec4[16] table, int i, int j) {\n        return table[i * 4 + j];\n    }\n    vec3 ssao_noise_lookup(float x, float y) {\n        // float[64] T = ssao_noise;\n        // vec4[24] table;\n        // table[0] = vec4(T[0],  T[1],  T[2],  T[3]);\n        // table[1] = vec4(T[4],  T[5],  T[6],  T[7]);\n        // table[2] = vec4(T[8],  T[9],  T[10], T[11]);\n        // table[3] = vec4(T[12], T[13], T[14], T[15]);\n        // table[4] = table[0];\n        // table[5] = vec4(T[16], T[17], T[18], T[19]);\n        // table[6] = vec4(T[20], T[21], T[22], T[23]);\n        // table[7] = vec4(T[24], T[25], T[26], T[27]);\n        // table[8] = vec4(T[28], T[29], T[30], T[31]);\n        // table[9] = table[5];\n        // table[10] = vec4(T[32], T[33], T[34], T[35]);\n        // table[11] = vec4(T[36], T[37], T[38], T[39]);\n        // table[12] = vec4(T[40], T[41], T[42], T[43]);\n        // table[13] = vec4(T[44], T[45], T[46], T[47]);\n        // table[14] = table[10];\n        // table[15] = vec4(T[48], T[49], T[50], T[51]);\n        // table[16] = vec4(T[52], T[53], T[54], T[55]);\n        // table[17] = vec4(T[56], T[57], T[58], T[59]);\n        // table[18] = vec4(T[60], T[61], T[62], T[63]);\n        // table[19] = table[15];\n        // table[20] = table[0];\n        // table[21] = table[1];\n        // table[22] = table[2];\n        // table[23] = table[3];\n        float[64] T = ssao_noise;\n        vec4[16] table;\n        table[0] =  vec4(T[0],  T[1],  T[2],  T[3]);\n        table[1] =  vec4(T[4],  T[5],  T[6],  T[7]);\n        table[2] =  vec4(T[8],  T[9],  T[10], T[11]);\n        table[3] =  vec4(T[12], T[13], T[14], T[15]);\n        table[4] =  vec4(T[16], T[17], T[18], T[19]);\n        table[5] =  vec4(T[20], T[21], T[22], T[23]);\n        table[6] =  vec4(T[24], T[25], T[26], T[27]);\n        table[7] =  vec4(T[28], T[29], T[30], T[31]);\n        table[8] =  vec4(T[32], T[33], T[34], T[35]);\n        table[9] =  vec4(T[36], T[37], T[38], T[39]);\n        table[10] = vec4(T[40], T[41], T[42], T[43]);\n        table[11] = vec4(T[44], T[45], T[46], T[47]);\n        table[12] = vec4(T[48], T[49], T[50], T[51]);\n        table[13] = vec4(T[52], T[53], T[54], T[55]);\n        table[14] = vec4(T[56], T[57], T[58], T[59]);\n        table[15] = vec4(T[60], T[61], T[62], T[63]);\n\n        x = mod(x, 1.);\n        y = mod(y, 1.);\n        float yy = y * 4.;\n        float xx = x * 4.;\n\n        int j = int(floor(xx));\n        float jd = fract(xx);\n        int j2 = j + 1;\n        if(j2 == 4) j2 = 0;\n        \n        int i = int(floor(yy));\n        float id = fract(yy);\n        int i2 = i + 1;\n        if(i2 == 4) i2 = 0;\n\n        vec4 a = table_get(table, i,  j);\n        vec4 b = table_get(table, i,  j2);\n        // vec4 c = table_get(table, i2, j2);\n        vec4 d = table_get(table, i2, j);\n\n        vec4 X = mix(a, b, jd);\n        vec4 Y = mix(a, d, id);\n        vec4 R = (X + Y) / 2.;\n\n        return vec3(R.xyz);\n    }\n    \n    float[192] ssao_kernel = float[192](-0.09374634215485403,-0.000375369488122982,0.01754888749241413,0.017984001619785535,-0.04356818942450886,0.03569104774985324,-0.043783772268963614,-0.03428895654049228,0.06042799265745649,-0.049004574674518894,-0.06304131859385166,0.027820859347207735,-0.03586738716809315,-0.061326853471432886,0.03525915815457384,-0.06871109333104407,0.01440255699091857,0.04853617849294936,-0.07251809166741986,0.014862179462582895,0.044602699837812995,-0.004731613274647387,-0.017119952135333877,0.0010520665356540406,0.004400121280317265,0.0081662423060754,0.0024589850574472513,0.02537708481215369,0.040274072947467134,0.038324930598352736,-0.007138754764226268,0.049238945168016926,0.006914354524334151,-0.03812673535532064,0.031884808551242524,0.02335045312675197,-0.055864272680788835,-0.006359346492396586,0.0535015245616255,-0.009584547833344784,-0.011422438717361047,0.010290444556246493,0.021175210042685355,0.008931455967788389,0.011879037149721137,-0.004793906537912411,0.012239745521245257,0.13845648606007668,-0.12320928777467297,-0.03853214341372054,0.03412892884776708,-0.08198963874808374,-0.0695686376581193,0.08181684092432585,0.01823509576170111,-0.04889349713193072,0.03762078575423584,-0.032004831476432356,-0.052774232426097925,0.04569333909528465,0.0940348428347339,0.10626822873154232,0.09972482655676185,0.007802552274548907,0.005133272072566735,0.002166986454912428,0.07866566481805626,0.1552667569400362,0.07852789908155675,-0.03798069797314559,-0.0502937747707072,0.11348609067133583,-0.002146962492623746,-0.20358790691639203,0.06879590114599042,-0.11591459015942243,-0.1218945568148924,0.03321024826595269,-0.027859925696481828,0.020007218450851617,0.014431493454092136,0.052639650429022834,0.056978184034887906,0.007799340007003614,0.031220462682335793,0.16666673577793695,0.010408441481931355,-0.03762052936151246,0.03275710650902212,0.004346024772262918,-0.0130415503531828,0.06797832940740839,0.1999559866974219,-0.042058242343440556,-0.22307173108637188,0.12414794904835745,0.12561713530566443,-0.18244935949291594,0.18400526123373917,-0.16826845611664232,0.0803426684231622,0.1623067171427741,0.14300190679782254,0.1837605876166513,0.006462688612661839,0.11952513771136124,-0.3324093275082819,0.03137726320181103,-0.17258251668034924,0.011217030790295497,0.03996294616883077,0.2113137917319127,0.03779921619255335,0.07011234335317412,0.1634120795831472,-0.06457250655616936,0.11192856623922605,-0.19992681370486173,-0.3392611456024551,0.15736686389572502,0.30014044700952447,-0.02073647740507387,0.17808231831412402,-0.11875919251439018,-0.1751823944565052,0.36157555075342246,-0.3425712118794504,0.016253681339188523,0.16911073962736342,0.16933453937240683,-0.1772008093683016,0.07905365814824468,-0.21845331969168105,0.037079630424815185,0.393764176967778,-0.2086258507041632,-0.29730180456336996,0.007498636375080457,-0.002646146646925911,0.008584992115597294,0.0350626152112999,-0.09889040746774319,-0.015992421153517632,0.1328136203632947,-0.1974356421528559,0.0485295866318073,0.04025833872279758,0.32849577823378845,-0.2881668991695629,0.12646953557617205,0.20828762680152946,0.03234418544741987,0.06099372996636346,0.12544830224195277,0.0785383512646071,0.10857925036501055,-0.26441094277718147,-0.2216408863852765,0.2635546996574406,-0.17758098372840736,0.22486559143510249,0.28015606633562423,-0.21150219089628147,0.005408811711959217,0.04227624334243415,-0.15864015220389596,-0.21092533958378795,0.45207521628208824,0.09108306426946074,0.06849434139019694,0.14582484416096658,-0.48576565292941276,0.3269469461022946,0.560117393154986,-0.19101145455923585,-0.08707745185721452,0.2095832167054974,0.3330429107637653,0.4361984010525983,0.5965322553062029,0.18626542472931382,-0.13442625118145018,0.09891189581983724,-0.23747211790531572,0.302296765488922,0.243641847704324,0.0514500352700186,-0.04402159188998558,0.4888981072719507,0.0018009241897987776,0.03609386481524951,0.014861843655224498);\n\n    float ssao(float w, float h, mat4 proj, mat4 camera, sampler2D tpos, sampler2D tnormal, vec2 uv, float radius, float bias) {\n        vec2 noise_scale = vec2(w / 4., h / 4.); // noise_texture.size()\n        vec3 pos = (inverse(camera) * texture(tpos, uv)).xyz;\n        vec3 q = (mat3(transpose(camera))) * texture(tnormal, uv).xyz;\n        vec3 normal = (q.xyz);\n        float xx = mod(uv.x * noise_scale.x, 1.);\n        float yy = mod(uv.y * noise_scale.y, 1.);\n        // vec3 rvec = texture(noise, vec2(xx, yy)).xyz;\n        vec3 rvec = ssao_noise_lookup(xx, yy);\n        vec3 tangent   = normalize(rvec - normal * dot(rvec, normal));\n        vec3 bitangent = cross(normal, tangent);\n        mat3 TBN       = mat3(tangent, bitangent, normal);\n        float occlusion = 0.;\n        for(int i = 0; i < 192; i += 3) {\n            vec3 s = TBN * vec3(\n                ssao_kernel[i],\n                ssao_kernel[i + 1],\n                ssao_kernel[i + 2]\n            );\n            s = pos + s * radius; \n            vec4 offset = vec4(s, 1);\n            offset      = proj * offset;\n            offset.xyz /= offset.w;\n            offset.xyz  = offset.xyz * 0.5 + 0.5;\n            float depth = (inverse(camera) * texture(tpos, offset.xy)).z;\n            float range = smoothstep(0., 1., radius / abs(pos.z - depth));\n            occlusion += (depth >= s.z + bias? 1. : 0.) * range;\n        }  \n        occlusion = 1. - clamp(occlusion / 64., 0., 1.);\n        return occlusion;\n    }\n\n\n\n\n\n\n\n\n\n\n\n",misc="\n    float aspect(sampler2D t) {\n        ivec2 size = textureSize(t, 0);\n        return float(size.x) / float(size.y);\n    }\n\n    // mat4 quat2mat(vec4 q) {\n    //     float x2 = q.x + q.x, y2 = q.y + q.y, z2 = q.z + q.z;\n    //     float xx = q.x * x2,  xy = q.x * y2,  xz = q.x * z2;\n    //     float yy = q.y * y2,  yz = q.y * z2,  zz = q.z * z2;\n    //     float wx = q.w * x2,  wy = q.w * y2,  wz = q.w * z2;\n    //     vec3 s = vec3(1);\n    //     mat4 m = mat4(1);\n    //     m[0][0] = (1. - (yy + zz)) * s.x;\n    //     m[1][0] = (xy + wz) * s.x;\n    //     m[2][0] = (xz - wy) * s.x;\n    //     m[0][1] = (xy - wz) * s.y;\n    //     m[1][1] = (1. - (xx + zz)) * s.y;\n    //     m[2][1] = (yz + wx) * s.y;\n    //     m[0][2] = (xz + wy) * s.z;\n    //     m[1][2] = (yz - wx) * s.z;\n    //     m[2][2] = (1. - (xx + yy)) * s.z;\n    //     return transpose(m); /////////////////////////////////////////////////////////\n    // }\n    // mat4 clip_x(sampler2D s, uvec4 joints, vec4 weights, float time) {\n    //     vec4 head = texelFetch(s, ivec2(0, 0), 0);\n    //     float length = head.x;\n    //     // if(length == 0.) return mat4(1);\n    //     float fps = head.y;\n    //     int bones = int(head.z);\n    //     if(bones <= 1) return mat4(1);\n    //     float t = mod(time, length);\n    //     int frame = int(t * fps);\n    //     mat4 r = mat4(0);\n    //     int size = textureSize(s, 0).x;\n    //     for(int i = 0; i < 4; i++) {\n    //         int p = 1 + frame * bones * 2 + (int(joints[i]) + 1) * 2;\n\n    //         int x = p % size;\n    //         int y = p / size;\n    //         int x2 = (p + 1) % size;\n    //         int y2 = (p + 1) / size;\n\n\n    //         // int x = int(floor(mod(float(p), float(size))));\n    //         // int y = int(floor(   float(p) / float(size)));\n    //         // int x2 = int(floor(mod(float(p + 1), float(size))));\n    //         // int y2 = int(floor(   float(p + 1) / float(size)));\n\n\n    //         // x = p - (y * size);\n    //         vec3 a =  texelFetch(s, ivec2(x, y), 0).xyz;\n    //         vec4 aq = texelFetch(s, ivec2(x2, y2), 0);\n\n    //         // vec3 a =  texelFetch(s, ivec2(p, 0), 0).xyz;\n    //         // vec4 aq = texelFetch(s, ivec2(p + 1, 0), 0);\n    //         r += (translate(a.x, a.y, a.z) * quat2mat(aq)) * weights[i];\n    //     }\n    //     return r;\n    // }\n\n    // float texel(sampler2D s, int p) {\n    //     int channels = 4;\n    //     int width = textureSize(s, 0).x * channels;\n    //     int x = p % width;\n    //     int y = p / width;\n    //     vec4 tex = texelFetch(s, ivec2(x / channels, y), 0);\n    //     int offset = x % channels;\n    //     return tex[offset];\n    // }\n    mat4 clip_item(sampler2D s, int p, int size) {\n        int x1 = p % size;\n        int y1 = p / size;\n        int x2 = (p + 1) % size;\n        int y2 = (p + 1) / size;\n        int x3 = (p + 2) % size;\n        int y3 = (p + 2) / size;\n        int x4 = (p + 3) % size;\n        int y4 = (p + 3) / size;\n        vec4 a = texelFetch(s, ivec2(x1, y1), 0);\n        vec4 b = texelFetch(s, ivec2(x2, y2), 0);\n        vec4 c = texelFetch(s, ivec2(x3, y3), 0);\n        vec4 d = texelFetch(s, ivec2(x4, y4), 0);\n        return mat4(a, b, c, d);\n    }\n    mat4 clip(sampler2D s, uvec4 joints, vec4 weights, float time) {\n        vec4 head = texelFetch(s, ivec2(0, 0), 0);\n        float length = head.x;\n        float fps = head.y;\n        int stride = int(head.z);\n        float t = mod(time, length);\n        int frame = int(t * fps);\n        int size = textureSize(s, 0).x;\n        int p = 1 + frame * stride * 4 + 0;\n        mat4 r = clip_item(s, p, size);\n        if(stride <= 1) return r;\n        mat4 q = mat4(0);\n        for(int i = 0; i < 4; i++) {\n            int p = 1 + frame * stride * 4 + (int(joints[i]) + 1) * 4;\n            q += clip_item(s, p, size) * weights[i];\n        }\n        return r * q;\n    }\n\n// dist\n    // https://www.iquilezles.org/www/articles/intersectors/intersectors.htm\n    // https://www.geometrictools.com/Source/Distance3D.html\n    // r = 0.0025\n    // distrayseg\n    // if m is 1, returns depth\n    //    when 0, just 0 (overlap)\n    // float distrayseg(vec3 ro, vec3 rd, vec3 pa, vec3 pb, float r, float m, float none) {\n    //     vec3 ba = pb - pa;\n    //     vec3 oa = ro - pa;\n    //     float baba = dot(ba, ba);\n    //     float bard = dot(ba, rd);\n    //     float baoa = dot(ba, oa);\n    //     float rdoa = dot(rd, oa);\n    //     float oaoa = dot(oa, oa);\n    //     float a = baba        - bard * bard;\n    //     float b = baba * rdoa - baoa * bard;\n    //     float c = baba * oaoa - baoa * baoa - r * r * baba;\n    //     float h = b * b - a * c;\n    //     if(h >= 0.) {\n    //         float t = (-b - sqrt(h)) / a;\n    //         float y = baoa + t * bard;\n    //         if(y > 0. && y < baba) { // body\n    //             return t * m;\n    //         }\n    //         vec3 oc = (y <= 0.)? oa : ro - pb; // caps\n    //         b = dot(rd, oc);\n    //         c = dot(oc, oc) - r * r;\n    //         h = b * b - c;\n    //         if(h > 0.) return -b - sqrt(h);\n    //     }\n    //     return none;\n    // }\n\n    // px and py are the pivot points; (-0.5, -0.5 is top left, 0.5, 0.5 is bottom right)\n    mat4 sprite(float tw, float th, float x, float y, float w, float h, float r, float px, float py) {\n        mat4 m = ortho(-tw / 2., tw / 2., th / 2., -th / 2., 0., 1.);\n        m *= translate(x + w / 2. - tw / 2., -y - h / 2. + th / 2., 0.);\n        m *= translate(px * w, -py * h, 0.);\n        m *= rotatez(r);\n        m *= scale(w, h, 1.);\n        m *= translate(-px, py, 0.);\n        return m;                \n    }\n\n\n",blend=(t,e)=>"\n    float "+t+"_f(float Sc, float Dc) {\n        return "+e+";\n    }\n    // vec4 "+t+"(vec4 Sca, vec4 Dca) {\n    vec4 "+t+"(vec4 Dca, vec4 Sca) {\n        vec3 Sc = Sca.a == 0.? vec3(0) : Sca.rgb / Sca.a;\n        vec3 Dc = Dca.a == 0.? vec3(0) : Dca.rgb / Dca.a;\n        float Sa = Sca.a;\n        float Da = Dca.a;\n        float X = 1.;\n        float Y = 1.;\n        float Z = 1.;\n        float r = "+t+"_f(Sc.r, Dc.r) * Sa * Da + Y * Sca.r * (1.-Da) + Z * Dca.r * (1.-Sa);\n        float g = "+t+"_f(Sc.g, Dc.g) * Sa * Da + Y * Sca.g * (1.-Da) + Z * Dca.g * (1.-Sa);\n        float b = "+t+"_f(Sc.b, Dc.b) * Sa * Da + Y * Sca.b * (1.-Da) + Z * Dca.b * (1.-Sa);\n        float a = X * Sa * Da  + Y * Sa  * (1.-Da) + Z * Da  * (1.-Sa);\n        return vec4(r, g, b, a);\n    }\n",blendmodes="\n    "+blend("blend","Sc")+"\n    // dissolve\n    "+blend("darken","min(Sc, Dc)")+"\n    "+blend("multiply","Sc * Dc")+"\n    "+blend("colorburn","(Sc == 0.)? 0. : 1. - min(1., (1. - Dc) / Sc)")+"\n    "+blend("linearburn","max(Dc + Sc - 1., 0.)")+"\n    // darker color\n    "+blend("lighten","max(Sc, Dc)")+"\n    "+blend("screen","Sc + Dc - (Sc * Dc)")+"\n    "+blend("colordodge","(Sc == 1.)? 1. : min(1., Dc / (1. - Sc))")+"\n    "+blend("addition","Sc + Dc")+" // linear dodge\n    // lighter color\n    "+blend("overlay","\n        (2. * Dc <= 1.)?\n            2. * Sc * Dc\n        :\n            1. - 2. * (1. - Dc) * (1. - Sc)\n    ")+"\n    "+blend("softlight","\n        (2. * Sc <= 1.)?\n            Dc - (1. - 2. * Sc) * Dc * (1. - Dc)\n        : (2. * Sc > 1. && 4. * Dc <= 1.)?\n            Dc + (2. * Sc - 1.) * (4. * Dc * (4. * Dc + 1.) * (Dc - 1.) + 7. * Dc)\n        :\n            Dc + (2. * Sc - 1.) * (pow(Dc, 0.5) - Dc)")+"\n    "+blend("hardlight","(2. * Sc <= 1.)? 2. * Sc * Dc : 1. - 2. * (1. - Dc) * (1. - Sc)")+"\n    // vividlight\n    // linearlight\n    // pinlight\n    // hardmix\n    "+blend("difference","abs(Dc - Sc)")+"\n    "+blend("exclusion","Sc + Dc - 2. * Sc * Dc")+"\n    "+blend("subtract","Dc - Sc")+"\n    // divide\n    // hue\n    // saturation\n    // color\n    // luminosity\n",ETC="\n    // vec3[2] ray(mat4 proj, mat4 camera, vec2 uv) {\n    //     proj[2][2] = -1.;\n    //     proj[3][2] = -1.;\n    //     vec3 ro = position(camera);\n    //     vec4 ndc = vec4(uv * 2. - 1., 1., 1.);\n    //     vec3 rd = normalize((camera * inverse(proj) * ndc).xyz);\n    //     return vec3[2](ro, rd);\n    // }\n\n    // // i is image, s screen\n    // vec2 uvfit(vec2 uv, float i, float s) {\n    //     uv -= 0.5;\n    //     if(s > i) uv.x = s * uv.x / i;\n    //     else      uv.y = (1. / s) * uv.y / (1. / i);\n    //     uv += 0.5;\n    //     return uv;\n    // }\n    // vec2 uvscale(vec2 uv, float n) {\n    //     uv -= 0.5;\n    //     uv *= 1. / n;\n    //     uv += 0.5;\n    //     return uv;\n    // }\n\n    vec2 mirror(vec2 uv) {\n        uv.x = mod(uv.x, 2.);\n        uv.y = mod(uv.y, 2.);\n        if(uv.x > 1.) uv.x = 1. - (uv.x - 1.);\n        if(uv.y > 1.) uv.y = 1. - (uv.y - 1.);\n        return uv;\n    }\n\n    // float disp(sampler2D disp, vec2 uv, float time, float scale) {\n    //     uv *= scale;\n    //     uv += time;\n    //     return textureLod(disp, mirror(uv), 0.).x;\n    // }\n\n    float vnoise_F(vec2 p) {\n        #define rand(f) fract(sin(f) * 10000.)   \n        #define rand2d(x, y) rand(x + y * 100.)    // OG 10000.\n        float sw = rand2d(floor(p.x), floor(p.y));\n        float se = rand2d(ceil(p.x),  floor(p.y));\n        float nw = rand2d(floor(p.x), ceil(p.y));\n        float ne = rand2d(ceil(p.x),  ceil(p.y));\n        #undef rand\n        #undef rand2d\n        vec2 inter = smoothstep(0., 1., fract(p));\n        float s = mix(sw, se, inter.x);\n        float n = mix(nw, ne, inter.x);\n        return mix(s, n, inter.y);\n    }\n    // float fbm(vec2 p) {\n    //     float total = 0.0;\n    //     total += vnoise_F(p);\n    //     total += vnoise_F(p * 2.) / 2.;\n    //     total += vnoise_F(p * 4.) / 4.;\n    //     total += vnoise_F(p * 8.) / 8.;\n    //     total += vnoise_F(p * 16.) / 16.;\n    //     total /= 1. + 1./2. + 1./4. + 1./8. + 1./16.;\n    //     return total;\n    // }\n    float vnoise(vec2 p, int octs) {\n        float total = 0.;\n        float div = 0.;\n        for(int i = 0; i < octs; i++) {\n            float mul = pow(2., float(i));\n            total += vnoise_F(p * mul) / mul;\n            div += 1. / mul;\n        }\n        return total / div;\n    }\n\n\n",shaderlib="\n    "+math+"\n    "+matrices+"\n    "+lights+"\n    "+surface+"\n    "+particles+"\n    "+color+"\n    "+filters+"\n    "+misc+"\n    "+blendmodes+"\n    "+ETC+"\n",shadertag="//// code",shader=(t,e)=>{let r=prefix,i=t+(t.includes(" vertex(")?"":"\n        mat4 vertex(vx a) {\n            return orthoquad;\n        }    \n    "),n=2==(i.includes("mat4 vertex(")?1:i.includes("mat4[3] vertex(")?2:0),s=i.includes("vec4 pixel(")?1:i.includes("vec4[2] pixel(")?2:i.includes("vec4[3] pixel(")?3:i.includes("vec4[4] pixel(")?4:i.includes("vec5 pixel(")?5:0,a=e.map((([t,e])=>"uniform "+e+" "+r+t+";")).join("\n"),o=e.map((([t,e])=>"sampler2D"===e?"":e+" "+t+";")).join("\n"),h=e.map((([t,e])=>"sampler2D"===e?"":", "+r+t)).join(""),c=e.map((([t,e])=>"sampler2D"===e?t:"")).filter((t=>t)).join("|"),l=new RegExp("(^|\\W)(v|p|a)\\.("+c+")(\\W|$)","g");i=i.replace(l,((t,e,i,n,s)=>e+r+n+s));let u="#version 300 es\n        precision highp float;\n        precision highp int;\n        "+shaderlib+"\n        "+shadertag+"\n        "+a+"\n        struct vx {\n            int instance;\n            uvec4 joints;\n            vec4 weights;\n            "+o+"\n        };\n        struct px {\n            int instance;\n            vec2 uv;\n            bool front;\n            float depth;\n            ivec2 st;\n            "+(n?"\n                vec3 pos;\n                float posw;\n                vec3 normal;\n                // vec3 vpos;\n                // vec3 vnormal;\n                mat3 tbn;\n                vec3 eye;":"")+"\n            "+o+"\n        };\n        struct vec5 { vec4 _v4; float _f; };\n        // f -> nowrite\n    ";return[u+"\n        #define discard 0.\n        "+i+"\n        layout(location=0) in  vec4 a_pos;\n        layout(location=1) in  vec2 a_uv;\n        layout(location=2) in  vec3 a_normal;\n        layout(location=3) in  vec4 a_tangent;\n        layout(location=4) in uvec4 a_joints;\n        layout(location=5) in  vec4 a_weights;\n        out vec4 v_pos;\n        out vec2 v_uv;\n        out vec3 v_normal;\n        out vec3 v_tangent;\n        out vec3 v_bitangent;\n        \n        // out vec4 v_vpos;\n        // out vec3 v_vnormal;\n\n        flat out vec3 v_eye;\n        flat out int  v_instance;\n        void main()\t{\n            vx args = vx(\n                gl_InstanceID,\n                a_joints,\n                a_weights\n                "+h+"\n            );            \n            mat4 m = mat4(1);\n            mat4 v = mat4(1);\n            mat4 p = mat4(1);\n            "+(n?"\n                mat4[3] pvm = vertex(args);\n                p = pvm[0];\n                v = pvm[1];\n                m = pvm[2];":"\n                m = vertex(args);\n            ")+"\n            gl_Position = (p * v * m) * a_pos;\n            v_uv = a_uv;\n            v_instance = gl_InstanceID;\n            "+(n?"\n                v_pos = m * a_pos;\n                // v_vpos = (v * m) * a_pos;\n\n                mat3 nm = mat3(transpose(inverse(m)));\n                v_normal = normalize(nm * a_normal);\n\n                // mat3 vnm = mat3(transpose(inverse(v * m)));\n                // v_vnormal = normalize(vnm * a_normal);\n\n                v_tangent = normalize(nm * a_tangent.xyz);\n                v_bitangent = normalize(cross(v_normal, v_tangent) * a_tangent.w);\n                v_eye = position(inverse(v));":"")+"\n        }",u+"\n        "+i+`\n        in vec4 v_pos;\n        in vec2 v_uv;\n        in vec3 v_normal;\n        in vec3 v_tangent;\n        in vec3 v_bitangent;\n\n        // in vec4 v_vpos;\n        // in vec3 v_vnormal;\n\n        flat in vec3 v_eye;\n        flat in int v_instance;\n        out vec4[${4===s?"4":3===s?"3":2===s?"2":"1"}] color; // resizes?\n        void main() {\n            vec3 normal = normalize(v_normal);\n            vec3 tangent = normalize(v_tangent);\n            vec3 bitangent = normalize(v_bitangent);\n            // vec3 vnormal = normalize(v_vnormal);\n            px args = px(\n                v_instance,\n                v_uv,\n                gl_FrontFacing,\n                gl_FragCoord.z,\n                ivec2(gl_FragCoord.xy)\n                // 1.0 - (gl_FragCoord.z / gl_FragCoord.w) / 10000.\n                `+(n?",\n                    v_pos.xyz,\n                    v_pos.w,\n                    normal,\n                    // v_vpos.xyz,\n                    // vnormal,\n                    mat3(tangent, bitangent, normal),\n                    v_eye":"")+"\n                "+h+"\n            );\n            "+(1==s?"\n                vec4 c = pixel(args);\n                color[0] = c;\n            ":2==s?"\n                vec4[2] c = pixel(args);\n                color[0] = c[0];\n                color[1] = c[1];\n            ":3==s?"\n                vec4[3] c = pixel(args);\n                color[0] = c[0];\n                color[1] = c[1];\n                color[2] = c[2];\n            ":4==s?"\n                vec4[4] c = pixel(args);\n                color[0] = c[0];\n                color[1] = c[1];\n                color[2] = c[2];\n                color[3] = c[3];\n            ":5==s?"\n                vec5 c = pixel(args);\n                color[0] = c._v4;\n                gl_FragDepth = c._f;\n            ":0==s?"\n                color[0] = vec4(0);\n            ":(()=>{throw s})())+"\n        }"]};class PeakMesh extends Mesh{vao;constructor(t,e){super(t.free),this.vao=e}}class PeakTexture extends Texture$2{tex;constructor(t,e){super(t.width,t.height,t.set,t.free),this.tex=e}}class DefaultFramebuffer{}class Peak{width;height;mesh;program;texture;fbo;clear;blit;draw;free;constructor(t,e,r,i,n,s,a,o,h,c){this.width=t,this.height=e,this.mesh=r,this.program=i,this.texture=n,this.fbo=s,this.clear=a,this.blit=o,this.draw=h,this.free=c}static struct=t=>new Peak(t.width,t.height,t.mesh,t.program,t.texture,t.fbo,t.clear,t.blit,t.draw,t.free)}class State{app;drawcalls;constructor(t,e){this.app=t,this.drawcalls=e}static struct=t=>new State(t.app,t.drawcalls)}let Mesh_struct=t=>new Mesh(t.free),Texture_struct$1=t=>new Texture$2(t.width,t.height,t.set,t.free);const width=t=>()=>t.app.width,height=t=>()=>t.app.height,mesh=t=>e=>{let r=[],i=(e,i,n,s,a,o)=>{let h=t.app.createVertexBuffer(n,s,a);r.push(h);let c=o?Object.fromEntries([["integer",PicoGL.VERTEX_ATTRIB_ARRAY_INTEGER]]):void 0;return e.vertexAttributeBuffer(i,h,c)},n=PicoGL.UNSIGNED_INT,s=PicoGL.FLOAT,a=t.app.createVertexArray(),o=t.app.createIndexBuffer(n,3,e.indices);r.push(o),a.indexBuffer(o),i(a,0,s,3,e.positions,!1),i(a,1,s,2,e.uvs,!1),i(a,2,s,3,e.normals,!1),i(a,3,s,4,e.tangents,!1),i(a,4,n,4,e.joints,!0),i(a,5,s,4,e.weights,!1);let h=Mesh_struct({free:()=>(r.forEach((t=>t.delete())),r=[],Array.from(t.drawcalls.entries()).forEach((t=>(t[0],t[1].delete(a)))),a.delete())});return new PeakMesh(h,a)},program=t=>(e,r)=>t.app.createProgram(e,r),texture=t=>(e,r,i,n,s,a,o)=>{let h=t=>{if("clamp"===t)return PicoGL.CLAMP_TO_EDGE;if("repeat"===t)return PicoGL.REPEAT;if("mirror"===t)return PicoGL.MIRRORED_REPEAT;throw t},c=e.constructor===Float32Array?PicoGL.RGBA32F:PicoGL.RGBA8,l=[["internalFormat",c],["minFilter",PicoGL.NEAREST],["magFilter",PicoGL.NEAREST],["wrapS",h(a)],["wrapT",h(o)]],u=[["internalFormat",c],["premultiplyAlpha",!0],["maxAnisotropy",PicoGL.WEBGL_INFO.MAX_TEXTURE_ANISOTROPY],["flipY",s],["wrapS",h(a)],["wrapT",h(o)]],d=n?l:u,p=(()=>{if(e instanceof ImageBitmap&&s){let t=document.createElement("canvas");t.width=e.width,t.height=e.height,t.getContext("2d")?.drawImage(e,0,0,t.width,t.height),e=t}return e instanceof HTMLImageElement||e instanceof HTMLCanvasElement?t.app.createTexture2D(e,Object.fromEntries(d)):t.app.createTexture2D(e,r,i,Object.fromEntries(d))})(),_=Texture_struct$1({width:()=>r,height:()=>i,set:t=>p.data(t),free:()=>p.delete()});return new PeakTexture(_,p)},fbo=t=>(e,r,i,n,s)=>{let a=(e,r,i)=>t.app.createRenderbuffer(e,r,i,PicoGL.WEBGL_INFO.SAMPLES),o=t.app.createFramebuffer();if(n){let n=PicoGL.DEPTH_COMPONENT32F,s=Object.fromEntries([["internalFormat",n]]),h=i?a(e,r,n):t.app.createTexture2D(e,r,s);o.depthTarget(h)}return s.forEach(((n,s)=>{let h="rgba32f"===n?PicoGL.RGBA32F:PicoGL.RGBA8,c=[["internalFormat",h],["premultiplyAlpha",!0],["flipY",!0],["wrapS",PicoGL.CLAMP_TO_EDGE],["wrapT",PicoGL.CLAMP_TO_EDGE],["maxAnisotropy",PicoGL.WEBGL_INFO.MAX_TEXTURE_ANISOTROPY]],l=i?a(e,r,h):t.app.createTexture2D(e,r,Object.fromEntries(c));return o.colorTarget(s,l)})),o},clear=t=>(e,r,i)=>{let n=PicoGL.STENCIL_BUFFER_BIT;return r&&(n|=PicoGL.COLOR_BUFFER_BIT),i&&(n|=PicoGL.DEPTH_BUFFER_BIT),t.app.clearBits=n,t.app.depthMask(!0),e instanceof DefaultFramebuffer?t.app.defaultDrawFramebuffer():t.app.drawFramebuffer(e),t.app.clearColor(0,0,0,0).clear()},blit=t=>(e,r,i,n)=>{e instanceof DefaultFramebuffer?t.app.defaultDrawFramebuffer():t.app.drawFramebuffer(e),r instanceof DefaultFramebuffer?t.app.defaultReadFramebuffer():t.app.readFramebuffer(r);let s=0;return i&&(s|=PicoGL.COLOR_BUFFER_BIT),n&&(s|=PicoGL.DEPTH_BUFFER_BIT),t.app.depthMask(!0),t.app.blitFramebuffer(s)},draw=t=>(e,r,i,n,s,a,o,h,c,l,u)=>{let d=mapget(t.drawcalls,i,(()=>new Map)),p=mapget(d,r.vao,(()=>t.app.createDrawCall(i,r.vao)));r.vao.numInstances=s,p.numInstances[0]=s;let _=Object.keys(i.uniforms),m=Object.keys(i.samplers);n.forEach(((t,e)=>{(t=>_.includes(t)||m.includes(t))(prefix+e)&&(t instanceof PeakTexture?p.texture(prefix+e,t.tex):t instanceof UniformFloat?p.uniform(prefix+e,t.f):t instanceof UniformInt?p.uniform(prefix+e,t.i):t instanceof UniformArray?p.uniform(prefix+e,t.value):"number"!=typeof t||p.uniform(prefix+e,t))})),t.app.viewport(0,0,l,u),a?t.app.depthTest():t.app.noDepthTest(),t.app.depthFunc(PicoGL.LEQUAL),t.app.depthMask(o);let f=PicoGL.ONE,E=PicoGL.ONE_MINUS_SRC_ALPHA,T=PicoGL.DST_COLOR,g=PicoGL.ONE_MINUS_SRC_COLOR;return t.app.blend(),"normal"===h&&t.app.blendFuncSeparate(f,E,f,E),"add"===h&&t.app.blendFuncSeparate(f,f,f,f),"multiply"===h&&t.app.blendFuncSeparate(T,E,f,E),"screen"===h&&t.app.blendFuncSeparate(f,g,f,E),"none"===c?t.app.drawBackfaces():(t.app.cullBackfaces(),"back"===c&&t.app.gl.cullFace(PicoGL.BACK),"front"===c&&t.app.gl.cullFace(PicoGL.FRONT),"both"===c&&t.app.gl.cullFace(PicoGL.FRONT_AND_BACK)),e instanceof DefaultFramebuffer?t.app.defaultDrawFramebuffer():t.app.drawFramebuffer(e),p.draw()},free=t=>()=>t.drawcalls=new Map,peak=t=>{let e=PicoGL.createApp(t,Object.fromEntries([["alpha",!0],["antialias",!0],["depth",!1],["stencil",!1],["premultipliedAlpha",!0]])),r=new State(e,new Map);return new Peak(width(r),height(r),mesh(r),program(r),texture(r),fbo(r),clear(r),blit(r),draw(r),free(r))};class MSAANone{constructor(){}static struct=t=>new MSAANone}let GFX_struct=t=>new GFX(t.width,t.height,t.mesh,t.buffer,t.texture,t.flush,t.free),Buffer_struct=t=>new Buffer(t.width,t.height,t.draw,t.clear,t.color,t.depth,t.free),Texture_struct=t=>new Texture$2(t.width,t.height,t.set,t.free),u32=Uint32Array,f32=Float32Array,quad_mesh=new MeshData(new u32([0,2,1,2,3,1]),new f32([-.5,.5,0,.5,.5,0,-.5,-.5,0,.5,-.5,0]),new f32([0,1,1,1,0,0,1,0]),new f32([0,0,1,0,0,1,0,0,1,0,0,1]),new f32([1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1]),new u32([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),new f32([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));const gfx=t=>{let e=peak(t),r=e.mesh(quad_mesh),i=new Map,n=(t,n,s,a)=>{let o=a.mesh??r,h=a.shader??"",c=a.uniforms??new Array,l=a.instances??1,u=a.depth??!1,d=a.mask??!0,p=a.blend??"normal",_=a.cull??"back";(a.clear??!1)&&e.clear(t,!0,!0),c.push(["aspect",new UniformFloat(n/s)]),c.push(["instances",new UniformInt(l)]);let m=[];c.forEach((([t,e])=>{let r=(()=>{if(e instanceof Texture$2)return"sampler2D";if(e instanceof UniformFloat)return"float";if(e instanceof UniformInt)return"int";if(e instanceof UniformArray)return e.type;if("number"==typeof e)return"float";throw new Error})();return m.push([t,r])}));let f=m.flat().join(","),E=mapget(i,f+h,(()=>{let t=shader(h,m);return e.program(t[0],t[1])}));o instanceof PeakMesh&&e.draw(t,o,E,new Map(c),l,u,d,p,_,n,s)};return GFX_struct({free:()=>(e.free(),r.free(),Array.from(i.values()).forEach((t=>t.delete())),i=new Map),width:()=>e.width(),height:()=>e.height(),flush:t=>n(new DefaultFramebuffer,e.width(),e.height(),{clear:!0,uniforms:[["buf",t.color()]],shader:"\n                vec4 pixel(px p) {\n                    return texture(p.buf, p.uv);\n                }\n            "}),mesh:t=>e.mesh(t),texture:(t,r)=>{let i=t instanceof Float32Array,n=!i,s=-1,a=-1;if(t instanceof HTMLVideoElement&&(s=t.videoWidth,a=t.videoHeight),t instanceof Float32Array){let e=Math.ceil(Math.sqrt(t.length/4)),r=new Float32Array(e*e*4);r.set(t,0),t=r,s=e,a=e}t instanceof HTMLCanvasElement&&(s=t.width,a=t.height),t instanceof HTMLImageElement&&(s=t.width,a=t.height),t instanceof ImageBitmap&&(s=t.width,a=t.height),t instanceof OffscreenCanvas&&(s=t.width,a=t.height);let o=r?.width??s,h=r?.height??a,c=r?.flip??n,l=r?.wraps??"clamp",u=r?.wrapt??"clamp";if(-1===o||-1===h)throw s;return e.texture(t,o,h,i,c,l,u)},buffer:t=>{let r=t?.width??e.width(),i=t?.height??e.height(),s=t?.msaa??!1,a=t?.depth??!1,o=t?.colors??["rgba8"],h=e.fbo(r,i,!1,a,o),c=new MSAANone;s&&(c=e.fbo(r,i,!0,a,o),e.clear(c,!0,!0)),e.clear(h,!0,!0);let l=!1,u=()=>{c instanceof MSAANone||!1===l&&(e.blit(h,c,!0,!0),l=!0)},d=t=>{let e=Texture_struct({width:()=>t.width,height:()=>t.height,set:e=>{throw t},free:()=>{throw t}});return new PeakTexture(e,t)};return Buffer_struct({free:()=>{let t=t=>(t.depthAttachment&&t.depthAttachment.delete(),t.colorAttachments.forEach((t=>t.delete())),t.delete());t(h),c instanceof MSAANone==!1&&c instanceof DefaultFramebuffer==!1&&t(c)},width:()=>r,height:()=>i,color:(t=0)=>(u(),d(h.colorAttachments[t])),depth:()=>(u(),d(h.depthAttachment)),clear:(t=!0,r=!0)=>(l=!0,c instanceof MSAANone==!1&&e.clear(c,t,r),e.clear(h,t,r)),draw:t=>{l=!1,n(c instanceof MSAANone==!1?c:h,r,i,t)}})}})};let fitrect=(t,e,r,i)=>{let n=t/e>=r/i?r/t:i/e;return[t*n,e*n]};class Events{keys;ptrs;clicks;constructor(t,e,r){this.keys=t,this.ptrs=e,this.clicks=r}}class KeyEvent{time;mods;action;code;key;constructor(t,e,r,i,n){this.time=t,this.mods=e,this.action=r,this.code=i,this.key=n}}class PtrEvent{time;mods;action;device;id;x;y;button;buttons;pressure;constructor(t,e,r,i,n,s,a,o,h,c){this.time=t,this.mods=e,this.action=r,this.device=i,this.id=n,this.x=s,this.y=a,this.button=o,this.buttons=h,this.pressure=c}}class ClickEvent{time;mods;x;y;double;constructor(t,e,r,i,n){this.time=t,this.mods=e,this.x=r,this.y=i,this.double=n}}const key_event=(t,e)=>new KeyEvent(Date.now(),[],e,t.code,t.key),ptr_event=(t,e,r)=>{let i=t.pointerType,n=t.pointerId,s=r.getBoundingClientRect(),a=(t.x-s.x)/s.width,o=(t.y-s.y)/s.height;return new PtrEvent(Date.now(),[],e,i,n,a,o,t.button,[],t.pressure)},click_event=(t,e,r)=>{let i=r.getBoundingClientRect(),n=(t.x-i.x)/i.width,s=(t.y-i.y)/i.height;return new ClickEvent(Date.now(),[],n,s,e)},events=(t,e,r)=>{let i=new Map,n=[],s=[],a=[];return t.addEventListener("keydown",(t=>{i.has(t.code)||(n.push(key_event(t,"down")),i.set(t.code,!0))})),t.addEventListener("keyup",(t=>{n.push(key_event(t,"up")),i.delete(t.code)})),e.addEventListener("pointerdown",(t=>s.push(ptr_event(t,"down",r)))),e.addEventListener("pointerup",(t=>s.push(ptr_event(t,"up",r)))),e.addEventListener("pointermove",(t=>s.push(ptr_event(t,"move",r)))),e.addEventListener("click",(t=>a.push(click_event(t,!1,r)))),e.addEventListener("dblclick",(t=>a.push(click_event(t,!0,r)))),()=>{let t=new Events(n,s,a);return n=[],s=[],a=[],t}};class Input{time;delta;key;keys;ptrs;clicks;constructor(t,e,r,i,n,s){this.time=t,this.delta=e,this.key=r,this.keys=i,this.ptrs=n,this.clicks=s}}const keystate=(t,e)=>{e.forEach((e=>{"down"===e.action&&t.set(e.code,!0),"up"===e.action&&t.set(e.code,!1)}))},ticker=(t,e,r,i,n,s)=>{let a=0,o=Date.now(),h=o,c=events(t,e,r),l=new Map,u=async()=>{let t=Date.now(),e=.001*(t-o),n=.001*(t-h);h=t,a+=1;let d=c();keystate(l,d.keys);let p=new Input(e,n,(t=>!!l.get(t)),d.keys,d.ptrs,d.clicks),_=await i(p);r.getContext("2d")?.drawImage(s,0,0),!1!==_&&requestAnimationFrame(u)};u(),setInterval((()=>{console.log(a),a=0}),1e3)},run=async(t,e)=>{document.body.style.display="flex",document.body.style.justifyContent="center",document.body.style.alignItems="center",document.body.style.height="100vh",document.body.style.margin="0",document.body.style.backgroundColor="black";let r=document.createElement("canvas");document.body.append(r);let i=document.createElement("canvas"),n=await t(e,((t,e)=>{i.width=t,i.height=e,r.width=t,r.height=e,r.style.position="absolute";let n=()=>{let[i,n]=fitrect(t,e,window.innerWidth,window.innerHeight);r.style.width=i+"px",r.style.height=n+"px"};return window.onresize=n,n(),i}));n&&ticker(window,document,r,n,0,i)},REVISION="166",UVMapping=300,RepeatWrapping=1e3,ClampToEdgeWrapping=1001,MirroredRepeatWrapping=1002,LinearFilter=1006,LinearMipmapLinearFilter=1008,UnsignedByteType=1009,FloatType=1015,RGBAFormat=1023,NoColorSpace="",StaticDrawUsage=35044,WebGLCoordinateSystem=2e3,WebGPUCoordinateSystem=2001;class EventDispatcher{addEventListener(t,e){void 0===this._listeners&&(this._listeners={});const r=this._listeners;void 0===r[t]&&(r[t]=[]),-1===r[t].indexOf(e)&&r[t].push(e)}hasEventListener(t,e){if(void 0===this._listeners)return!1;const r=this._listeners;return void 0!==r[t]&&-1!==r[t].indexOf(e)}removeEventListener(t,e){if(void 0===this._listeners)return;const r=this._listeners[t];if(void 0!==r){const t=r.indexOf(e);-1!==t&&r.splice(t,1)}}dispatchEvent(t){if(void 0===this._listeners)return;const e=this._listeners[t.type];if(void 0!==e){t.target=this;const r=e.slice(0);for(let e=0,i=r.length;e<i;e++)r[e].call(this,t);t.target=null}}}const _lut=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];function generateUUID(){const t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,r=4294967295*Math.random()|0,i=4294967295*Math.random()|0;return(_lut[255&t]+_lut[t>>8&255]+_lut[t>>16&255]+_lut[t>>24&255]+"-"+_lut[255&e]+_lut[e>>8&255]+"-"+_lut[e>>16&15|64]+_lut[e>>24&255]+"-"+_lut[63&r|128]+_lut[r>>8&255]+"-"+_lut[r>>16&255]+_lut[r>>24&255]+_lut[255&i]+_lut[i>>8&255]+_lut[i>>16&255]+_lut[i>>24&255]).toLowerCase()}function clamp(t,e,r){return Math.max(e,Math.min(r,t))}function denormalize(t,e){switch(e.constructor){case Float32Array:return t;case Uint32Array:return t/4294967295;case Uint16Array:return t/65535;case Uint8Array:return t/255;case Int32Array:return Math.max(t/2147483647,-1);case Int16Array:return Math.max(t/32767,-1);case Int8Array:return Math.max(t/127,-1);default:throw new Error("Invalid component type.")}}function normalize(t,e){switch(e.constructor){case Float32Array:return t;case Uint32Array:return Math.round(4294967295*t);case Uint16Array:return Math.round(65535*t);case Uint8Array:return Math.round(255*t);case Int32Array:return Math.round(2147483647*t);case Int16Array:return Math.round(32767*t);case Int8Array:return Math.round(127*t);default:throw new Error("Invalid component type.")}}class Vector2{constructor(t=0,e=0){Vector2.prototype.isVector2=!0,this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){const e=this.x,r=this.y,i=t.elements;return this.x=i[0]*e+i[3]*r+i[6],this.y=i[1]*e+i[4]*r+i[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this}clampLength(t,e){const r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(t,Math.min(e,r)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const r=this.dot(t)/e;return Math.acos(clamp(r,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,r=this.y-t.y;return e*e+r*r}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,r){return this.x=t.x+(e.x-t.x)*r,this.y=t.y+(e.y-t.y)*r,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){const r=Math.cos(e),i=Math.sin(e),n=this.x-t.x,s=this.y-t.y;return this.x=n*r-s*i+t.x,this.y=n*i+s*r+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class Matrix3{constructor(t,e,r,i,n,s,a,o,h){Matrix3.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==t&&this.set(t,e,r,i,n,s,a,o,h)}set(t,e,r,i,n,s,a,o,h){const c=this.elements;return c[0]=t,c[1]=i,c[2]=a,c[3]=e,c[4]=n,c[5]=o,c[6]=r,c[7]=s,c[8]=h,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(t){const e=this.elements,r=t.elements;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],this}extractBasis(t,e,r){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),r.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const r=t.elements,i=e.elements,n=this.elements,s=r[0],a=r[3],o=r[6],h=r[1],c=r[4],l=r[7],u=r[2],d=r[5],p=r[8],_=i[0],m=i[3],f=i[6],E=i[1],T=i[4],g=i[7],y=i[2],R=i[5],x=i[8];return n[0]=s*_+a*E+o*y,n[3]=s*m+a*T+o*R,n[6]=s*f+a*g+o*x,n[1]=h*_+c*E+l*y,n[4]=h*m+c*T+l*R,n[7]=h*f+c*g+l*x,n[2]=u*_+d*E+p*y,n[5]=u*m+d*T+p*R,n[8]=u*f+d*g+p*x,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],r=t[1],i=t[2],n=t[3],s=t[4],a=t[5],o=t[6],h=t[7],c=t[8];return e*s*c-e*a*h-r*n*c+r*a*o+i*n*h-i*s*o}invert(){const t=this.elements,e=t[0],r=t[1],i=t[2],n=t[3],s=t[4],a=t[5],o=t[6],h=t[7],c=t[8],l=c*s-a*h,u=a*o-c*n,d=h*n-s*o,p=e*l+r*u+i*d;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);const _=1/p;return t[0]=l*_,t[1]=(i*h-c*r)*_,t[2]=(a*r-i*s)*_,t[3]=u*_,t[4]=(c*e-i*o)*_,t[5]=(i*n-a*e)*_,t[6]=d*_,t[7]=(r*o-h*e)*_,t[8]=(s*e-r*n)*_,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).invert().transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,r,i,n,s,a){const o=Math.cos(n),h=Math.sin(n);return this.set(r*o,r*h,-r*(o*s+h*a)+s+t,-i*h,i*o,-i*(-h*s+o*a)+a+e,0,0,1),this}scale(t,e){return this.premultiply(_m3.makeScale(t,e)),this}rotate(t){return this.premultiply(_m3.makeRotation(-t)),this}translate(t,e){return this.premultiply(_m3.makeTranslation(t,e)),this}makeTranslation(t,e){return t.isVector2?this.set(1,0,t.x,0,1,t.y,0,0,1):this.set(1,0,t,0,1,e,0,0,1),this}makeRotation(t){const e=Math.cos(t),r=Math.sin(t);return this.set(e,-r,0,r,e,0,0,0,1),this}makeScale(t,e){return this.set(t,0,0,0,e,0,0,0,1),this}equals(t){const e=this.elements,r=t.elements;for(let t=0;t<9;t++)if(e[t]!==r[t])return!1;return!0}fromArray(t,e=0){for(let r=0;r<9;r++)this.elements[r]=t[r+e];return this}toArray(t=[],e=0){const r=this.elements;return t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8],t}clone(){return(new this.constructor).fromArray(this.elements)}}const _m3=new Matrix3;function arrayNeedsUint32(t){for(let e=t.length-1;e>=0;--e)if(t[e]>=65535)return!0;return!1}function createElementNS(t){return document.createElementNS("http://www.w3.org/1999/xhtml",t)}const _cache={};function warnOnce(t){t in _cache||(_cache[t]=!0,console.warn(t))}function SRGBToLinear(t){return t<.04045?.0773993808*t:Math.pow(.9478672986*t+.0521327014,2.4)}let _canvas;class ImageUtils{static getDataURL(t){if(/^data:/i.test(t.src))return t.src;if("undefined"==typeof HTMLCanvasElement)return t.src;let e;if(t instanceof HTMLCanvasElement)e=t;else{void 0===_canvas&&(_canvas=createElementNS("canvas")),_canvas.width=t.width,_canvas.height=t.height;const r=_canvas.getContext("2d");t instanceof ImageData?r.putImageData(t,0,0):r.drawImage(t,0,0,t.width,t.height),e=_canvas}return e.width>2048||e.height>2048?(console.warn("THREE.ImageUtils.getDataURL: Image converted to jpg for performance reasons",t),e.toDataURL("image/jpeg",.6)):e.toDataURL("image/png")}static sRGBToLinear(t){if("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap){const e=createElementNS("canvas");e.width=t.width,e.height=t.height;const r=e.getContext("2d");r.drawImage(t,0,0,t.width,t.height);const i=r.getImageData(0,0,t.width,t.height),n=i.data;for(let t=0;t<n.length;t++)n[t]=255*SRGBToLinear(n[t]/255);return r.putImageData(i,0,0),e}if(t.data){const e=t.data.slice(0);for(let t=0;t<e.length;t++)e instanceof Uint8Array||e instanceof Uint8ClampedArray?e[t]=Math.floor(255*SRGBToLinear(e[t]/255)):e[t]=SRGBToLinear(e[t]);return{data:e,width:t.width,height:t.height}}return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),t}}let _sourceId=0;class Source{constructor(t=null){this.isSource=!0,Object.defineProperty(this,"id",{value:_sourceId++}),this.uuid=generateUUID(),this.data=t,this.dataReady=!0,this.version=0}set needsUpdate(t){!0===t&&this.version++}toJSON(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.images[this.uuid])return t.images[this.uuid];const r={uuid:this.uuid,url:""},i=this.data;if(null!==i){let t;if(Array.isArray(i)){t=[];for(let e=0,r=i.length;e<r;e++)i[e].isDataTexture?t.push(serializeImage(i[e].image)):t.push(serializeImage(i[e]))}else t=serializeImage(i);r.url=t}return e||(t.images[this.uuid]=r),r}}function serializeImage(t){return"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap?ImageUtils.getDataURL(t):t.data?{data:Array.from(t.data),width:t.width,height:t.height,type:t.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let _textureId=0;class Texture extends EventDispatcher{constructor(t=Texture.DEFAULT_IMAGE,e=Texture.DEFAULT_MAPPING,r=1001,i=1001,n=1006,s=1008,a=1023,o=1009,h=Texture.DEFAULT_ANISOTROPY,c=""){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:_textureId++}),this.uuid=generateUUID(),this.name="",this.source=new Source(t),this.mipmaps=[],this.mapping=e,this.channel=0,this.wrapS=r,this.wrapT=i,this.magFilter=n,this.minFilter=s,this.anisotropy=h,this.format=a,this.internalFormat=null,this.type=o,this.offset=new Vector2(0,0),this.repeat=new Vector2(1,1),this.center=new Vector2(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new Matrix3,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=c,this.userData={},this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1,this.pmremVersion=0}get image(){return this.source.data}set image(t=null){this.source.data=t}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return(new this.constructor).copy(this)}copy(t){return this.name=t.name,this.source=t.source,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.channel=t.channel,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.internalFormat=t.internalFormat,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.colorSpace=t.colorSpace,this.userData=JSON.parse(JSON.stringify(t.userData)),this.needsUpdate=!0,this}toJSON(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.textures[this.uuid])return t.textures[this.uuid];const r={metadata:{version:4.6,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(t).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(r.userData=this.userData),e||(t.textures[this.uuid]=r),r}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(t){if(300!==this.mapping)return t;if(t.applyMatrix3(this.matrix),t.x<0||t.x>1)switch(this.wrapS){case 1e3:t.x=t.x-Math.floor(t.x);break;case 1001:t.x=t.x<0?0:1;break;case 1002:1===Math.abs(Math.floor(t.x)%2)?t.x=Math.ceil(t.x)-t.x:t.x=t.x-Math.floor(t.x)}if(t.y<0||t.y>1)switch(this.wrapT){case 1e3:t.y=t.y-Math.floor(t.y);break;case 1001:t.y=t.y<0?0:1;break;case 1002:1===Math.abs(Math.floor(t.y)%2)?t.y=Math.ceil(t.y)-t.y:t.y=t.y-Math.floor(t.y)}return this.flipY&&(t.y=1-t.y),t}set needsUpdate(t){!0===t&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(t){!0===t&&this.pmremVersion++}}Texture.DEFAULT_IMAGE=null,Texture.DEFAULT_MAPPING=300,Texture.DEFAULT_ANISOTROPY=1;class Quaternion{constructor(t=0,e=0,r=0,i=1){this.isQuaternion=!0,this._x=t,this._y=e,this._z=r,this._w=i}static slerpFlat(t,e,r,i,n,s,a){let o=r[i+0],h=r[i+1],c=r[i+2],l=r[i+3];const u=n[s+0],d=n[s+1],p=n[s+2],_=n[s+3];if(0===a)return t[e+0]=o,t[e+1]=h,t[e+2]=c,void(t[e+3]=l);if(1===a)return t[e+0]=u,t[e+1]=d,t[e+2]=p,void(t[e+3]=_);if(l!==_||o!==u||h!==d||c!==p){let t=1-a;const e=o*u+h*d+c*p+l*_,r=e>=0?1:-1,i=1-e*e;if(i>Number.EPSILON){const n=Math.sqrt(i),s=Math.atan2(n,e*r);t=Math.sin(t*s)/n,a=Math.sin(a*s)/n}const n=a*r;if(o=o*t+u*n,h=h*t+d*n,c=c*t+p*n,l=l*t+_*n,t===1-a){const t=1/Math.sqrt(o*o+h*h+c*c+l*l);o*=t,h*=t,c*=t,l*=t}}t[e]=o,t[e+1]=h,t[e+2]=c,t[e+3]=l}static multiplyQuaternionsFlat(t,e,r,i,n,s){const a=r[i],o=r[i+1],h=r[i+2],c=r[i+3],l=n[s],u=n[s+1],d=n[s+2],p=n[s+3];return t[e]=a*p+c*l+o*d-h*u,t[e+1]=o*p+c*u+h*l-a*d,t[e+2]=h*p+c*d+a*u-o*l,t[e+3]=c*p-a*l-o*u-h*d,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,r,i){return this._x=t,this._y=e,this._z=r,this._w=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e=!0){const r=t._x,i=t._y,n=t._z,s=t._order,a=Math.cos,o=Math.sin,h=a(r/2),c=a(i/2),l=a(n/2),u=o(r/2),d=o(i/2),p=o(n/2);switch(s){case"XYZ":this._x=u*c*l+h*d*p,this._y=h*d*l-u*c*p,this._z=h*c*p+u*d*l,this._w=h*c*l-u*d*p;break;case"YXZ":this._x=u*c*l+h*d*p,this._y=h*d*l-u*c*p,this._z=h*c*p-u*d*l,this._w=h*c*l+u*d*p;break;case"ZXY":this._x=u*c*l-h*d*p,this._y=h*d*l+u*c*p,this._z=h*c*p+u*d*l,this._w=h*c*l-u*d*p;break;case"ZYX":this._x=u*c*l-h*d*p,this._y=h*d*l+u*c*p,this._z=h*c*p-u*d*l,this._w=h*c*l+u*d*p;break;case"YZX":this._x=u*c*l+h*d*p,this._y=h*d*l+u*c*p,this._z=h*c*p-u*d*l,this._w=h*c*l-u*d*p;break;case"XZY":this._x=u*c*l-h*d*p,this._y=h*d*l-u*c*p,this._z=h*c*p+u*d*l,this._w=h*c*l+u*d*p;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+s)}return!0===e&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const r=e/2,i=Math.sin(r);return this._x=t.x*i,this._y=t.y*i,this._z=t.z*i,this._w=Math.cos(r),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,r=e[0],i=e[4],n=e[8],s=e[1],a=e[5],o=e[9],h=e[2],c=e[6],l=e[10],u=r+a+l;if(u>0){const t=.5/Math.sqrt(u+1);this._w=.25/t,this._x=(c-o)*t,this._y=(n-h)*t,this._z=(s-i)*t}else if(r>a&&r>l){const t=2*Math.sqrt(1+r-a-l);this._w=(c-o)/t,this._x=.25*t,this._y=(i+s)/t,this._z=(n+h)/t}else if(a>l){const t=2*Math.sqrt(1+a-r-l);this._w=(n-h)/t,this._x=(i+s)/t,this._y=.25*t,this._z=(o+c)/t}else{const t=2*Math.sqrt(1+l-r-a);this._w=(s-i)/t,this._x=(n+h)/t,this._y=(o+c)/t,this._z=.25*t}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let r=t.dot(e)+1;return r<Number.EPSILON?(r=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=r):(this._x=0,this._y=-t.z,this._z=t.y,this._w=r)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=r),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(clamp(this.dot(t),-1,1)))}rotateTowards(t,e){const r=this.angleTo(t);if(0===r)return this;const i=Math.min(1,e/r);return this.slerp(t,i),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t){return this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const r=t._x,i=t._y,n=t._z,s=t._w,a=e._x,o=e._y,h=e._z,c=e._w;return this._x=r*c+s*a+i*h-n*o,this._y=i*c+s*o+n*a-r*h,this._z=n*c+s*h+r*o-i*a,this._w=s*c-r*a-i*o-n*h,this._onChangeCallback(),this}slerp(t,e){if(0===e)return this;if(1===e)return this.copy(t);const r=this._x,i=this._y,n=this._z,s=this._w;let a=s*t._w+r*t._x+i*t._y+n*t._z;if(a<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,a=-a):this.copy(t),a>=1)return this._w=s,this._x=r,this._y=i,this._z=n,this;const o=1-a*a;if(o<=Number.EPSILON){const t=1-e;return this._w=t*s+e*this._w,this._x=t*r+e*this._x,this._y=t*i+e*this._y,this._z=t*n+e*this._z,this.normalize(),this}const h=Math.sqrt(o),c=Math.atan2(h,a),l=Math.sin((1-e)*c)/h,u=Math.sin(e*c)/h;return this._w=s*l+this._w*u,this._x=r*l+this._x*u,this._y=i*l+this._y*u,this._z=n*l+this._z*u,this._onChangeCallback(),this}slerpQuaternions(t,e,r){return this.copy(t).slerp(e,r)}random(){const t=2*Math.PI*Math.random(),e=2*Math.PI*Math.random(),r=Math.random(),i=Math.sqrt(1-r),n=Math.sqrt(r);return this.set(i*Math.sin(t),i*Math.cos(t),n*Math.sin(e),n*Math.cos(e))}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class Vector3{constructor(t=0,e=0,r=0){Vector3.prototype.isVector3=!0,this.x=t,this.y=e,this.z=r}set(t,e,r){return void 0===r&&(r=this.z),this.x=t,this.y=e,this.z=r,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return this.applyQuaternion(_quaternion$4.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(_quaternion$4.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,r=this.y,i=this.z,n=t.elements;return this.x=n[0]*e+n[3]*r+n[6]*i,this.y=n[1]*e+n[4]*r+n[7]*i,this.z=n[2]*e+n[5]*r+n[8]*i,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,r=this.y,i=this.z,n=t.elements,s=1/(n[3]*e+n[7]*r+n[11]*i+n[15]);return this.x=(n[0]*e+n[4]*r+n[8]*i+n[12])*s,this.y=(n[1]*e+n[5]*r+n[9]*i+n[13])*s,this.z=(n[2]*e+n[6]*r+n[10]*i+n[14])*s,this}applyQuaternion(t){const e=this.x,r=this.y,i=this.z,n=t.x,s=t.y,a=t.z,o=t.w,h=2*(s*i-a*r),c=2*(a*e-n*i),l=2*(n*r-s*e);return this.x=e+o*h+s*l-a*c,this.y=r+o*c+a*h-n*l,this.z=i+o*l+n*c-s*h,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){const e=this.x,r=this.y,i=this.z,n=t.elements;return this.x=n[0]*e+n[4]*r+n[8]*i,this.y=n[1]*e+n[5]*r+n[9]*i,this.z=n[2]*e+n[6]*r+n[10]*i,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this}clampLength(t,e){const r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(t,Math.min(e,r)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,r){return this.x=t.x+(e.x-t.x)*r,this.y=t.y+(e.y-t.y)*r,this.z=t.z+(e.z-t.z)*r,this}cross(t){return this.crossVectors(this,t)}crossVectors(t,e){const r=t.x,i=t.y,n=t.z,s=e.x,a=e.y,o=e.z;return this.x=i*o-n*a,this.y=n*s-r*o,this.z=r*a-i*s,this}projectOnVector(t){const e=t.lengthSq();if(0===e)return this.set(0,0,0);const r=t.dot(this)/e;return this.copy(t).multiplyScalar(r)}projectOnPlane(t){return _vector$c.copy(this).projectOnVector(t),this.sub(_vector$c)}reflect(t){return this.sub(_vector$c.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const r=this.dot(t)/e;return Math.acos(clamp(r,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,r=this.y-t.y,i=this.z-t.z;return e*e+r*r+i*i}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,r){const i=Math.sin(e)*t;return this.x=i*Math.sin(r),this.y=Math.cos(e)*t,this.z=i*Math.cos(r),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,r){return this.x=t*Math.sin(e),this.y=r,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),r=this.setFromMatrixColumn(t,1).length(),i=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=r,this.z=i,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,4*e)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,3*e)}setFromEuler(t){return this.x=t._x,this.y=t._y,this.z=t._z,this}setFromColor(t){return this.x=t.r,this.y=t.g,this.z=t.b,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const t=Math.random()*Math.PI*2,e=2*Math.random()-1,r=Math.sqrt(1-e*e);return this.x=r*Math.cos(t),this.y=e,this.z=r*Math.sin(t),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const _vector$c=new Vector3,_quaternion$4=new Quaternion;class Box3{constructor(t=new Vector3(1/0,1/0,1/0),e=new Vector3(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=t,this.max=e}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromArray(t){this.makeEmpty();for(let e=0,r=t.length;e<r;e+=3)this.expandByPoint(_vector$b.fromArray(t,e));return this}setFromBufferAttribute(t){this.makeEmpty();for(let e=0,r=t.count;e<r;e++)this.expandByPoint(_vector$b.fromBufferAttribute(t,e));return this}setFromPoints(t){this.makeEmpty();for(let e=0,r=t.length;e<r;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const r=_vector$b.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(r),this.max.copy(t).add(r),this}setFromObject(t,e=!1){return this.makeEmpty(),this.expandByObject(t,e)}clone(){return(new this.constructor).copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}expandByObject(t,e=!1){t.updateWorldMatrix(!1,!1);const r=t.geometry;if(void 0!==r){const i=r.getAttribute("position");if(!0===e&&void 0!==i&&!0!==t.isInstancedMesh)for(let e=0,r=i.count;e<r;e++)!0===t.isMesh?t.getVertexPosition(e,_vector$b):_vector$b.fromBufferAttribute(i,e),_vector$b.applyMatrix4(t.matrixWorld),this.expandByPoint(_vector$b);else void 0!==t.boundingBox?(null===t.boundingBox&&t.computeBoundingBox(),_box$4.copy(t.boundingBox)):(null===r.boundingBox&&r.computeBoundingBox(),_box$4.copy(r.boundingBox)),_box$4.applyMatrix4(t.matrixWorld),this.union(_box$4)}const i=t.children;for(let t=0,r=i.length;t<r;t++)this.expandByObject(i[t],e);return this}containsPoint(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y||t.z<this.min.z||t.z>this.max.z)}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z}getParameter(t,e){return e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)}intersectsSphere(t){return this.clampPoint(t.center,_vector$b),_vector$b.distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){let e,r;return t.normal.x>0?(e=t.normal.x*this.min.x,r=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,r=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,r+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,r+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,r+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,r+=t.normal.z*this.min.z),e<=-t.constant&&r>=-t.constant}intersectsTriangle(t){if(this.isEmpty())return!1;this.getCenter(_center),_extents.subVectors(this.max,_center),_v0$2.subVectors(t.a,_center),_v1$7.subVectors(t.b,_center),_v2$4.subVectors(t.c,_center),_f0.subVectors(_v1$7,_v0$2),_f1.subVectors(_v2$4,_v1$7),_f2.subVectors(_v0$2,_v2$4);let e=[0,-_f0.z,_f0.y,0,-_f1.z,_f1.y,0,-_f2.z,_f2.y,_f0.z,0,-_f0.x,_f1.z,0,-_f1.x,_f2.z,0,-_f2.x,-_f0.y,_f0.x,0,-_f1.y,_f1.x,0,-_f2.y,_f2.x,0];return!!satForAxes(e,_v0$2,_v1$7,_v2$4,_extents)&&(e=[1,0,0,0,1,0,0,0,1],!!satForAxes(e,_v0$2,_v1$7,_v2$4,_extents)&&(_triangleNormal.crossVectors(_f0,_f1),e=[_triangleNormal.x,_triangleNormal.y,_triangleNormal.z],satForAxes(e,_v0$2,_v1$7,_v2$4,_extents)))}clampPoint(t,e){return e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return this.clampPoint(t,_vector$b).distanceTo(t)}getBoundingSphere(t){return this.isEmpty()?t.makeEmpty():(this.getCenter(t.center),t.radius=.5*this.getSize(_vector$b).length()),t}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}applyMatrix4(t){return this.isEmpty()||(_points[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),_points[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),_points[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),_points[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),_points[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),_points[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),_points[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),_points[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(_points)),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}const _points=[new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3],_vector$b=new Vector3,_box$4=new Box3,_v0$2=new Vector3,_v1$7=new Vector3,_v2$4=new Vector3,_f0=new Vector3,_f1=new Vector3,_f2=new Vector3,_center=new Vector3,_extents=new Vector3,_triangleNormal=new Vector3,_testAxis=new Vector3;function satForAxes(t,e,r,i,n){for(let s=0,a=t.length-3;s<=a;s+=3){_testAxis.fromArray(t,s);const a=n.x*Math.abs(_testAxis.x)+n.y*Math.abs(_testAxis.y)+n.z*Math.abs(_testAxis.z),o=e.dot(_testAxis),h=r.dot(_testAxis),c=i.dot(_testAxis);if(Math.max(-Math.max(o,h,c),Math.min(o,h,c))>a)return!1}return!0}const _box$3=new Box3,_v1$6=new Vector3,_v2$3=new Vector3;class Sphere{constructor(t=new Vector3,e=-1){this.isSphere=!0,this.center=t,this.radius=e}set(t,e){return this.center.copy(t),this.radius=e,this}setFromPoints(t,e){const r=this.center;void 0!==e?r.copy(e):_box$3.setFromPoints(t).getCenter(r);let i=0;for(let e=0,n=t.length;e<n;e++)i=Math.max(i,r.distanceToSquared(t[e]));return this.radius=Math.sqrt(i),this}copy(t){return this.center.copy(t.center),this.radius=t.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(t){return t.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(t){return t.distanceTo(this.center)-this.radius}intersectsSphere(t){const e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=e*e}intersectsBox(t){return t.intersectsSphere(this)}intersectsPlane(t){return Math.abs(t.distanceToPoint(this.center))<=this.radius}clampPoint(t,e){const r=this.center.distanceToSquared(t);return e.copy(t),r>this.radius*this.radius&&(e.sub(this.center).normalize(),e.multiplyScalar(this.radius).add(this.center)),e}getBoundingBox(t){return this.isEmpty()?(t.makeEmpty(),t):(t.set(this.center,this.center),t.expandByScalar(this.radius),t)}applyMatrix4(t){return this.center.applyMatrix4(t),this.radius=this.radius*t.getMaxScaleOnAxis(),this}translate(t){return this.center.add(t),this}expandByPoint(t){if(this.isEmpty())return this.center.copy(t),this.radius=0,this;_v1$6.subVectors(t,this.center);const e=_v1$6.lengthSq();if(e>this.radius*this.radius){const t=Math.sqrt(e),r=.5*(t-this.radius);this.center.addScaledVector(_v1$6,r/t),this.radius+=r}return this}union(t){return t.isEmpty()?this:this.isEmpty()?(this.copy(t),this):(!0===this.center.equals(t.center)?this.radius=Math.max(this.radius,t.radius):(_v2$3.subVectors(t.center,this.center).setLength(t.radius),this.expandByPoint(_v1$6.copy(t.center).add(_v2$3)),this.expandByPoint(_v1$6.copy(t.center).sub(_v2$3))),this)}equals(t){return t.center.equals(this.center)&&t.radius===this.radius}clone(){return(new this.constructor).copy(this)}}class Matrix4{constructor(t,e,r,i,n,s,a,o,h,c,l,u,d,p,_,m){Matrix4.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==t&&this.set(t,e,r,i,n,s,a,o,h,c,l,u,d,p,_,m)}set(t,e,r,i,n,s,a,o,h,c,l,u,d,p,_,m){const f=this.elements;return f[0]=t,f[4]=e,f[8]=r,f[12]=i,f[1]=n,f[5]=s,f[9]=a,f[13]=o,f[2]=h,f[6]=c,f[10]=l,f[14]=u,f[3]=d,f[7]=p,f[11]=_,f[15]=m,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new Matrix4).fromArray(this.elements)}copy(t){const e=this.elements,r=t.elements;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],this}copyPosition(t){const e=this.elements,r=t.elements;return e[12]=r[12],e[13]=r[13],e[14]=r[14],this}setFromMatrix3(t){const e=t.elements;return this.set(e[0],e[3],e[6],0,e[1],e[4],e[7],0,e[2],e[5],e[8],0,0,0,0,1),this}extractBasis(t,e,r){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),r.setFromMatrixColumn(this,2),this}makeBasis(t,e,r){return this.set(t.x,e.x,r.x,0,t.y,e.y,r.y,0,t.z,e.z,r.z,0,0,0,0,1),this}extractRotation(t){const e=this.elements,r=t.elements,i=1/_v1$5.setFromMatrixColumn(t,0).length(),n=1/_v1$5.setFromMatrixColumn(t,1).length(),s=1/_v1$5.setFromMatrixColumn(t,2).length();return e[0]=r[0]*i,e[1]=r[1]*i,e[2]=r[2]*i,e[3]=0,e[4]=r[4]*n,e[5]=r[5]*n,e[6]=r[6]*n,e[7]=0,e[8]=r[8]*s,e[9]=r[9]*s,e[10]=r[10]*s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){const e=this.elements,r=t.x,i=t.y,n=t.z,s=Math.cos(r),a=Math.sin(r),o=Math.cos(i),h=Math.sin(i),c=Math.cos(n),l=Math.sin(n);if("XYZ"===t.order){const t=s*c,r=s*l,i=a*c,n=a*l;e[0]=o*c,e[4]=-o*l,e[8]=h,e[1]=r+i*h,e[5]=t-n*h,e[9]=-a*o,e[2]=n-t*h,e[6]=i+r*h,e[10]=s*o}else if("YXZ"===t.order){const t=o*c,r=o*l,i=h*c,n=h*l;e[0]=t+n*a,e[4]=i*a-r,e[8]=s*h,e[1]=s*l,e[5]=s*c,e[9]=-a,e[2]=r*a-i,e[6]=n+t*a,e[10]=s*o}else if("ZXY"===t.order){const t=o*c,r=o*l,i=h*c,n=h*l;e[0]=t-n*a,e[4]=-s*l,e[8]=i+r*a,e[1]=r+i*a,e[5]=s*c,e[9]=n-t*a,e[2]=-s*h,e[6]=a,e[10]=s*o}else if("ZYX"===t.order){const t=s*c,r=s*l,i=a*c,n=a*l;e[0]=o*c,e[4]=i*h-r,e[8]=t*h+n,e[1]=o*l,e[5]=n*h+t,e[9]=r*h-i,e[2]=-h,e[6]=a*o,e[10]=s*o}else if("YZX"===t.order){const t=s*o,r=s*h,i=a*o,n=a*h;e[0]=o*c,e[4]=n-t*l,e[8]=i*l+r,e[1]=l,e[5]=s*c,e[9]=-a*c,e[2]=-h*c,e[6]=r*l+i,e[10]=t-n*l}else if("XZY"===t.order){const t=s*o,r=s*h,i=a*o,n=a*h;e[0]=o*c,e[4]=-l,e[8]=h*c,e[1]=t*l+n,e[5]=s*c,e[9]=r*l-i,e[2]=i*l-r,e[6]=a*c,e[10]=n*l+t}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromQuaternion(t){return this.compose(_zero,t,_one)}lookAt(t,e,r){const i=this.elements;return _z.subVectors(t,e),0===_z.lengthSq()&&(_z.z=1),_z.normalize(),_x.crossVectors(r,_z),0===_x.lengthSq()&&(1===Math.abs(r.z)?_z.x+=1e-4:_z.z+=1e-4,_z.normalize(),_x.crossVectors(r,_z)),_x.normalize(),_y.crossVectors(_z,_x),i[0]=_x.x,i[4]=_y.x,i[8]=_z.x,i[1]=_x.y,i[5]=_y.y,i[9]=_z.y,i[2]=_x.z,i[6]=_y.z,i[10]=_z.z,this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const r=t.elements,i=e.elements,n=this.elements,s=r[0],a=r[4],o=r[8],h=r[12],c=r[1],l=r[5],u=r[9],d=r[13],p=r[2],_=r[6],m=r[10],f=r[14],E=r[3],T=r[7],g=r[11],y=r[15],R=i[0],x=i[4],v=i[8],A=i[12],S=i[1],C=i[5],b=i[9],M=i[13],L=i[2],N=i[6],I=i[10],O=i[14],G=i[3],F=i[7],w=i[11],P=i[15];return n[0]=s*R+a*S+o*L+h*G,n[4]=s*x+a*C+o*N+h*F,n[8]=s*v+a*b+o*I+h*w,n[12]=s*A+a*M+o*O+h*P,n[1]=c*R+l*S+u*L+d*G,n[5]=c*x+l*C+u*N+d*F,n[9]=c*v+l*b+u*I+d*w,n[13]=c*A+l*M+u*O+d*P,n[2]=p*R+_*S+m*L+f*G,n[6]=p*x+_*C+m*N+f*F,n[10]=p*v+_*b+m*I+f*w,n[14]=p*A+_*M+m*O+f*P,n[3]=E*R+T*S+g*L+y*G,n[7]=E*x+T*C+g*N+y*F,n[11]=E*v+T*b+g*I+y*w,n[15]=E*A+T*M+g*O+y*P,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){const t=this.elements,e=t[0],r=t[4],i=t[8],n=t[12],s=t[1],a=t[5],o=t[9],h=t[13],c=t[2],l=t[6],u=t[10],d=t[14];return t[3]*(+n*o*l-i*h*l-n*a*u+r*h*u+i*a*d-r*o*d)+t[7]*(+e*o*d-e*h*u+n*s*u-i*s*d+i*h*c-n*o*c)+t[11]*(+e*h*l-e*a*d-n*s*l+r*s*d+n*a*c-r*h*c)+t[15]*(-i*a*c-e*o*l+e*a*u+i*s*l-r*s*u+r*o*c)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,r){const i=this.elements;return t.isVector3?(i[12]=t.x,i[13]=t.y,i[14]=t.z):(i[12]=t,i[13]=e,i[14]=r),this}invert(){const t=this.elements,e=t[0],r=t[1],i=t[2],n=t[3],s=t[4],a=t[5],o=t[6],h=t[7],c=t[8],l=t[9],u=t[10],d=t[11],p=t[12],_=t[13],m=t[14],f=t[15],E=l*m*h-_*u*h+_*o*d-a*m*d-l*o*f+a*u*f,T=p*u*h-c*m*h-p*o*d+s*m*d+c*o*f-s*u*f,g=c*_*h-p*l*h+p*a*d-s*_*d-c*a*f+s*l*f,y=p*l*o-c*_*o-p*a*u+s*_*u+c*a*m-s*l*m,R=e*E+r*T+i*g+n*y;if(0===R)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const x=1/R;return t[0]=E*x,t[1]=(_*u*n-l*m*n-_*i*d+r*m*d+l*i*f-r*u*f)*x,t[2]=(a*m*n-_*o*n+_*i*h-r*m*h-a*i*f+r*o*f)*x,t[3]=(l*o*n-a*u*n-l*i*h+r*u*h+a*i*d-r*o*d)*x,t[4]=T*x,t[5]=(c*m*n-p*u*n+p*i*d-e*m*d-c*i*f+e*u*f)*x,t[6]=(p*o*n-s*m*n-p*i*h+e*m*h+s*i*f-e*o*f)*x,t[7]=(s*u*n-c*o*n+c*i*h-e*u*h-s*i*d+e*o*d)*x,t[8]=g*x,t[9]=(p*l*n-c*_*n-p*r*d+e*_*d+c*r*f-e*l*f)*x,t[10]=(s*_*n-p*a*n+p*r*h-e*_*h-s*r*f+e*a*f)*x,t[11]=(c*a*n-s*l*n-c*r*h+e*l*h+s*r*d-e*a*d)*x,t[12]=y*x,t[13]=(c*_*i-p*l*i+p*r*u-e*_*u-c*r*m+e*l*m)*x,t[14]=(p*a*i-s*_*i-p*r*o+e*_*o+s*r*m-e*a*m)*x,t[15]=(s*l*i-c*a*i+c*r*o-e*l*o-s*r*u+e*a*u)*x,this}scale(t){const e=this.elements,r=t.x,i=t.y,n=t.z;return e[0]*=r,e[4]*=i,e[8]*=n,e[1]*=r,e[5]*=i,e[9]*=n,e[2]*=r,e[6]*=i,e[10]*=n,e[3]*=r,e[7]*=i,e[11]*=n,this}getMaxScaleOnAxis(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],r=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],i=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,r,i))}makeTranslation(t,e,r){return t.isVector3?this.set(1,0,0,t.x,0,1,0,t.y,0,0,1,t.z,0,0,0,1):this.set(1,0,0,t,0,1,0,e,0,0,1,r,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),r=Math.sin(t);return this.set(1,0,0,0,0,e,-r,0,0,r,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),r=Math.sin(t);return this.set(e,0,r,0,0,1,0,0,-r,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),r=Math.sin(t);return this.set(e,-r,0,0,r,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){const r=Math.cos(e),i=Math.sin(e),n=1-r,s=t.x,a=t.y,o=t.z,h=n*s,c=n*a;return this.set(h*s+r,h*a-i*o,h*o+i*a,0,h*a+i*o,c*a+r,c*o-i*s,0,h*o-i*a,c*o+i*s,n*o*o+r,0,0,0,0,1),this}makeScale(t,e,r){return this.set(t,0,0,0,0,e,0,0,0,0,r,0,0,0,0,1),this}makeShear(t,e,r,i,n,s){return this.set(1,r,n,0,t,1,s,0,e,i,1,0,0,0,0,1),this}compose(t,e,r){const i=this.elements,n=e._x,s=e._y,a=e._z,o=e._w,h=n+n,c=s+s,l=a+a,u=n*h,d=n*c,p=n*l,_=s*c,m=s*l,f=a*l,E=o*h,T=o*c,g=o*l,y=r.x,R=r.y,x=r.z;return i[0]=(1-(_+f))*y,i[1]=(d+g)*y,i[2]=(p-T)*y,i[3]=0,i[4]=(d-g)*R,i[5]=(1-(u+f))*R,i[6]=(m+E)*R,i[7]=0,i[8]=(p+T)*x,i[9]=(m-E)*x,i[10]=(1-(u+_))*x,i[11]=0,i[12]=t.x,i[13]=t.y,i[14]=t.z,i[15]=1,this}decompose(t,e,r){const i=this.elements;let n=_v1$5.set(i[0],i[1],i[2]).length();const s=_v1$5.set(i[4],i[5],i[6]).length(),a=_v1$5.set(i[8],i[9],i[10]).length();this.determinant()<0&&(n=-n),t.x=i[12],t.y=i[13],t.z=i[14],_m1$4.copy(this);const o=1/n,h=1/s,c=1/a;return _m1$4.elements[0]*=o,_m1$4.elements[1]*=o,_m1$4.elements[2]*=o,_m1$4.elements[4]*=h,_m1$4.elements[5]*=h,_m1$4.elements[6]*=h,_m1$4.elements[8]*=c,_m1$4.elements[9]*=c,_m1$4.elements[10]*=c,e.setFromRotationMatrix(_m1$4),r.x=n,r.y=s,r.z=a,this}makePerspective(t,e,r,i,n,s,a=2e3){const o=this.elements,h=2*n/(e-t),c=2*n/(r-i),l=(e+t)/(e-t),u=(r+i)/(r-i);let d,p;if(2e3===a)d=-(s+n)/(s-n),p=-2*s*n/(s-n);else{if(2001!==a)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+a);d=-s/(s-n),p=-s*n/(s-n)}return o[0]=h,o[4]=0,o[8]=l,o[12]=0,o[1]=0,o[5]=c,o[9]=u,o[13]=0,o[2]=0,o[6]=0,o[10]=d,o[14]=p,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this}makeOrthographic(t,e,r,i,n,s,a=2e3){const o=this.elements,h=1/(e-t),c=1/(r-i),l=1/(s-n),u=(e+t)*h,d=(r+i)*c;let p,_;if(2e3===a)p=(s+n)*l,_=-2*l;else{if(2001!==a)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+a);p=n*l,_=-1*l}return o[0]=2*h,o[4]=0,o[8]=0,o[12]=-u,o[1]=0,o[5]=2*c,o[9]=0,o[13]=-d,o[2]=0,o[6]=0,o[10]=_,o[14]=-p,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this}equals(t){const e=this.elements,r=t.elements;for(let t=0;t<16;t++)if(e[t]!==r[t])return!1;return!0}fromArray(t,e=0){for(let r=0;r<16;r++)this.elements[r]=t[r+e];return this}toArray(t=[],e=0){const r=this.elements;return t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8],t[e+9]=r[9],t[e+10]=r[10],t[e+11]=r[11],t[e+12]=r[12],t[e+13]=r[13],t[e+14]=r[14],t[e+15]=r[15],t}}const _v1$5=new Vector3,_m1$4=new Matrix4,_zero=new Vector3(0,0,0),_one=new Vector3(1,1,1),_x=new Vector3,_y=new Vector3,_z=new Vector3,_matrix$2=new Matrix4,_quaternion$3=new Quaternion;class Euler{constructor(t=0,e=0,r=0,i=Euler.DEFAULT_ORDER){this.isEuler=!0,this._x=t,this._y=e,this._z=r,this._order=i}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get order(){return this._order}set order(t){this._order=t,this._onChangeCallback()}set(t,e,r,i=this._order){return this._x=t,this._y=e,this._z=r,this._order=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this}setFromRotationMatrix(t,e=this._order,r=!0){const i=t.elements,n=i[0],s=i[4],a=i[8],o=i[1],h=i[5],c=i[9],l=i[2],u=i[6],d=i[10];switch(e){case"XYZ":this._y=Math.asin(clamp(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-c,d),this._z=Math.atan2(-s,n)):(this._x=Math.atan2(u,h),this._z=0);break;case"YXZ":this._x=Math.asin(-clamp(c,-1,1)),Math.abs(c)<.9999999?(this._y=Math.atan2(a,d),this._z=Math.atan2(o,h)):(this._y=Math.atan2(-l,n),this._z=0);break;case"ZXY":this._x=Math.asin(clamp(u,-1,1)),Math.abs(u)<.9999999?(this._y=Math.atan2(-l,d),this._z=Math.atan2(-s,h)):(this._y=0,this._z=Math.atan2(o,n));break;case"ZYX":this._y=Math.asin(-clamp(l,-1,1)),Math.abs(l)<.9999999?(this._x=Math.atan2(u,d),this._z=Math.atan2(o,n)):(this._x=0,this._z=Math.atan2(-s,h));break;case"YZX":this._z=Math.asin(clamp(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-c,h),this._y=Math.atan2(-l,n)):(this._x=0,this._y=Math.atan2(a,d));break;case"XZY":this._z=Math.asin(-clamp(s,-1,1)),Math.abs(s)<.9999999?(this._x=Math.atan2(u,h),this._y=Math.atan2(a,n)):(this._x=Math.atan2(-c,d),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+e)}return this._order=e,!0===r&&this._onChangeCallback(),this}setFromQuaternion(t,e,r){return _matrix$2.makeRotationFromQuaternion(t),this.setFromRotationMatrix(_matrix$2,e,r)}setFromVector3(t,e=this._order){return this.set(t.x,t.y,t.z,e)}reorder(t){return _quaternion$3.setFromEuler(this),this.setFromQuaternion(_quaternion$3,t)}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}Euler.DEFAULT_ORDER="XYZ";class Layers{constructor(){this.mask=1}set(t){this.mask=1<<t>>>0}enable(t){this.mask|=1<<t}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t}disable(t){this.mask&=~(1<<t)}disableAll(){this.mask=0}test(t){return!!(this.mask&t.mask)}isEnabled(t){return!!(this.mask&1<<t)}}let _object3DId=0;const _v1$4=new Vector3,_q1=new Quaternion,_m1$3=new Matrix4,_target=new Vector3,_position$3=new Vector3,_scale$2=new Vector3,_quaternion$2=new Quaternion,_xAxis=new Vector3(1,0,0),_yAxis=new Vector3(0,1,0),_zAxis=new Vector3(0,0,1),_addedEvent={type:"added"},_removedEvent={type:"removed"},_childaddedEvent={type:"childadded",child:null},_childremovedEvent={type:"childremoved",child:null};class Object3D extends EventDispatcher{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:_object3DId++}),this.uuid=generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Object3D.DEFAULT_UP.clone();const t=new Vector3,e=new Euler,r=new Quaternion,i=new Vector3(1,1,1);e._onChange((function(){r.setFromEuler(e,!1)})),r._onChange((function(){e.setFromQuaternion(r,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:r},scale:{configurable:!0,enumerable:!0,value:i},modelViewMatrix:{value:new Matrix4},normalMatrix:{value:new Matrix3}}),this.matrix=new Matrix4,this.matrixWorld=new Matrix4,this.matrixAutoUpdate=Object3D.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=Object3D.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new Layers,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(t){return this.quaternion.premultiply(t),this}setRotationFromAxisAngle(t,e){this.quaternion.setFromAxisAngle(t,e)}setRotationFromEuler(t){this.quaternion.setFromEuler(t,!0)}setRotationFromMatrix(t){this.quaternion.setFromRotationMatrix(t)}setRotationFromQuaternion(t){this.quaternion.copy(t)}rotateOnAxis(t,e){return _q1.setFromAxisAngle(t,e),this.quaternion.multiply(_q1),this}rotateOnWorldAxis(t,e){return _q1.setFromAxisAngle(t,e),this.quaternion.premultiply(_q1),this}rotateX(t){return this.rotateOnAxis(_xAxis,t)}rotateY(t){return this.rotateOnAxis(_yAxis,t)}rotateZ(t){return this.rotateOnAxis(_zAxis,t)}translateOnAxis(t,e){return _v1$4.copy(t).applyQuaternion(this.quaternion),this.position.add(_v1$4.multiplyScalar(e)),this}translateX(t){return this.translateOnAxis(_xAxis,t)}translateY(t){return this.translateOnAxis(_yAxis,t)}translateZ(t){return this.translateOnAxis(_zAxis,t)}localToWorld(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(this.matrixWorld)}worldToLocal(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(_m1$3.copy(this.matrixWorld).invert())}lookAt(t,e,r){t.isVector3?_target.copy(t):_target.set(t,e,r);const i=this.parent;this.updateWorldMatrix(!0,!1),_position$3.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?_m1$3.lookAt(_position$3,_target,this.up):_m1$3.lookAt(_target,_position$3,this.up),this.quaternion.setFromRotationMatrix(_m1$3),i&&(_m1$3.extractRotation(i.matrixWorld),_q1.setFromRotationMatrix(_m1$3),this.quaternion.premultiply(_q1.invert()))}add(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return t===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",t),this):(t&&t.isObject3D?(t.removeFromParent(),t.parent=this,this.children.push(t),t.dispatchEvent(_addedEvent),_childaddedEvent.child=t,this.dispatchEvent(_childaddedEvent),_childaddedEvent.child=null):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t),this)}remove(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.remove(arguments[t]);return this}const e=this.children.indexOf(t);return-1!==e&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(_removedEvent),_childremovedEvent.child=t,this.dispatchEvent(_childremovedEvent),_childremovedEvent.child=null),this}removeFromParent(){const t=this.parent;return null!==t&&t.remove(this),this}clear(){return this.remove(...this.children)}attach(t){return this.updateWorldMatrix(!0,!1),_m1$3.copy(this.matrixWorld).invert(),null!==t.parent&&(t.parent.updateWorldMatrix(!0,!1),_m1$3.multiply(t.parent.matrixWorld)),t.applyMatrix4(_m1$3),t.removeFromParent(),t.parent=this,this.children.push(t),t.updateWorldMatrix(!1,!0),t.dispatchEvent(_addedEvent),_childaddedEvent.child=t,this.dispatchEvent(_childaddedEvent),_childaddedEvent.child=null,this}getObjectById(t){return this.getObjectByProperty("id",t)}getObjectByName(t){return this.getObjectByProperty("name",t)}getObjectByProperty(t,e){if(this[t]===e)return this;for(let r=0,i=this.children.length;r<i;r++){const i=this.children[r].getObjectByProperty(t,e);if(void 0!==i)return i}}getObjectsByProperty(t,e,r=[]){this[t]===e&&r.push(this);const i=this.children;for(let n=0,s=i.length;n<s;n++)i[n].getObjectsByProperty(t,e,r);return r}getWorldPosition(t){return this.updateWorldMatrix(!0,!1),t.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(_position$3,t,_scale$2),t}getWorldScale(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(_position$3,_quaternion$2,t),t}getWorldDirection(t){this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()}raycast(){}traverse(t){t(this);const e=this.children;for(let r=0,i=e.length;r<i;r++)e[r].traverse(t)}traverseVisible(t){if(!1===this.visible)return;t(this);const e=this.children;for(let r=0,i=e.length;r<i;r++)e[r].traverseVisible(t)}traverseAncestors(t){const e=this.parent;null!==e&&(t(e),e.traverseAncestors(t))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let r=0,i=e.length;r<i;r++){e[r].updateMatrixWorld(t)}}updateWorldMatrix(t,e){const r=this.parent;if(!0===t&&null!==r&&r.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),!0===e){const t=this.children;for(let e=0,r=t.length;e<r;e++){t[e].updateWorldMatrix(!1,!0)}}}toJSON(t){const e=void 0===t||"string"==typeof t,r={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},r.metadata={version:4.6,type:"Object",generator:"Object3D.toJSON"});const i={};function n(e,r){return void 0===e[r.uuid]&&(e[r.uuid]=r.toJSON(t)),r.uuid}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),!0===this.castShadow&&(i.castShadow=!0),!0===this.receiveShadow&&(i.receiveShadow=!0),!1===this.visible&&(i.visible=!1),!1===this.frustumCulled&&(i.frustumCulled=!1),0!==this.renderOrder&&(i.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(i.userData=this.userData),i.layers=this.layers.mask,i.matrix=this.matrix.toArray(),i.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(i.matrixAutoUpdate=!1),this.isInstancedMesh&&(i.type="InstancedMesh",i.count=this.count,i.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(i.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(i.type="BatchedMesh",i.perObjectFrustumCulled=this.perObjectFrustumCulled,i.sortObjects=this.sortObjects,i.drawRanges=this._drawRanges,i.reservedRanges=this._reservedRanges,i.visibility=this._visibility,i.active=this._active,i.bounds=this._bounds.map((t=>({boxInitialized:t.boxInitialized,boxMin:t.box.min.toArray(),boxMax:t.box.max.toArray(),sphereInitialized:t.sphereInitialized,sphereRadius:t.sphere.radius,sphereCenter:t.sphere.center.toArray()}))),i.maxInstanceCount=this._maxInstanceCount,i.maxVertexCount=this._maxVertexCount,i.maxIndexCount=this._maxIndexCount,i.geometryInitialized=this._geometryInitialized,i.geometryCount=this._geometryCount,i.matricesTexture=this._matricesTexture.toJSON(t),null!==this._colorsTexture&&(i.colorsTexture=this._colorsTexture.toJSON(t)),null!==this.boundingSphere&&(i.boundingSphere={center:i.boundingSphere.center.toArray(),radius:i.boundingSphere.radius}),null!==this.boundingBox&&(i.boundingBox={min:i.boundingBox.min.toArray(),max:i.boundingBox.max.toArray()})),this.isScene)this.background&&(this.background.isColor?i.background=this.background.toJSON():this.background.isTexture&&(i.background=this.background.toJSON(t).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(i.environment=this.environment.toJSON(t).uuid);else if(this.isMesh||this.isLine||this.isPoints){i.geometry=n(t.geometries,this.geometry);const e=this.geometry.parameters;if(void 0!==e&&void 0!==e.shapes){const r=e.shapes;if(Array.isArray(r))for(let e=0,i=r.length;e<i;e++){const i=r[e];n(t.shapes,i)}else n(t.shapes,r)}}if(this.isSkinnedMesh&&(i.bindMode=this.bindMode,i.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(n(t.skeletons,this.skeleton),i.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const e=[];for(let r=0,i=this.material.length;r<i;r++)e.push(n(t.materials,this.material[r]));i.material=e}else i.material=n(t.materials,this.material);if(this.children.length>0){i.children=[];for(let e=0;e<this.children.length;e++)i.children.push(this.children[e].toJSON(t).object)}if(this.animations.length>0){i.animations=[];for(let e=0;e<this.animations.length;e++){const r=this.animations[e];i.animations.push(n(t.animations,r))}}if(e){const e=s(t.geometries),i=s(t.materials),n=s(t.textures),a=s(t.images),o=s(t.shapes),h=s(t.skeletons),c=s(t.animations),l=s(t.nodes);e.length>0&&(r.geometries=e),i.length>0&&(r.materials=i),n.length>0&&(r.textures=n),a.length>0&&(r.images=a),o.length>0&&(r.shapes=o),h.length>0&&(r.skeletons=h),c.length>0&&(r.animations=c),l.length>0&&(r.nodes=l)}return r.object=i,r;function s(t){const e=[];for(const r in t){const i=t[r];delete i.metadata,e.push(i)}return e}}clone(t){return(new this.constructor).copy(this,t)}copy(t,e=!0){if(this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldAutoUpdate=t.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.animations=t.animations.slice(),this.userData=JSON.parse(JSON.stringify(t.userData)),!0===e)for(let e=0;e<t.children.length;e++){const r=t.children[e];this.add(r.clone())}return this}}Object3D.DEFAULT_UP=new Vector3(0,1,0),Object3D.DEFAULT_MATRIX_AUTO_UPDATE=!0,Object3D.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const _vector$9=new Vector3,_vector2$1=new Vector2;class BufferAttribute{constructor(t,e,r=!1){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,this.name="",this.array=t,this.itemSize=e,this.count=void 0!==t?t.length/e:0,this.normalized=r,this.usage=35044,this._updateRange={offset:0,count:-1},this.updateRanges=[],this.gpuType=1015,this.version=0}onUploadCallback(){}set needsUpdate(t){!0===t&&this.version++}get updateRange(){return warnOnce("THREE.BufferAttribute: updateRange() is deprecated and will be removed in r169. Use addUpdateRange() instead."),this._updateRange}setUsage(t){return this.usage=t,this}addUpdateRange(t,e){this.updateRanges.push({start:t,count:e})}clearUpdateRanges(){this.updateRanges.length=0}copy(t){return this.name=t.name,this.array=new t.array.constructor(t.array),this.itemSize=t.itemSize,this.count=t.count,this.normalized=t.normalized,this.usage=t.usage,this.gpuType=t.gpuType,this}copyAt(t,e,r){t*=this.itemSize,r*=e.itemSize;for(let i=0,n=this.itemSize;i<n;i++)this.array[t+i]=e.array[r+i];return this}copyArray(t){return this.array.set(t),this}applyMatrix3(t){if(2===this.itemSize)for(let e=0,r=this.count;e<r;e++)_vector2$1.fromBufferAttribute(this,e),_vector2$1.applyMatrix3(t),this.setXY(e,_vector2$1.x,_vector2$1.y);else if(3===this.itemSize)for(let e=0,r=this.count;e<r;e++)_vector$9.fromBufferAttribute(this,e),_vector$9.applyMatrix3(t),this.setXYZ(e,_vector$9.x,_vector$9.y,_vector$9.z);return this}applyMatrix4(t){for(let e=0,r=this.count;e<r;e++)_vector$9.fromBufferAttribute(this,e),_vector$9.applyMatrix4(t),this.setXYZ(e,_vector$9.x,_vector$9.y,_vector$9.z);return this}applyNormalMatrix(t){for(let e=0,r=this.count;e<r;e++)_vector$9.fromBufferAttribute(this,e),_vector$9.applyNormalMatrix(t),this.setXYZ(e,_vector$9.x,_vector$9.y,_vector$9.z);return this}transformDirection(t){for(let e=0,r=this.count;e<r;e++)_vector$9.fromBufferAttribute(this,e),_vector$9.transformDirection(t),this.setXYZ(e,_vector$9.x,_vector$9.y,_vector$9.z);return this}set(t,e=0){return this.array.set(t,e),this}getComponent(t,e){let r=this.array[t*this.itemSize+e];return this.normalized&&(r=denormalize(r,this.array)),r}setComponent(t,e,r){return this.normalized&&(r=normalize(r,this.array)),this.array[t*this.itemSize+e]=r,this}getX(t){let e=this.array[t*this.itemSize];return this.normalized&&(e=denormalize(e,this.array)),e}setX(t,e){return this.normalized&&(e=normalize(e,this.array)),this.array[t*this.itemSize]=e,this}getY(t){let e=this.array[t*this.itemSize+1];return this.normalized&&(e=denormalize(e,this.array)),e}setY(t,e){return this.normalized&&(e=normalize(e,this.array)),this.array[t*this.itemSize+1]=e,this}getZ(t){let e=this.array[t*this.itemSize+2];return this.normalized&&(e=denormalize(e,this.array)),e}setZ(t,e){return this.normalized&&(e=normalize(e,this.array)),this.array[t*this.itemSize+2]=e,this}getW(t){let e=this.array[t*this.itemSize+3];return this.normalized&&(e=denormalize(e,this.array)),e}setW(t,e){return this.normalized&&(e=normalize(e,this.array)),this.array[t*this.itemSize+3]=e,this}setXY(t,e,r){return t*=this.itemSize,this.normalized&&(e=normalize(e,this.array),r=normalize(r,this.array)),this.array[t+0]=e,this.array[t+1]=r,this}setXYZ(t,e,r,i){return t*=this.itemSize,this.normalized&&(e=normalize(e,this.array),r=normalize(r,this.array),i=normalize(i,this.array)),this.array[t+0]=e,this.array[t+1]=r,this.array[t+2]=i,this}setXYZW(t,e,r,i,n){return t*=this.itemSize,this.normalized&&(e=normalize(e,this.array),r=normalize(r,this.array),i=normalize(i,this.array),n=normalize(n,this.array)),this.array[t+0]=e,this.array[t+1]=r,this.array[t+2]=i,this.array[t+3]=n,this}onUpload(t){return this.onUploadCallback=t,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const t={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(t.name=this.name),35044!==this.usage&&(t.usage=this.usage),t}}class Uint16BufferAttribute extends BufferAttribute{constructor(t,e,r){super(new Uint16Array(t),e,r)}}class Uint32BufferAttribute extends BufferAttribute{constructor(t,e,r){super(new Uint32Array(t),e,r)}}class Float32BufferAttribute extends BufferAttribute{constructor(t,e,r){super(new Float32Array(t),e,r)}}let _id$2=0;const _m1$2=new Matrix4,_obj=new Object3D,_offset=new Vector3,_box$2=new Box3,_boxMorphTargets=new Box3,_vector$8=new Vector3;class BufferGeometry extends EventDispatcher{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:_id$2++}),this.uuid=generateUUID(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(t){return Array.isArray(t)?this.index=new(arrayNeedsUint32(t)?Uint32BufferAttribute:Uint16BufferAttribute)(t,1):this.index=t,this}getAttribute(t){return this.attributes[t]}setAttribute(t,e){return this.attributes[t]=e,this}deleteAttribute(t){return delete this.attributes[t],this}hasAttribute(t){return void 0!==this.attributes[t]}addGroup(t,e,r=0){this.groups.push({start:t,count:e,materialIndex:r})}clearGroups(){this.groups=[]}setDrawRange(t,e){this.drawRange.start=t,this.drawRange.count=e}applyMatrix4(t){const e=this.attributes.position;void 0!==e&&(e.applyMatrix4(t),e.needsUpdate=!0);const r=this.attributes.normal;if(void 0!==r){const e=(new Matrix3).getNormalMatrix(t);r.applyNormalMatrix(e),r.needsUpdate=!0}const i=this.attributes.tangent;return void 0!==i&&(i.transformDirection(t),i.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(t){return _m1$2.makeRotationFromQuaternion(t),this.applyMatrix4(_m1$2),this}rotateX(t){return _m1$2.makeRotationX(t),this.applyMatrix4(_m1$2),this}rotateY(t){return _m1$2.makeRotationY(t),this.applyMatrix4(_m1$2),this}rotateZ(t){return _m1$2.makeRotationZ(t),this.applyMatrix4(_m1$2),this}translate(t,e,r){return _m1$2.makeTranslation(t,e,r),this.applyMatrix4(_m1$2),this}scale(t,e,r){return _m1$2.makeScale(t,e,r),this.applyMatrix4(_m1$2),this}lookAt(t){return _obj.lookAt(t),_obj.updateMatrix(),this.applyMatrix4(_obj.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(_offset).negate(),this.translate(_offset.x,_offset.y,_offset.z),this}setFromPoints(t){const e=[];for(let r=0,i=t.length;r<i;r++){const i=t[r];e.push(i.x,i.y,i.z||0)}return this.setAttribute("position",new Float32BufferAttribute(e,3)),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new Box3);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)return console.error("THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box.",this),void this.boundingBox.set(new Vector3(-1/0,-1/0,-1/0),new Vector3(1/0,1/0,1/0));if(void 0!==t){if(this.boundingBox.setFromBufferAttribute(t),e)for(let t=0,r=e.length;t<r;t++){const r=e[t];_box$2.setFromBufferAttribute(r),this.morphTargetsRelative?(_vector$8.addVectors(this.boundingBox.min,_box$2.min),this.boundingBox.expandByPoint(_vector$8),_vector$8.addVectors(this.boundingBox.max,_box$2.max),this.boundingBox.expandByPoint(_vector$8)):(this.boundingBox.expandByPoint(_box$2.min),this.boundingBox.expandByPoint(_box$2.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new Sphere);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)return console.error("THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere.",this),void this.boundingSphere.set(new Vector3,1/0);if(t){const r=this.boundingSphere.center;if(_box$2.setFromBufferAttribute(t),e)for(let t=0,r=e.length;t<r;t++){const r=e[t];_boxMorphTargets.setFromBufferAttribute(r),this.morphTargetsRelative?(_vector$8.addVectors(_box$2.min,_boxMorphTargets.min),_box$2.expandByPoint(_vector$8),_vector$8.addVectors(_box$2.max,_boxMorphTargets.max),_box$2.expandByPoint(_vector$8)):(_box$2.expandByPoint(_boxMorphTargets.min),_box$2.expandByPoint(_boxMorphTargets.max))}_box$2.getCenter(r);let i=0;for(let e=0,n=t.count;e<n;e++)_vector$8.fromBufferAttribute(t,e),i=Math.max(i,r.distanceToSquared(_vector$8));if(e)for(let n=0,s=e.length;n<s;n++){const s=e[n],a=this.morphTargetsRelative;for(let e=0,n=s.count;e<n;e++)_vector$8.fromBufferAttribute(s,e),a&&(_offset.fromBufferAttribute(t,e),_vector$8.add(_offset)),i=Math.max(i,r.distanceToSquared(_vector$8))}this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){const t=this.index,e=this.attributes;if(null===t||void 0===e.position||void 0===e.normal||void 0===e.uv)return void console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");const r=e.position,i=e.normal,n=e.uv;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new BufferAttribute(new Float32Array(4*r.count),4));const s=this.getAttribute("tangent"),a=[],o=[];for(let t=0;t<r.count;t++)a[t]=new Vector3,o[t]=new Vector3;const h=new Vector3,c=new Vector3,l=new Vector3,u=new Vector2,d=new Vector2,p=new Vector2,_=new Vector3,m=new Vector3;function f(t,e,i){h.fromBufferAttribute(r,t),c.fromBufferAttribute(r,e),l.fromBufferAttribute(r,i),u.fromBufferAttribute(n,t),d.fromBufferAttribute(n,e),p.fromBufferAttribute(n,i),c.sub(h),l.sub(h),d.sub(u),p.sub(u);const s=1/(d.x*p.y-p.x*d.y);isFinite(s)&&(_.copy(c).multiplyScalar(p.y).addScaledVector(l,-d.y).multiplyScalar(s),m.copy(l).multiplyScalar(d.x).addScaledVector(c,-p.x).multiplyScalar(s),a[t].add(_),a[e].add(_),a[i].add(_),o[t].add(m),o[e].add(m),o[i].add(m))}let E=this.groups;0===E.length&&(E=[{start:0,count:t.count}]);for(let e=0,r=E.length;e<r;++e){const r=E[e],i=r.start;for(let e=i,n=i+r.count;e<n;e+=3)f(t.getX(e+0),t.getX(e+1),t.getX(e+2))}const T=new Vector3,g=new Vector3,y=new Vector3,R=new Vector3;function x(t){y.fromBufferAttribute(i,t),R.copy(y);const e=a[t];T.copy(e),T.sub(y.multiplyScalar(y.dot(e))).normalize(),g.crossVectors(R,e);const r=g.dot(o[t])<0?-1:1;s.setXYZW(t,T.x,T.y,T.z,r)}for(let e=0,r=E.length;e<r;++e){const r=E[e],i=r.start;for(let e=i,n=i+r.count;e<n;e+=3)x(t.getX(e+0)),x(t.getX(e+1)),x(t.getX(e+2))}}computeVertexNormals(){const t=this.index,e=this.getAttribute("position");if(void 0!==e){let r=this.getAttribute("normal");if(void 0===r)r=new BufferAttribute(new Float32Array(3*e.count),3),this.setAttribute("normal",r);else for(let t=0,e=r.count;t<e;t++)r.setXYZ(t,0,0,0);const i=new Vector3,n=new Vector3,s=new Vector3,a=new Vector3,o=new Vector3,h=new Vector3,c=new Vector3,l=new Vector3;if(t)for(let u=0,d=t.count;u<d;u+=3){const d=t.getX(u+0),p=t.getX(u+1),_=t.getX(u+2);i.fromBufferAttribute(e,d),n.fromBufferAttribute(e,p),s.fromBufferAttribute(e,_),c.subVectors(s,n),l.subVectors(i,n),c.cross(l),a.fromBufferAttribute(r,d),o.fromBufferAttribute(r,p),h.fromBufferAttribute(r,_),a.add(c),o.add(c),h.add(c),r.setXYZ(d,a.x,a.y,a.z),r.setXYZ(p,o.x,o.y,o.z),r.setXYZ(_,h.x,h.y,h.z)}else for(let t=0,a=e.count;t<a;t+=3)i.fromBufferAttribute(e,t+0),n.fromBufferAttribute(e,t+1),s.fromBufferAttribute(e,t+2),c.subVectors(s,n),l.subVectors(i,n),c.cross(l),r.setXYZ(t+0,c.x,c.y,c.z),r.setXYZ(t+1,c.x,c.y,c.z),r.setXYZ(t+2,c.x,c.y,c.z);this.normalizeNormals(),r.needsUpdate=!0}}normalizeNormals(){const t=this.attributes.normal;for(let e=0,r=t.count;e<r;e++)_vector$8.fromBufferAttribute(t,e),_vector$8.normalize(),t.setXYZ(e,_vector$8.x,_vector$8.y,_vector$8.z)}toNonIndexed(){function t(t,e){const r=t.array,i=t.itemSize,n=t.normalized,s=new r.constructor(e.length*i);let a=0,o=0;for(let n=0,h=e.length;n<h;n++){a=t.isInterleavedBufferAttribute?e[n]*t.data.stride+t.offset:e[n]*i;for(let t=0;t<i;t++)s[o++]=r[a++]}return new BufferAttribute(s,i,n)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const e=new BufferGeometry,r=this.index.array,i=this.attributes;for(const n in i){const s=t(i[n],r);e.setAttribute(n,s)}const n=this.morphAttributes;for(const i in n){const s=[],a=n[i];for(let e=0,i=a.length;e<i;e++){const i=t(a[e],r);s.push(i)}e.morphAttributes[i]=s}e.morphTargetsRelative=this.morphTargetsRelative;const s=this.groups;for(let t=0,r=s.length;t<r;t++){const r=s[t];e.addGroup(r.start,r.count,r.materialIndex)}return e}toJSON(){const t={metadata:{version:4.6,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(t.uuid=this.uuid,t.type=this.type,""!==this.name&&(t.name=this.name),Object.keys(this.userData).length>0&&(t.userData=this.userData),void 0!==this.parameters){const e=this.parameters;for(const r in e)void 0!==e[r]&&(t[r]=e[r]);return t}t.data={attributes:{}};const e=this.index;null!==e&&(t.data.index={type:e.array.constructor.name,array:Array.prototype.slice.call(e.array)});const r=this.attributes;for(const e in r){const i=r[e];t.data.attributes[e]=i.toJSON(t.data)}const i={};let n=!1;for(const e in this.morphAttributes){const r=this.morphAttributes[e],s=[];for(let e=0,i=r.length;e<i;e++){const i=r[e];s.push(i.toJSON(t.data))}s.length>0&&(i[e]=s,n=!0)}n&&(t.data.morphAttributes=i,t.data.morphTargetsRelative=this.morphTargetsRelative);const s=this.groups;s.length>0&&(t.data.groups=JSON.parse(JSON.stringify(s)));const a=this.boundingSphere;return null!==a&&(t.data.boundingSphere={center:a.center.toArray(),radius:a.radius}),t}clone(){return(new this.constructor).copy(this)}copy(t){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const e={};this.name=t.name;const r=t.index;null!==r&&this.setIndex(r.clone(e));const i=t.attributes;for(const t in i){const r=i[t];this.setAttribute(t,r.clone(e))}const n=t.morphAttributes;for(const t in n){const r=[],i=n[t];for(let t=0,n=i.length;t<n;t++)r.push(i[t].clone(e));this.morphAttributes[t]=r}this.morphTargetsRelative=t.morphTargetsRelative;const s=t.groups;for(let t=0,e=s.length;t<e;t++){const e=s[t];this.addGroup(e.start,e.count,e.materialIndex)}const a=t.boundingBox;null!==a&&(this.boundingBox=a.clone());const o=t.boundingSphere;return null!==o&&(this.boundingSphere=o.clone()),this.drawRange.start=t.drawRange.start,this.drawRange.count=t.drawRange.count,this.userData=t.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}class SphereGeometry extends BufferGeometry{constructor(t=1,e=32,r=16,i=0,n=2*Math.PI,s=0,a=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:t,widthSegments:e,heightSegments:r,phiStart:i,phiLength:n,thetaStart:s,thetaLength:a},e=Math.max(3,Math.floor(e)),r=Math.max(2,Math.floor(r));const o=Math.min(s+a,Math.PI);let h=0;const c=[],l=new Vector3,u=new Vector3,d=[],p=[],_=[],m=[];for(let d=0;d<=r;d++){const f=[],E=d/r;let T=0;0===d&&0===s?T=.5/e:d===r&&o===Math.PI&&(T=-.5/e);for(let r=0;r<=e;r++){const o=r/e;l.x=-t*Math.cos(i+o*n)*Math.sin(s+E*a),l.y=t*Math.cos(s+E*a),l.z=t*Math.sin(i+o*n)*Math.sin(s+E*a),p.push(l.x,l.y,l.z),u.copy(l).normalize(),_.push(u.x,u.y,u.z),m.push(o+T,1-E),f.push(h++)}c.push(f)}for(let t=0;t<r;t++)for(let i=0;i<e;i++){const e=c[t][i+1],n=c[t][i],a=c[t+1][i],h=c[t+1][i+1];(0!==t||s>0)&&d.push(e,n,h),(t!==r-1||o<Math.PI)&&d.push(n,a,h)}this.setIndex(d),this.setAttribute("position",new Float32BufferAttribute(p,3)),this.setAttribute("normal",new Float32BufferAttribute(_,3)),this.setAttribute("uv",new Float32BufferAttribute(m,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new SphereGeometry(t.radius,t.widthSegments,t.heightSegments,t.phiStart,t.phiLength,t.thetaStart,t.thetaLength)}}function mergeVertices(t,e=1e-4){e=Math.max(e,Number.EPSILON);const r={},i=t.getIndex(),n=t.getAttribute("position"),s=i?i.count:n.count;let a=0;const o=Object.keys(t.attributes),h={},c={},l=[],u=["getX","getY","getZ","getW"],d=["setX","setY","setZ","setW"];for(let e=0,r=o.length;e<r;e++){const r=o[e],i=t.attributes[r];h[r]=new i.constructor(new i.array.constructor(i.count*i.itemSize),i.itemSize,i.normalized);const n=t.morphAttributes[r];n&&(c[r]||(c[r]=[]),n.forEach(((t,e)=>{const i=new t.array.constructor(t.count*t.itemSize);c[r][e]=new t.constructor(i,t.itemSize,t.normalized)})))}const p=.5*e,_=Math.log10(1/e),m=Math.pow(10,_),f=p*m;for(let e=0;e<s;e++){const n=i?i.getX(e):e;let s="";for(let e=0,r=o.length;e<r;e++){const r=o[e],i=t.getAttribute(r),a=i.itemSize;for(let t=0;t<a;t++)s+=~~(i[u[t]](n)*m+f)+","}if(s in r)l.push(r[s]);else{for(let e=0,r=o.length;e<r;e++){const r=o[e],i=t.getAttribute(r),s=t.morphAttributes[r],l=i.itemSize,p=h[r],_=c[r];for(let t=0;t<l;t++){const e=u[t],r=d[t];if(p[r](a,i[e](n)),s)for(let t=0,i=s.length;t<i;t++)_[t][r](a,s[t][e](n))}}r[s]=a,l.push(a),a++}}const E=t.clone();for(const e in t.attributes){const t=h[e];if(E.setAttribute(e,new t.constructor(t.array.slice(0,a*t.itemSize),t.itemSize,t.normalized)),e in c)for(let t=0;t<c[e].length;t++){const r=c[e][t];E.morphAttributes[e][t]=new r.constructor(r.array.slice(0,a*r.itemSize),r.itemSize,r.normalized)}}return E.setIndex(l),E}"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:"166"}})),"undefined"!=typeof window&&(window.__THREE__||(window.__THREE__="166")),new Matrix4;const interleaved=t=>{t.itemSize;let e=t.data.stride,r=[];for(let i=t.offset;i<t.data.array.length;i+=e)r.push(t.data.array[i],t.data.array[i+1],t.data.array[i+2],t.data.array[i+3]);return r},attribute=t=>t.constructor.name.endsWith("InterleavedBufferAttribute")?interleaved(t):t.array,iattribute=t=>new Uint32Array(attribute(t)),fattribute=t=>new Float32Array(attribute(t)),geometry=t=>{let e=t.attributes.position.array.length/3;if(!t.attributes.uv){let r=new Float32Array(2*e);t.setAttribute("uv",new BufferAttribute(r,2,!1))}return t.index||(t=mergeVertices(t)),t.attributes.normal||t.computeVertexNormals(),t.computeTangents(),new MeshData(iattribute(t.index),fattribute(t.attributes.position),fattribute(t.attributes.uv),fattribute(t.attributes.normal),fattribute(t.attributes.tangent),t.attributes.skinIndex?iattribute(t.attributes.skinIndex):new Uint32Array(4*e),t.attributes.skinWeight?fattribute(t.attributes.skinWeight):new Float32Array(4*e))},translate=(t,e,r)=>[1,0,0,0,0,1,0,0,0,0,1,0,t,e,r,1],perspective_vfov_r=(t,e,r,i)=>{let n=Math.tan(.5*Math.PI-.5*t),s=1/(r-i);return[n/e,0,0,0,0,n,0,0,0,0,(r+i)*s*1,-1,0,0,r*i*s*2,0]},radians=t=>t*Math.PI/180,perspective=(t,e,r,i)=>perspective_vfov_r(radians(t),e,r,i),mul=(t,e)=>[t[0]*e[0]+t[4]*e[1]+t[8]*e[2]+t[12]*e[3],t[1]*e[0]+t[5]*e[1]+t[9]*e[2]+t[13]*e[3],t[2]*e[0]+t[6]*e[1]+t[10]*e[2]+t[14]*e[3],t[3]*e[0]+t[7]*e[1]+t[11]*e[2]+t[15]*e[3],t[0]*e[4]+t[4]*e[5]+t[8]*e[6]+t[12]*e[7],t[1]*e[4]+t[5]*e[5]+t[9]*e[6]+t[13]*e[7],t[2]*e[4]+t[6]*e[5]+t[10]*e[6]+t[14]*e[7],t[3]*e[4]+t[7]*e[5]+t[11]*e[6]+t[15]*e[7],t[0]*e[8]+t[4]*e[9]+t[8]*e[10]+t[12]*e[11],t[1]*e[8]+t[5]*e[9]+t[9]*e[10]+t[13]*e[11],t[2]*e[8]+t[6]*e[9]+t[10]*e[10]+t[14]*e[11],t[3]*e[8]+t[7]*e[9]+t[11]*e[10]+t[15]*e[11],t[0]*e[12]+t[4]*e[13]+t[8]*e[14]+t[12]*e[15],t[1]*e[12]+t[5]*e[13]+t[9]*e[14]+t[13]*e[15],t[2]*e[12]+t[6]*e[13]+t[10]*e[14]+t[14]*e[15],t[3]*e[12]+t[7]*e[13]+t[11]*e[14]+t[15]*e[15]];new Vector3;const sphere=()=>geometry(new SphereGeometry);let __Process$={};var sr=Object.create,ke=Object.defineProperty,or=Object.getOwnPropertyDescriptor,ar=Object.getOwnPropertyNames,cr=Object.getPrototypeOf,fr=Object.prototype.hasOwnProperty,hr=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),Q=(t,e)=>{for(var r in e)ke(t,r,{get:e[r],enumerable:!0})},pr=(t,e,r,i)=>{if(e&&"object"==typeof e||"function"==typeof e)for(let n of ar(e))!fr.call(t,n)&&n!==r&&ke(t,n,{get:()=>e[n],enumerable:!(i=or(e,n))||i.enumerable});return t},Rt=(t,e,r)=>(r=null!=t?sr(cr(t)):{},pr(t&&t.__esModule?r:ke(r,"default",{value:t,enumerable:!0}),t)),it=hr(((t,e)=>{var r={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};r.localCName=r.generateIdentifier(),r.splitLines=function(t){return t.trim().split("\n").map((t=>t.trim()))},r.splitSections=function(t){return t.split("\nm=").map(((t,e)=>(e>0?"m="+t:t).trim()+"\r\n"))},r.getDescription=function(t){let e=r.splitSections(t);return e&&e[0]},r.getMediaSections=function(t){let e=r.splitSections(t);return e.shift(),e},r.matchPrefix=function(t,e){return r.splitLines(t).filter((t=>0===t.indexOf(e)))},r.parseCandidate=function(t){let e;e=0===t.indexOf("a=candidate:")?t.substring(12).split(" "):t.substring(10).split(" ");let r={foundation:e[0],component:{1:"rtp",2:"rtcp"}[e[1]]||e[1],protocol:e[2].toLowerCase(),priority:parseInt(e[3],10),ip:e[4],address:e[4],port:parseInt(e[5],10),type:e[7]};for(let t=8;t<e.length;t+=2)switch(e[t]){case"raddr":r.relatedAddress=e[t+1];break;case"rport":r.relatedPort=parseInt(e[t+1],10);break;case"tcptype":r.tcpType=e[t+1];break;case"ufrag":r.ufrag=e[t+1],r.usernameFragment=e[t+1];break;default:void 0===r[e[t]]&&(r[e[t]]=e[t+1])}return r},r.writeCandidate=function(t){let e=[];e.push(t.foundation);let r=t.component;"rtp"===r?e.push(1):"rtcp"===r?e.push(2):e.push(r),e.push(t.protocol.toUpperCase()),e.push(t.priority),e.push(t.address||t.ip),e.push(t.port);let i=t.type;return e.push("typ"),e.push(i),"host"!==i&&t.relatedAddress&&t.relatedPort&&(e.push("raddr"),e.push(t.relatedAddress),e.push("rport"),e.push(t.relatedPort)),t.tcpType&&"tcp"===t.protocol.toLowerCase()&&(e.push("tcptype"),e.push(t.tcpType)),(t.usernameFragment||t.ufrag)&&(e.push("ufrag"),e.push(t.usernameFragment||t.ufrag)),"candidate:"+e.join(" ")},r.parseIceOptions=function(t){return t.substring(14).split(" ")},r.parseRtpMap=function(t){let e=t.substring(9).split(" "),r={payloadType:parseInt(e.shift(),10)};return e=e[0].split("/"),r.name=e[0],r.clockRate=parseInt(e[1],10),r.channels=3===e.length?parseInt(e[2],10):1,r.numChannels=r.channels,r},r.writeRtpMap=function(t){let e=t.payloadType;void 0!==t.preferredPayloadType&&(e=t.preferredPayloadType);let r=t.channels||t.numChannels||1;return"a=rtpmap:"+e+" "+t.name+"/"+t.clockRate+(1!==r?"/"+r:"")+"\r\n"},r.parseExtmap=function(t){let e=t.substring(9).split(" ");return{id:parseInt(e[0],10),direction:e[0].indexOf("/")>0?e[0].split("/")[1]:"sendrecv",uri:e[1],attributes:e.slice(2).join(" ")}},r.writeExtmap=function(t){return"a=extmap:"+(t.id||t.preferredId)+(t.direction&&"sendrecv"!==t.direction?"/"+t.direction:"")+" "+t.uri+(t.attributes?" "+t.attributes:"")+"\r\n"},r.parseFmtp=function(t){let e,r={},i=t.substring(t.indexOf(" ")+1).split(";");for(let t=0;t<i.length;t++)e=i[t].trim().split("="),r[e[0].trim()]=e[1];return r},r.writeFmtp=function(t){let e="",r=t.payloadType;if(void 0!==t.preferredPayloadType&&(r=t.preferredPayloadType),t.parameters&&Object.keys(t.parameters).length){let i=[];Object.keys(t.parameters).forEach((e=>{void 0!==t.parameters[e]?i.push(e+"="+t.parameters[e]):i.push(e)})),e+="a=fmtp:"+r+" "+i.join(";")+"\r\n"}return e},r.parseRtcpFb=function(t){let e=t.substring(t.indexOf(" ")+1).split(" ");return{type:e.shift(),parameter:e.join(" ")}},r.writeRtcpFb=function(t){let e="",r=t.payloadType;return void 0!==t.preferredPayloadType&&(r=t.preferredPayloadType),t.rtcpFeedback&&t.rtcpFeedback.length&&t.rtcpFeedback.forEach((t=>{e+="a=rtcp-fb:"+r+" "+t.type+(t.parameter&&t.parameter.length?" "+t.parameter:"")+"\r\n"})),e},r.parseSsrcMedia=function(t){let e=t.indexOf(" "),r={ssrc:parseInt(t.substring(7,e),10)},i=t.indexOf(":",e);return i>-1?(r.attribute=t.substring(e+1,i),r.value=t.substring(i+1)):r.attribute=t.substring(e+1),r},r.parseSsrcGroup=function(t){let e=t.substring(13).split(" ");return{semantics:e.shift(),ssrcs:e.map((t=>parseInt(t,10)))}},r.getMid=function(t){let e=r.matchPrefix(t,"a=mid:")[0];if(e)return e.substring(6)},r.parseFingerprint=function(t){let e=t.substring(14).split(" ");return{algorithm:e[0].toLowerCase(),value:e[1].toUpperCase()}},r.getDtlsParameters=function(t,e){return{role:"auto",fingerprints:r.matchPrefix(t+e,"a=fingerprint:").map(r.parseFingerprint)}},r.writeDtlsParameters=function(t,e){let r="a=setup:"+e+"\r\n";return t.fingerprints.forEach((t=>{r+="a=fingerprint:"+t.algorithm+" "+t.value+"\r\n"})),r},r.parseCryptoLine=function(t){let e=t.substring(9).split(" ");return{tag:parseInt(e[0],10),cryptoSuite:e[1],keyParams:e[2],sessionParams:e.slice(3)}},r.writeCryptoLine=function(t){return"a=crypto:"+t.tag+" "+t.cryptoSuite+" "+("object"==typeof t.keyParams?r.writeCryptoKeyParams(t.keyParams):t.keyParams)+(t.sessionParams?" "+t.sessionParams.join(" "):"")+"\r\n"},r.parseCryptoKeyParams=function(t){if(0!==t.indexOf("inline:"))return null;let e=t.substring(7).split("|");return{keyMethod:"inline",keySalt:e[0],lifeTime:e[1],mkiValue:e[2]?e[2].split(":")[0]:void 0,mkiLength:e[2]?e[2].split(":")[1]:void 0}},r.writeCryptoKeyParams=function(t){return t.keyMethod+":"+t.keySalt+(t.lifeTime?"|"+t.lifeTime:"")+(t.mkiValue&&t.mkiLength?"|"+t.mkiValue+":"+t.mkiLength:"")},r.getCryptoParameters=function(t,e){return r.matchPrefix(t+e,"a=crypto:").map(r.parseCryptoLine)},r.getIceParameters=function(t,e){let i=r.matchPrefix(t+e,"a=ice-ufrag:")[0],n=r.matchPrefix(t+e,"a=ice-pwd:")[0];return i&&n?{usernameFragment:i.substring(12),password:n.substring(10)}:null},r.writeIceParameters=function(t){let e="a=ice-ufrag:"+t.usernameFragment+"\r\na=ice-pwd:"+t.password+"\r\n";return t.iceLite&&(e+="a=ice-lite\r\n"),e},r.parseRtpParameters=function(t){let e={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=r.splitLines(t)[0].split(" ");e.profile=i[2];for(let n=3;n<i.length;n++){let s=i[n],a=r.matchPrefix(t,"a=rtpmap:"+s+" ")[0];if(a){let i=r.parseRtpMap(a),n=r.matchPrefix(t,"a=fmtp:"+s+" ");switch(i.parameters=n.length?r.parseFmtp(n[0]):{},i.rtcpFeedback=r.matchPrefix(t,"a=rtcp-fb:"+s+" ").map(r.parseRtcpFb),e.codecs.push(i),i.name.toUpperCase()){case"RED":case"ULPFEC":e.fecMechanisms.push(i.name.toUpperCase())}}}r.matchPrefix(t,"a=extmap:").forEach((t=>{e.headerExtensions.push(r.parseExtmap(t))}));let n=r.matchPrefix(t,"a=rtcp-fb:* ").map(r.parseRtcpFb);return e.codecs.forEach((t=>{n.forEach((e=>{t.rtcpFeedback.find((t=>t.type===e.type&&t.parameter===e.parameter))||t.rtcpFeedback.push(e)}))})),e},r.writeRtpDescription=function(t,e){let i="";i+="m="+t+" ",i+=e.codecs.length>0?"9":"0",i+=" "+(e.profile||"UDP/TLS/RTP/SAVPF")+" ",i+=e.codecs.map((t=>void 0!==t.preferredPayloadType?t.preferredPayloadType:t.payloadType)).join(" ")+"\r\n",i+="c=IN IP4 0.0.0.0\r\n",i+="a=rtcp:9 IN IP4 0.0.0.0\r\n",e.codecs.forEach((t=>{i+=r.writeRtpMap(t),i+=r.writeFmtp(t),i+=r.writeRtcpFb(t)}));let n=0;return e.codecs.forEach((t=>{t.maxptime>n&&(n=t.maxptime)})),n>0&&(i+="a=maxptime:"+n+"\r\n"),e.headerExtensions&&e.headerExtensions.forEach((t=>{i+=r.writeExtmap(t)})),i},r.parseRtpEncodingParameters=function(t){let e,i=[],n=r.parseRtpParameters(t),s=-1!==n.fecMechanisms.indexOf("RED"),a=-1!==n.fecMechanisms.indexOf("ULPFEC"),o=r.matchPrefix(t,"a=ssrc:").map((t=>r.parseSsrcMedia(t))).filter((t=>"cname"===t.attribute)),h=o.length>0&&o[0].ssrc,c=r.matchPrefix(t,"a=ssrc-group:FID").map((t=>t.substring(17).split(" ").map((t=>parseInt(t,10)))));c.length>0&&c[0].length>1&&c[0][0]===h&&(e=c[0][1]),n.codecs.forEach((t=>{if("RTX"===t.name.toUpperCase()&&t.parameters.apt){let r={ssrc:h,codecPayloadType:parseInt(t.parameters.apt,10)};h&&e&&(r.rtx={ssrc:e}),i.push(r),s&&(r=JSON.parse(JSON.stringify(r)),r.fec={ssrc:h,mechanism:a?"red+ulpfec":"red"},i.push(r))}})),0===i.length&&h&&i.push({ssrc:h});let l=r.matchPrefix(t,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substring(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substring(5),10)*.95-16e3:void 0,i.forEach((t=>{t.maxBitrate=l}))),i},r.parseRtcpParameters=function(t){let e={},i=r.matchPrefix(t,"a=ssrc:").map((t=>r.parseSsrcMedia(t))).filter((t=>"cname"===t.attribute))[0];i&&(e.cname=i.value,e.ssrc=i.ssrc);let n=r.matchPrefix(t,"a=rtcp-rsize");e.reducedSize=n.length>0,e.compound=0===n.length;let s=r.matchPrefix(t,"a=rtcp-mux");return e.mux=s.length>0,e},r.writeRtcpParameters=function(t){let e="";return t.reducedSize&&(e+="a=rtcp-rsize\r\n"),t.mux&&(e+="a=rtcp-mux\r\n"),void 0!==t.ssrc&&t.cname&&(e+="a=ssrc:"+t.ssrc+" cname:"+t.cname+"\r\n"),e},r.parseMsid=function(t){let e,i=r.matchPrefix(t,"a=msid:");if(1===i.length)return e=i[0].substring(7).split(" "),{stream:e[0],track:e[1]};let n=r.matchPrefix(t,"a=ssrc:").map((t=>r.parseSsrcMedia(t))).filter((t=>"msid"===t.attribute));return n.length>0?(e=n[0].value.split(" "),{stream:e[0],track:e[1]}):void 0},r.parseSctpDescription=function(t){let e,i=r.parseMLine(t),n=r.matchPrefix(t,"a=max-message-size:");n.length>0&&(e=parseInt(n[0].substring(19),10)),isNaN(e)&&(e=65536);let s=r.matchPrefix(t,"a=sctp-port:");if(s.length>0)return{port:parseInt(s[0].substring(12),10),protocol:i.fmt,maxMessageSize:e};let a=r.matchPrefix(t,"a=sctpmap:");if(a.length>0){let t=a[0].substring(10).split(" ");return{port:parseInt(t[0],10),protocol:t[1],maxMessageSize:e}}},r.writeSctpDescription=function(t,e){let r=[];return r="DTLS/SCTP"!==t.protocol?["m="+t.kind+" 9 "+t.protocol+" "+e.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+e.port+"\r\n"]:["m="+t.kind+" 9 "+t.protocol+" "+e.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+e.port+" "+e.protocol+" 65535\r\n"],void 0!==e.maxMessageSize&&r.push("a=max-message-size:"+e.maxMessageSize+"\r\n"),r.join("")},r.generateSessionId=function(){return Math.random().toString().substr(2,22)},r.writeSessionBoilerplate=function(t,e,i){let n,s=void 0!==e?e:2;return n=t||r.generateSessionId(),"v=0\r\no="+(i||"thisisadapterortc")+" "+n+" "+s+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},r.getDirection=function(t,e){let i=r.splitLines(t);for(let t=0;t<i.length;t++)switch(i[t]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[t].substring(2)}return e?r.getDirection(e):"sendrecv"},r.getKind=function(t){return r.splitLines(t)[0].split(" ")[0].substring(2)},r.isRejected=function(t){return"0"===t.split(" ",2)[1]},r.parseMLine=function(t){let e=r.splitLines(t)[0].substring(2).split(" ");return{kind:e[0],port:parseInt(e[1],10),protocol:e[2],fmt:e.slice(3).join(" ")}},r.parseOLine=function(t){let e=r.matchPrefix(t,"o=")[0].substring(2).split(" ");return{username:e[0],sessionId:e[1],sessionVersion:parseInt(e[2],10),netType:e[3],addressType:e[4],address:e[5]}},r.isValidSDP=function(t){if("string"!=typeof t||0===t.length)return!1;let e=r.splitLines(t);for(let t=0;t<e.length;t++)if(e[t].length<2||"="!==e[t].charAt(1))return!1;return!0},"object"==typeof e&&(e.exports=r)})),Ee=class{constructor(){this.encoder=new TextEncoder,this._pieces=[],this._parts=[]}append_buffer(t){this.flush(),this._parts.push(t)}append(t){this._pieces.push(t)}flush(){if(this._pieces.length>0){let t=new Uint8Array(this._pieces);this._parts.push(t),this._pieces=[]}}toArrayBuffer(){let t=[];for(let e of this._parts)t.push(e);return ur(t).buffer}};function ur(t){let e=0;for(let r of t)e+=r.byteLength;let r=new Uint8Array(e),i=0;for(let e of t){let t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);r.set(t,i),i+=e.byteLength}return r}function De(t){return new Re(t).unpack()}function Ie(t){let e=new Pe,r=e.pack(t);return r instanceof Promise?r.then((()=>e.getBuffer())):e.getBuffer()}var Re=class{constructor(t){this.index=0,this.dataBuffer=t,this.dataView=new Uint8Array(this.dataBuffer),this.length=this.dataBuffer.byteLength}unpack(){let t,e=this.unpack_uint8();if(e<128)return e;if((224^e)<32)return(224^e)-32;if((t=160^e)<=15)return this.unpack_raw(t);if((t=176^e)<=15)return this.unpack_string(t);if((t=144^e)<=15)return this.unpack_array(t);if((t=128^e)<=15)return this.unpack_map(t);switch(e){case 192:return null;case 193:case 212:case 213:case 214:case 215:return;case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 216:return t=this.unpack_uint16(),this.unpack_string(t);case 217:return t=this.unpack_uint32(),this.unpack_string(t);case 218:return t=this.unpack_uint16(),this.unpack_raw(t);case 219:return t=this.unpack_uint32(),this.unpack_raw(t);case 220:return t=this.unpack_uint16(),this.unpack_array(t);case 221:return t=this.unpack_uint32(),this.unpack_array(t);case 222:return t=this.unpack_uint16(),this.unpack_map(t);case 223:return t=this.unpack_uint32(),this.unpack_map(t)}}unpack_uint8(){let t=255&this.dataView[this.index];return this.index++,t}unpack_uint16(){let t=this.read(2),e=256*(255&t[0])+(255&t[1]);return this.index+=2,e}unpack_uint32(){let t=this.read(4),e=256*(256*(256*t[0]+t[1])+t[2])+t[3];return this.index+=4,e}unpack_uint64(){let t=this.read(8),e=256*(256*(256*(256*(256*(256*(256*t[0]+t[1])+t[2])+t[3])+t[4])+t[5])+t[6])+t[7];return this.index+=8,e}unpack_int8(){let t=this.unpack_uint8();return t<128?t:t-256}unpack_int16(){let t=this.unpack_uint16();return t<32768?t:t-65536}unpack_int32(){let t=this.unpack_uint32();return t<2**31?t:t-2**32}unpack_int64(){let t=this.unpack_uint64();return t<2**63?t:t-2**64}unpack_raw(t){if(this.length<this.index+t)throw new Error(`BinaryPackFailure: index is out of range ${this.index} ${t} ${this.length}`);let e=this.dataBuffer.slice(this.index,this.index+t);return this.index+=t,e}unpack_string(t){let e,r,i=this.read(t),n=0,s="";for(;n<t;)e=i[n],e<160?(r=e,n++):(192^e)<32?(r=(31&e)<<6|63&i[n+1],n+=2):(224^e)<16?(r=(15&e)<<12|(63&i[n+1])<<6|63&i[n+2],n+=3):(r=(7&e)<<18|(63&i[n+1])<<12|(63&i[n+2])<<6|63&i[n+3],n+=4),s+=String.fromCodePoint(r);return this.index+=t,s}unpack_array(t){let e=new Array(t);for(let r=0;r<t;r++)e[r]=this.unpack();return e}unpack_map(t){let e={};for(let r=0;r<t;r++){e[this.unpack()]=this.unpack()}return e}unpack_float(){let t=this.unpack_uint32();return(0===t>>31?1:-1)*(8388607&t|8388608)*2**((t>>23&255)-127-23)}unpack_double(){let t=this.unpack_uint32(),e=(t>>20&2047)-1023;return(0===t>>31?1:-1)*((1048575&t|1048576)*2**(e-20)+this.unpack_uint32()*2**(e-52))}read(t){let e=this.index;if(e+t<=this.length)return this.dataView.subarray(e,e+t);throw new Error("BinaryPackFailure: read index out of range")}},Pe=class{getBuffer(){return this._bufferBuilder.toArrayBuffer()}pack(t){if("string"==typeof t)this.pack_string(t);else if("number"==typeof t)Math.floor(t)===t?this.pack_integer(t):this.pack_double(t);else if("boolean"==typeof t)!0===t?this._bufferBuilder.append(195):!1===t&&this._bufferBuilder.append(194);else if(void 0===t)this._bufferBuilder.append(192);else{if("object"!=typeof t)throw new Error(`Type "${typeof t}" not yet supported`);if(null===t)this._bufferBuilder.append(192);else{let e=t.constructor;if(t instanceof Array){let e=this.pack_array(t);if(e instanceof Promise)return e.then((()=>this._bufferBuilder.flush()))}else if(t instanceof ArrayBuffer)this.pack_bin(new Uint8Array(t));else if("BYTES_PER_ELEMENT"in t){let e=t;this.pack_bin(new Uint8Array(e.buffer,e.byteOffset,e.byteLength))}else if(t instanceof Date)this.pack_string(t.toString());else{if(t instanceof Blob)return t.arrayBuffer().then((t=>{this.pack_bin(new Uint8Array(t)),this._bufferBuilder.flush()}));if(e!=Object&&!e.toString().startsWith("class"))throw new Error(`Type "${e.toString()}" not yet supported`);{let e=this.pack_object(t);if(e instanceof Promise)return e.then((()=>this._bufferBuilder.flush()))}}}}this._bufferBuilder.flush()}pack_bin(t){let e=t.length;if(e<=15)this.pack_uint8(160+e);else if(e<=65535)this._bufferBuilder.append(218),this.pack_uint16(e);else{if(!(e<=4294967295))throw new Error("Invalid length");this._bufferBuilder.append(219),this.pack_uint32(e)}this._bufferBuilder.append_buffer(t)}pack_string(t){let e=this._textEncoder.encode(t),r=e.length;if(r<=15)this.pack_uint8(176+r);else if(r<=65535)this._bufferBuilder.append(216),this.pack_uint16(r);else{if(!(r<=4294967295))throw new Error("Invalid length");this._bufferBuilder.append(217),this.pack_uint32(r)}this._bufferBuilder.append_buffer(e)}pack_array(t){let e=t.length;if(e<=15)this.pack_uint8(144+e);else if(e<=65535)this._bufferBuilder.append(220),this.pack_uint16(e);else{if(!(e<=4294967295))throw new Error("Invalid length");this._bufferBuilder.append(221),this.pack_uint32(e)}let r=i=>{if(i<e){let e=this.pack(t[i]);return e instanceof Promise?e.then((()=>r(i+1))):r(i+1)}};return r(0)}pack_integer(t){if(t>=-32&&t<=127)this._bufferBuilder.append(255&t);else if(t>=0&&t<=255)this._bufferBuilder.append(204),this.pack_uint8(t);else if(t>=-128&&t<=127)this._bufferBuilder.append(208),this.pack_int8(t);else if(t>=0&&t<=65535)this._bufferBuilder.append(205),this.pack_uint16(t);else if(t>=-32768&&t<=32767)this._bufferBuilder.append(209),this.pack_int16(t);else if(t>=0&&t<=4294967295)this._bufferBuilder.append(206),this.pack_uint32(t);else if(t>=-2147483648&&t<=2147483647)this._bufferBuilder.append(210),this.pack_int32(t);else if(t>=-0x8000000000000000&&t<=0x8000000000000000)this._bufferBuilder.append(211),this.pack_int64(t);else{if(!(t>=0&&t<=0x10000000000000000))throw new Error("Invalid integer");this._bufferBuilder.append(207),this.pack_uint64(t)}}pack_double(t){let e=0;t<0&&(e=1,t=-t);let r=Math.floor(Math.log(t)/Math.LN2),i=t/2**r-1,n=Math.floor(i*2**52),s=2**32,a=e<<31|r+1023<<20|n/s&1048575,o=n%s;this._bufferBuilder.append(203),this.pack_int32(a),this.pack_int32(o)}pack_object(t){let e=Object.keys(t),r=e.length;if(r<=15)this.pack_uint8(128+r);else if(r<=65535)this._bufferBuilder.append(222),this.pack_uint16(r);else{if(!(r<=4294967295))throw new Error("Invalid length");this._bufferBuilder.append(223),this.pack_uint32(r)}let i=r=>{if(r<e.length){let n=e[r];if(t.hasOwnProperty(n)){this.pack(n);let e=this.pack(t[n]);if(e instanceof Promise)return e.then((()=>i(r+1)))}return i(r+1)}};return i(0)}pack_uint8(t){this._bufferBuilder.append(t)}pack_uint16(t){this._bufferBuilder.append(t>>8),this._bufferBuilder.append(255&t)}pack_uint32(t){let e=4294967295&t;this._bufferBuilder.append((4278190080&e)>>>24),this._bufferBuilder.append((16711680&e)>>>16),this._bufferBuilder.append((65280&e)>>>8),this._bufferBuilder.append(255&e)}pack_uint64(t){let e=t/4294967296,r=t%2**32;this._bufferBuilder.append((4278190080&e)>>>24),this._bufferBuilder.append((16711680&e)>>>16),this._bufferBuilder.append((65280&e)>>>8),this._bufferBuilder.append(255&e),this._bufferBuilder.append((4278190080&r)>>>24),this._bufferBuilder.append((16711680&r)>>>16),this._bufferBuilder.append((65280&r)>>>8),this._bufferBuilder.append(255&r)}pack_int8(t){this._bufferBuilder.append(255&t)}pack_int16(t){this._bufferBuilder.append((65280&t)>>8),this._bufferBuilder.append(255&t)}pack_int32(t){this._bufferBuilder.append(t>>>24&255),this._bufferBuilder.append((16711680&t)>>>16),this._bufferBuilder.append((65280&t)>>>8),this._bufferBuilder.append(255&t)}pack_int64(t){let e=Math.floor(t/4294967296),r=t%2**32;this._bufferBuilder.append((4278190080&e)>>>24),this._bufferBuilder.append((16711680&e)>>>16),this._bufferBuilder.append((65280&e)>>>8),this._bufferBuilder.append(255&e),this._bufferBuilder.append((4278190080&r)>>>24),this._bufferBuilder.append((16711680&r)>>>16),this._bufferBuilder.append((65280&r)>>>8),this._bufferBuilder.append(255&r)}constructor(){this._bufferBuilder=new Ee,this._textEncoder=new TextEncoder}},Dt=!0,It=!0;function z(t,e,r){let i=t.match(e);return i&&i.length>=r&&parseInt(i[r],10)}function T(t,e,r){if(!t.RTCPeerConnection)return;let i=t.RTCPeerConnection.prototype,n=i.addEventListener;i.addEventListener=function(t,i){if(t!==e)return n.apply(this,arguments);let s=t=>{let e=r(t);e&&(i.handleEvent?i.handleEvent(e):i(e))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(i,s),n.apply(this,[t,s])};let s=i.removeEventListener;i.removeEventListener=function(t,r){if(t!==e||!this._eventMap||!this._eventMap[e])return s.apply(this,arguments);if(!this._eventMap[e].has(r))return s.apply(this,arguments);let i=this._eventMap[e].get(r);return this._eventMap[e].delete(r),0===this._eventMap[e].size&&delete this._eventMap[e],0===Object.keys(this._eventMap).length&&delete this._eventMap,s.apply(this,[t,i])},Object.defineProperty(i,"on"+e,{get(){return this["_on"+e]},set(t){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),t&&this.addEventListener(e,this["_on"+e]=t)},enumerable:!0,configurable:!0})}function Mt(t){return"boolean"!=typeof t?new Error("Argument type: "+typeof t+". Please use a boolean."):(Dt=t,t?"adapter.js logging disabled":"adapter.js logging enabled")}function At(t){return"boolean"!=typeof t?new Error("Argument type: "+typeof t+". Please use a boolean."):(It=!t,"adapter.js deprecation warnings "+(t?"disabled":"enabled"))}function ee(){if("object"==typeof window){if(Dt)return;typeof console<"u"&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function A(t,e){It&&console.warn(t+" is deprecated, please use "+e+" instead.")}function Ut(t){let e={browser:null,version:null};if(typeof t>"u"||!t.navigator||!t.navigator.userAgent)return e.browser="Not a browser.",e;let{navigator:r}=t;if(r.userAgentData&&r.userAgentData.brands){let t=r.userAgentData.brands.find((t=>"Chromium"===t.brand));if(t)return{browser:"chrome",version:parseInt(t.version,10)}}if(r.mozGetUserMedia)e.browser="firefox",e.version=z(r.userAgent,/Firefox\/(\d+)\./,1);else if(r.webkitGetUserMedia||!1===t.isSecureContext&&t.webkitRTCPeerConnection)e.browser="chrome",e.version=z(r.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!t.RTCPeerConnection||!r.userAgent.match(/AppleWebKit\/(\d+)\./))return e.browser="Not a supported browser.",e;e.browser="safari",e.version=z(r.userAgent,/AppleWebKit\/(\d+)\./,1),e.supportsUnifiedPlan=t.RTCRtpTransceiver&&"currentDirection"in t.RTCRtpTransceiver.prototype}return e}function Pt(t){return"[object Object]"===Object.prototype.toString.call(t)}function Ae(t){return Pt(t)?Object.keys(t).reduce((function(e,r){let i=Pt(t[r]),n=i?Ae(t[r]):t[r],s=i&&!Object.keys(n).length;return void 0===n||s?e:Object.assign(e,{[r]:n})}),{}):t}function Me(t,e,r){!e||r.has(e.id)||(r.set(e.id,e),Object.keys(e).forEach((i=>{i.endsWith("Id")?Me(t,t.get(e[i]),r):i.endsWith("Ids")&&e[i].forEach((e=>{Me(t,t.get(e),r)}))})))}function Ue(t,e,r){let i=r?"outbound-rtp":"inbound-rtp",n=new Map;if(null===e)return n;let s=[];return t.forEach((t=>{"track"===t.type&&t.trackIdentifier===e.id&&s.push(t)})),s.forEach((e=>{t.forEach((r=>{r.type===i&&r.trackId===e.id&&Me(t,r,n)}))})),n}var ne={};Q(ne,{fixNegotiationNeeded:()=>Fe,shimAddTrackRemoveTrack:()=>ze,shimAddTrackRemoveTrackWithNative:()=>wt,shimGetSendersWithDtmf:()=>Le,shimGetUserMedia:()=>te,shimMediaStream:()=>Oe,shimOnTrack:()=>we,shimPeerConnection:()=>re,shimSenderReceiverGetStats:()=>Be});var Ot=ee;function te(t,e){let r=t&&t.navigator;if(!r.mediaDevices)return;let i=function(t){if("object"!=typeof t||t.mandatory||t.optional)return t;let e={};return Object.keys(t).forEach((r=>{if("require"===r||"advanced"===r||"mediaSource"===r)return;let i="object"==typeof t[r]?t[r]:{ideal:t[r]};void 0!==i.exact&&"number"==typeof i.exact&&(i.min=i.max=i.exact);let n=function(t,e){return t?t+e.charAt(0).toUpperCase()+e.slice(1):"deviceId"===e?"sourceId":e};if(void 0!==i.ideal){e.optional=e.optional||[];let t={};"number"==typeof i.ideal?(t[n("min",r)]=i.ideal,e.optional.push(t),t={},t[n("max",r)]=i.ideal,e.optional.push(t)):(t[n("",r)]=i.ideal,e.optional.push(t))}void 0!==i.exact&&"number"!=typeof i.exact?(e.mandatory=e.mandatory||{},e.mandatory[n("",r)]=i.exact):["min","max"].forEach((t=>{void 0!==i[t]&&(e.mandatory=e.mandatory||{},e.mandatory[n(t,r)]=i[t])}))})),t.advanced&&(e.optional=(e.optional||[]).concat(t.advanced)),e},n=function(t,n){if(e.version>=61)return n(t);if((t=JSON.parse(JSON.stringify(t)))&&"object"==typeof t.audio){let e=function(t,e,r){e in t&&!(r in t)&&(t[r]=t[e],delete t[e])};e((t=JSON.parse(JSON.stringify(t))).audio,"autoGainControl","googAutoGainControl"),e(t.audio,"noiseSuppression","googNoiseSuppression"),t.audio=i(t.audio)}if(t&&"object"==typeof t.video){let s=t.video.facingMode;s=s&&("object"==typeof s?s:{ideal:s});let a=e.version<66;if(s&&("user"===s.exact||"environment"===s.exact||"user"===s.ideal||"environment"===s.ideal)&&(!r.mediaDevices.getSupportedConstraints||!r.mediaDevices.getSupportedConstraints().facingMode||a)){let e;if(delete t.video.facingMode,"environment"===s.exact||"environment"===s.ideal?e=["back","rear"]:("user"===s.exact||"user"===s.ideal)&&(e=["front"]),e)return r.mediaDevices.enumerateDevices().then((r=>{let a=(r=r.filter((t=>"videoinput"===t.kind))).find((t=>e.some((e=>t.label.toLowerCase().includes(e)))));return!a&&r.length&&e.includes("back")&&(a=r[r.length-1]),a&&(t.video.deviceId=s.exact?{exact:a.deviceId}:{ideal:a.deviceId}),t.video=i(t.video),Ot("chrome: "+JSON.stringify(t)),n(t)}))}t.video=i(t.video)}return Ot("chrome: "+JSON.stringify(t)),n(t)},s=function(t){return e.version>=64?t:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[t.name]||t.name,message:t.message,constraint:t.constraint||t.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(r.getUserMedia=function(t,e,i){n(t,(t=>{r.webkitGetUserMedia(t,e,(t=>{i&&i(s(t))}))}))}.bind(r),r.mediaDevices.getUserMedia){let t=r.mediaDevices.getUserMedia.bind(r.mediaDevices);r.mediaDevices.getUserMedia=function(e){return n(e,(e=>t(e).then((t=>{if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach((t=>{t.stop()})),new DOMException("","NotFoundError");return t}),(t=>Promise.reject(s(t))))))}}}function Oe(t){t.MediaStream=t.MediaStream||t.webkitMediaStream}function we(t){if("object"==typeof t&&t.RTCPeerConnection&&!("ontrack"in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(t){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=t)},enumerable:!0,configurable:!0});let e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=e=>{e.stream.addEventListener("addtrack",(r=>{let i;i=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((t=>t.track&&t.track.id===r.track.id)):{track:r.track};let n=new Event("track");n.track=r.track,n.receiver=i,n.transceiver={receiver:i},n.streams=[e.stream],this.dispatchEvent(n)})),e.stream.getTracks().forEach((r=>{let i;i=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((t=>t.track&&t.track.id===r.id)):{track:r};let n=new Event("track");n.track=r,n.receiver=i,n.transceiver={receiver:i},n.streams=[e.stream],this.dispatchEvent(n)}))},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else T(t,"track",(t=>(t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t)))}function Le(t){if("object"==typeof t&&t.RTCPeerConnection&&!("getSenders"in t.RTCPeerConnection.prototype)&&"createDTMFSender"in t.RTCPeerConnection.prototype){let e=function(t,e){return{track:e,get dtmf(){return void 0===this._dtmf&&("audio"===e.kind?this._dtmf=t.createDTMFSender(e):this._dtmf=null),this._dtmf},_pc:t}};if(!t.RTCPeerConnection.prototype.getSenders){t.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};let r=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(t,i){let n=r.apply(this,arguments);return n||(n=e(this,t),this._senders.push(n)),n};let i=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(t){i.apply(this,arguments);let e=this._senders.indexOf(t);-1!==e&&this._senders.splice(e,1)}}let r=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(t){this._senders=this._senders||[],r.apply(this,[t]),t.getTracks().forEach((t=>{this._senders.push(e(this,t))}))};let i=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(t){this._senders=this._senders||[],i.apply(this,[t]),t.getTracks().forEach((t=>{let e=this._senders.find((e=>e.track===t));e&&this._senders.splice(this._senders.indexOf(e),1)}))}}else if("object"==typeof t&&t.RTCPeerConnection&&"getSenders"in t.RTCPeerConnection.prototype&&"createDTMFSender"in t.RTCPeerConnection.prototype&&t.RTCRtpSender&&!("dtmf"in t.RTCRtpSender.prototype)){let e=t.RTCPeerConnection.prototype.getSenders;t.RTCPeerConnection.prototype.getSenders=function(){let t=e.apply(this,[]);return t.forEach((t=>t._pc=this)),t},Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function Be(t){if(!("object"==typeof t&&t.RTCPeerConnection&&t.RTCRtpSender&&t.RTCRtpReceiver))return;if(!("getStats"in t.RTCRtpSender.prototype)){let e=t.RTCPeerConnection.prototype.getSenders;e&&(t.RTCPeerConnection.prototype.getSenders=function(){let t=e.apply(this,[]);return t.forEach((t=>t._pc=this)),t});let r=t.RTCPeerConnection.prototype.addTrack;r&&(t.RTCPeerConnection.prototype.addTrack=function(){let t=r.apply(this,arguments);return t._pc=this,t}),t.RTCRtpSender.prototype.getStats=function(){let t=this;return this._pc.getStats().then((e=>Ue(e,t.track,!0)))}}if(!("getStats"in t.RTCRtpReceiver.prototype)){let e=t.RTCPeerConnection.prototype.getReceivers;e&&(t.RTCPeerConnection.prototype.getReceivers=function(){let t=e.apply(this,[]);return t.forEach((t=>t._pc=this)),t}),T(t,"track",(t=>(t.receiver._pc=t.srcElement,t))),t.RTCRtpReceiver.prototype.getStats=function(){let t=this;return this._pc.getStats().then((e=>Ue(e,t.track,!1)))}}if(!("getStats"in t.RTCRtpSender.prototype)||!("getStats"in t.RTCRtpReceiver.prototype))return;let e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof t.MediaStreamTrack){let t,e,r,i=arguments[0];return this.getSenders().forEach((e=>{e.track===i&&(t?r=!0:t=e)})),this.getReceivers().forEach((t=>(t.track===i&&(e?r=!0:e=t),t.track===i))),r||t&&e?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():e?e.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function wt(t){t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((t=>this._shimmedLocalStreams[t][0]))};let e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(t,r){if(!r)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};let i=e.apply(this,arguments);return this._shimmedLocalStreams[r.id]?-1===this._shimmedLocalStreams[r.id].indexOf(i)&&this._shimmedLocalStreams[r.id].push(i):this._shimmedLocalStreams[r.id]=[r,i],i};let r=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(t){this._shimmedLocalStreams=this._shimmedLocalStreams||{},t.getTracks().forEach((t=>{if(this.getSenders().find((e=>e.track===t)))throw new DOMException("Track already exists.","InvalidAccessError")}));let e=this.getSenders();r.apply(this,arguments);let i=this.getSenders().filter((t=>-1===e.indexOf(t)));this._shimmedLocalStreams[t.id]=[t].concat(i)};let i=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(t){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[t.id],i.apply(this,arguments)};let n=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(t){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},t&&Object.keys(this._shimmedLocalStreams).forEach((e=>{let r=this._shimmedLocalStreams[e].indexOf(t);-1!==r&&this._shimmedLocalStreams[e].splice(r,1),1===this._shimmedLocalStreams[e].length&&delete this._shimmedLocalStreams[e]})),n.apply(this,arguments)}}function ze(t,e){if(!t.RTCPeerConnection)return;if(t.RTCPeerConnection.prototype.addTrack&&e.version>=65)return wt(t);let r=t.RTCPeerConnection.prototype.getLocalStreams;t.RTCPeerConnection.prototype.getLocalStreams=function(){let t=r.apply(this);return this._reverseStreams=this._reverseStreams||{},t.map((t=>this._reverseStreams[t.id]))};let i=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(e){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},e.getTracks().forEach((t=>{if(this.getSenders().find((e=>e.track===t)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[e.id]){let r=new t.MediaStream(e.getTracks());this._streams[e.id]=r,this._reverseStreams[r.id]=e,e=r}i.apply(this,[e])};let n=t.RTCPeerConnection.prototype.removeStream;function s(t,e){let r=e.sdp;return Object.keys(t._reverseStreams||[]).forEach((e=>{let i=t._reverseStreams[e],n=t._streams[i.id];r=r.replace(new RegExp(n.id,"g"),i.id)})),new RTCSessionDescription({type:e.type,sdp:r})}t.RTCPeerConnection.prototype.removeStream=function(t){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},n.apply(this,[this._streams[t.id]||t]),delete this._reverseStreams[this._streams[t.id]?this._streams[t.id].id:t.id],delete this._streams[t.id]},t.RTCPeerConnection.prototype.addTrack=function(e,r){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");let i=[].slice.call(arguments,1);if(1!==i.length||!i[0].getTracks().find((t=>t===e)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};let n=this._streams[r.id];if(n)n.addTrack(e),Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{let i=new t.MediaStream([e]);this._streams[r.id]=i,this._reverseStreams[i.id]=r,this.addStream(i)}return this.getSenders().find((t=>t.track===e))},["createOffer","createAnswer"].forEach((function(e){let r=t.RTCPeerConnection.prototype[e],i={[e](){let t=arguments;return arguments.length&&"function"==typeof arguments[0]?r.apply(this,[e=>{let r=s(this,e);t[0].apply(null,[r])},e=>{t[1]&&t[1].apply(null,e)},arguments[2]]):r.apply(this,arguments).then((t=>s(this,t)))}};t.RTCPeerConnection.prototype[e]=i[e]}));let a=t.RTCPeerConnection.prototype.setLocalDescription;t.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(t,e){let r=e.sdp;return Object.keys(t._reverseStreams||[]).forEach((e=>{let i=t._reverseStreams[e],n=t._streams[i.id];r=r.replace(new RegExp(i.id,"g"),n.id)})),new RTCSessionDescription({type:e.type,sdp:r})}(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};let o=Object.getOwnPropertyDescriptor(t.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(t.RTCPeerConnection.prototype,"localDescription",{get(){let t=o.get.apply(this);return""===t.type?t:s(this,t)}}),t.RTCPeerConnection.prototype.removeTrack=function(t){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!t._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(t._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let e;this._streams=this._streams||{},Object.keys(this._streams).forEach((r=>{this._streams[r].getTracks().find((e=>t.track===e))&&(e=this._streams[r])})),e&&(1===e.getTracks().length?this.removeStream(this._reverseStreams[e.id]):e.removeTrack(t.track),this.dispatchEvent(new Event("negotiationneeded")))}}function re(t,e){!t.RTCPeerConnection&&t.webkitRTCPeerConnection&&(t.RTCPeerConnection=t.webkitRTCPeerConnection),t.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(e){let r=t.RTCPeerConnection.prototype[e],i={[e](){return arguments[0]=new("addIceCandidate"===e?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};t.RTCPeerConnection.prototype[e]=i[e]}))}function Fe(t,e){T(t,"negotiationneeded",(t=>{let r=t.target;if(!(e.version<72||r.getConfiguration&&"plan-b"===r.getConfiguration().sdpSemantics)||"stable"===r.signalingState)return t}))}var oe={};function ie(t,e){let r=t&&t.navigator,i=t&&t.MediaStreamTrack;if(r.getUserMedia=function(t,e,i){A("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),r.mediaDevices.getUserMedia(t).then(e,i)},!(e.version>55&&"autoGainControl"in r.mediaDevices.getSupportedConstraints())){let t=function(t,e,r){e in t&&!(r in t)&&(t[r]=t[e],delete t[e])},e=r.mediaDevices.getUserMedia.bind(r.mediaDevices);if(r.mediaDevices.getUserMedia=function(r){return"object"==typeof r&&"object"==typeof r.audio&&(r=JSON.parse(JSON.stringify(r)),t(r.audio,"autoGainControl","mozAutoGainControl"),t(r.audio,"noiseSuppression","mozNoiseSuppression")),e(r)},i&&i.prototype.getSettings){let e=i.prototype.getSettings;i.prototype.getSettings=function(){let r=e.apply(this,arguments);return t(r,"mozAutoGainControl","autoGainControl"),t(r,"mozNoiseSuppression","noiseSuppression"),r}}if(i&&i.prototype.applyConstraints){let e=i.prototype.applyConstraints;i.prototype.applyConstraints=function(r){return"audio"===this.kind&&"object"==typeof r&&(r=JSON.parse(JSON.stringify(r)),t(r,"autoGainControl","mozAutoGainControl"),t(r,"noiseSuppression","mozNoiseSuppression")),e.apply(this,[r])}}}}function Lt(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(t.navigator.mediaDevices.getDisplayMedia=function(r){if(!r||!r.video){let t=new DOMException("getDisplayMedia without video constraints is undefined");return t.name="NotFoundError",t.code=8,Promise.reject(t)}return!0===r.video?r.video={mediaSource:e}:r.video.mediaSource=e,t.navigator.mediaDevices.getUserMedia(r)})}function Ne(t){"object"==typeof t&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function se(t,e){if("object"!=typeof t||!t.RTCPeerConnection&&!t.mozRTCPeerConnection)return;!t.RTCPeerConnection&&t.mozRTCPeerConnection&&(t.RTCPeerConnection=t.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(e){let r=t.RTCPeerConnection.prototype[e],i={[e](){return arguments[0]=new("addIceCandidate"===e?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};t.RTCPeerConnection.prototype[e]=i[e]}));let r={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){let[t,n,s]=arguments;return i.apply(this,[t||null]).then((t=>{if(e.version<53&&!n)try{t.forEach((t=>{t.type=r[t.type]||t.type}))}catch(e){if("TypeError"!==e.name)throw e;t.forEach(((e,i)=>{t.set(i,Object.assign({},e,{type:r[e.type]||e.type}))}))}return t})).then(n,s)}}function $e(t){if("object"!=typeof t||!t.RTCPeerConnection||!t.RTCRtpSender||t.RTCRtpSender&&"getStats"in t.RTCRtpSender.prototype)return;let e=t.RTCPeerConnection.prototype.getSenders;e&&(t.RTCPeerConnection.prototype.getSenders=function(){let t=e.apply(this,[]);return t.forEach((t=>t._pc=this)),t});let r=t.RTCPeerConnection.prototype.addTrack;r&&(t.RTCPeerConnection.prototype.addTrack=function(){let t=r.apply(this,arguments);return t._pc=this,t}),t.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function je(t){if("object"!=typeof t||!t.RTCPeerConnection||!t.RTCRtpSender||t.RTCRtpSender&&"getStats"in t.RTCRtpReceiver.prototype)return;let e=t.RTCPeerConnection.prototype.getReceivers;e&&(t.RTCPeerConnection.prototype.getReceivers=function(){let t=e.apply(this,[]);return t.forEach((t=>t._pc=this)),t}),T(t,"track",(t=>(t.receiver._pc=t.srcElement,t))),t.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Ve(t){!t.RTCPeerConnection||"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(t){A("removeStream","removeTrack"),this.getSenders().forEach((e=>{e.track&&t.getTracks().includes(e.track)&&this.removeTrack(e)}))})}function Ge(t){t.DataChannel&&!t.RTCDataChannel&&(t.RTCDataChannel=t.DataChannel)}function Je(t){if("object"!=typeof t||!t.RTCPeerConnection)return;let e=t.RTCPeerConnection.prototype.addTransceiver;e&&(t.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let t=arguments[1]&&arguments[1].sendEncodings;void 0===t&&(t=[]),t=[...t];let r=t.length>0;r&&t.forEach((t=>{if("rid"in t&&!/^[a-z0-9]{0,16}$/i.test(t.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in t&&!(parseFloat(t.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in t&&!(parseFloat(t.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));let i=e.apply(this,arguments);if(r){let{sender:e}=i,r=e.getParameters();(!("encodings"in r)||1===r.encodings.length&&0===Object.keys(r.encodings[0]).length)&&(r.encodings=t,e.sendEncodings=t,this.setParametersPromises.push(e.setParameters(r).then((()=>{delete e.sendEncodings})).catch((()=>{delete e.sendEncodings}))))}return i})}function He(t){if("object"!=typeof t||!t.RTCRtpSender)return;let e=t.RTCRtpSender.prototype.getParameters;e&&(t.RTCRtpSender.prototype.getParameters=function(){let t=e.apply(this,arguments);return"encodings"in t||(t.encodings=[].concat(this.sendEncodings||[{}])),t})}function Ke(t){if("object"!=typeof t||!t.RTCPeerConnection)return;let e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>e.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):e.apply(this,arguments)}}function We(t){if("object"!=typeof t||!t.RTCPeerConnection)return;let e=t.RTCPeerConnection.prototype.createAnswer;t.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>e.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):e.apply(this,arguments)}}Q(oe,{shimAddTransceiver:()=>Je,shimCreateAnswer:()=>We,shimCreateOffer:()=>Ke,shimGetDisplayMedia:()=>Lt,shimGetParameters:()=>He,shimGetUserMedia:()=>ie,shimOnTrack:()=>Ne,shimPeerConnection:()=>se,shimRTCDataChannel:()=>Ge,shimReceiverGetStats:()=>je,shimRemoveStream:()=>Ve,shimSenderGetStats:()=>$e});var ae={};function Ye(t){if("object"==typeof t&&t.RTCPeerConnection){if("getLocalStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in t.RTCPeerConnection.prototype)){let e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addStream=function(t){this._localStreams||(this._localStreams=[]),this._localStreams.includes(t)||this._localStreams.push(t),t.getAudioTracks().forEach((r=>e.call(this,r,t))),t.getVideoTracks().forEach((r=>e.call(this,r,t)))},t.RTCPeerConnection.prototype.addTrack=function(t,...r){return r&&r.forEach((t=>{this._localStreams?this._localStreams.includes(t)||this._localStreams.push(t):this._localStreams=[t]})),e.apply(this,arguments)}}"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);let e=this._localStreams.indexOf(t);if(-1===e)return;this._localStreams.splice(e,1);let r=t.getTracks();this.getSenders().forEach((t=>{r.includes(t.track)&&this.removeTrack(t)}))})}}function Xe(t){if("object"==typeof t&&t.RTCPeerConnection&&("getRemoteStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in t.RTCPeerConnection.prototype))){Object.defineProperty(t.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(t){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=t),this.addEventListener("track",this._onaddstreampoly=t=>{t.streams.forEach((t=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(t))return;this._remoteStreams.push(t);let e=new Event("addstream");e.stream=t,this.dispatchEvent(e)}))})}});let e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){let t=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach((e=>{if(t._remoteStreams||(t._remoteStreams=[]),t._remoteStreams.indexOf(e)>=0)return;t._remoteStreams.push(e);let r=new Event("addstream");r.stream=e,t.dispatchEvent(r)}))}),e.apply(t,arguments)}}}function qe(t){if("object"!=typeof t||!t.RTCPeerConnection)return;let e=t.RTCPeerConnection.prototype,r=e.createOffer,i=e.createAnswer,n=e.setLocalDescription,s=e.setRemoteDescription,a=e.addIceCandidate;e.createOffer=function(t,e){let i=arguments.length>=2?arguments[2]:arguments[0],n=r.apply(this,[i]);return e?(n.then(t,e),Promise.resolve()):n},e.createAnswer=function(t,e){let r=arguments.length>=2?arguments[2]:arguments[0],n=i.apply(this,[r]);return e?(n.then(t,e),Promise.resolve()):n};let o=function(t,e,r){let i=n.apply(this,[t]);return r?(i.then(e,r),Promise.resolve()):i};e.setLocalDescription=o,o=function(t,e,r){let i=s.apply(this,[t]);return r?(i.then(e,r),Promise.resolve()):i},e.setRemoteDescription=o,o=function(t,e,r){let i=a.apply(this,[t]);return r?(i.then(e,r),Promise.resolve()):i},e.addIceCandidate=o}function Ze(t){let e=t&&t.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){let t=e.mediaDevices,r=t.getUserMedia.bind(t);e.mediaDevices.getUserMedia=t=>r(Bt(t))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=function(t,r,i){e.mediaDevices.getUserMedia(t).then(r,i)}.bind(e))}function Bt(t){return t&&void 0!==t.video?Object.assign({},t,{video:Ae(t.video)}):t}function Qe(t){if(!t.RTCPeerConnection)return;let e=t.RTCPeerConnection;t.RTCPeerConnection=function(t,r){if(t&&t.iceServers){let e=[];for(let r=0;r<t.iceServers.length;r++){let i=t.iceServers[r];void 0===i.urls&&i.url?(A("RTCIceServer.url","RTCIceServer.urls"),i=JSON.parse(JSON.stringify(i)),i.urls=i.url,delete i.url,e.push(i)):e.push(t.iceServers[r])}t.iceServers=e}return new e(t,r)},t.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(t.RTCPeerConnection,"generateCertificate",{get:()=>e.generateCertificate})}function et(t){"object"==typeof t&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function tt(t){let e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(t){if(t){typeof t.offerToReceiveAudio<"u"&&(t.offerToReceiveAudio=!!t.offerToReceiveAudio);let e=this.getTransceivers().find((t=>"audio"===t.receiver.track.kind));!1===t.offerToReceiveAudio&&e?"sendrecv"===e.direction?e.setDirection?e.setDirection("sendonly"):e.direction="sendonly":"recvonly"===e.direction&&(e.setDirection?e.setDirection("inactive"):e.direction="inactive"):!0===t.offerToReceiveAudio&&!e&&this.addTransceiver("audio",{direction:"recvonly"}),typeof t.offerToReceiveVideo<"u"&&(t.offerToReceiveVideo=!!t.offerToReceiveVideo);let r=this.getTransceivers().find((t=>"video"===t.receiver.track.kind));!1===t.offerToReceiveVideo&&r?"sendrecv"===r.direction?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":"recvonly"===r.direction&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):!0===t.offerToReceiveVideo&&!r&&this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function rt(t){"object"!=typeof t||t.AudioContext||(t.AudioContext=t.webkitAudioContext)}Q(ae,{shimAudioContext:()=>rt,shimCallbacksAPI:()=>qe,shimConstraints:()=>Bt,shimCreateOfferLegacy:()=>tt,shimGetUserMedia:()=>Ze,shimLocalStreamsAPI:()=>Ye,shimRTCIceServerUrls:()=>Qe,shimRemoteStreamsAPI:()=>Xe,shimTrackEventTransceiver:()=>et});var st={};Q(st,{removeExtmapAllowMixed:()=>he,shimAddIceCandidateNullOrEmpty:()=>j,shimConnectionState:()=>fe,shimMaxMessageSize:()=>N,shimParameterlessSetLocalDescription:()=>V,shimRTCIceCandidate:()=>F,shimRTCIceCandidateRelayProtocol:()=>ce,shimSendThrowTypeError:()=>$});var U=Rt(it());function F(t){if(!t.RTCIceCandidate||t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype)return;let e=t.RTCIceCandidate;t.RTCIceCandidate=function(t){if("object"==typeof t&&t.candidate&&0===t.candidate.indexOf("a=")&&((t=JSON.parse(JSON.stringify(t))).candidate=t.candidate.substring(2)),t.candidate&&t.candidate.length){let r=new e(t),i=U.default.parseCandidate(t.candidate);for(let t in i)t in r||Object.defineProperty(r,t,{value:i[t]});return r.toJSON=function(){return{candidate:r.candidate,sdpMid:r.sdpMid,sdpMLineIndex:r.sdpMLineIndex,usernameFragment:r.usernameFragment}},r}return new e(t)},t.RTCIceCandidate.prototype=e.prototype,T(t,"icecandidate",(e=>(e.candidate&&Object.defineProperty(e,"candidate",{value:new t.RTCIceCandidate(e.candidate),writable:"false"}),e)))}function ce(t){!t.RTCIceCandidate||t.RTCIceCandidate&&"relayProtocol"in t.RTCIceCandidate.prototype||T(t,"icecandidate",(t=>{if(t.candidate){let e=U.default.parseCandidate(t.candidate.candidate);"relay"===e.type&&(t.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[e.priority>>24])}return t}))}function N(t,e){if(!t.RTCPeerConnection)return;"sctp"in t.RTCPeerConnection.prototype||Object.defineProperty(t.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});let r=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===e.browser&&e.version>=76){let{sdpSemantics:t}=this.getConfiguration();"plan-b"===t&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(function(t){if(!t||!t.sdp)return!1;let e=U.default.splitSections(t.sdp);return e.shift(),e.some((t=>{let e=U.default.parseMLine(t);return e&&"application"===e.kind&&-1!==e.protocol.indexOf("SCTP")}))}(arguments[0])){let t,r=function(t){let e=t.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===e||e.length<2)return-1;let r=parseInt(e[1],10);return r!=r?-1:r}(arguments[0]),i=function(t){let r=65536;return"firefox"===e.browser&&(r=e.version<57?-1===t?16384:2147483637:e.version<60?57===e.version?65535:65536:2147483637),r}(r),n=function(t,r){let i=65536;"firefox"===e.browser&&57===e.version&&(i=65535);let n=U.default.matchPrefix(t.sdp,"a=max-message-size:");return n.length>0?i=parseInt(n[0].substring(19),10):"firefox"===e.browser&&-1!==r&&(i=2147483637),i}(arguments[0],r);t=0===i&&0===n?Number.POSITIVE_INFINITY:0===i||0===n?Math.max(i,n):Math.min(i,n);let s={};Object.defineProperty(s,"maxMessageSize",{get:()=>t}),this._sctp=s}return r.apply(this,arguments)}}function $(t){if(!t.RTCPeerConnection||!("createDataChannel"in t.RTCPeerConnection.prototype))return;function e(t,e){let r=t.send;t.send=function(){let i=arguments[0],n=i.length||i.size||i.byteLength;if("open"===t.readyState&&e.sctp&&n>e.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+e.sctp.maxMessageSize+" bytes)");return r.apply(t,arguments)}}let r=t.RTCPeerConnection.prototype.createDataChannel;t.RTCPeerConnection.prototype.createDataChannel=function(){let t=r.apply(this,arguments);return e(t,this),t},T(t,"datachannel",(t=>(e(t.channel,t.target),t)))}function fe(t){if(!t.RTCPeerConnection||"connectionState"in t.RTCPeerConnection.prototype)return;let e=t.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(t){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),t&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=t)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((t=>{let r=e[t];e[t]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=t=>{let e=t.target;if(e._lastConnectionState!==e.connectionState){e._lastConnectionState=e.connectionState;let r=new Event("connectionstatechange",t);e.dispatchEvent(r)}return t},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)}}))}function he(t,e){if(!t.RTCPeerConnection||"chrome"===e.browser&&e.version>=71||"safari"===e.browser&&e.version>=605)return;let r=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(e){if(e&&e.sdp&&-1!==e.sdp.indexOf("\na=extmap-allow-mixed")){let r=e.sdp.split("\n").filter((t=>"a=extmap-allow-mixed"!==t.trim())).join("\n");t.RTCSessionDescription&&e instanceof t.RTCSessionDescription?arguments[0]=new t.RTCSessionDescription({type:e.type,sdp:r}):e.sdp=r}return r.apply(this,arguments)}}function j(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;let r=t.RTCPeerConnection.prototype.addIceCandidate;!r||0===r.length||(t.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===e.browser&&e.version<78||"firefox"===e.browser&&e.version<68||"safari"===e.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():r.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function V(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;let r=t.RTCPeerConnection.prototype.setLocalDescription;!r||0===r.length||(t.RTCPeerConnection.prototype.setLocalDescription=function(){let t=arguments[0]||{};if("object"!=typeof t||t.type&&t.sdp)return r.apply(this,arguments);if(t={type:t.type,sdp:t.sdp},!t.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":t.type="offer";break;default:t.type="answer"}return t.sdp||"offer"!==t.type&&"answer"!==t.type?r.apply(this,[t]):("offer"===t.type?this.createOffer:this.createAnswer).apply(this).then((t=>r.apply(this,[t])))})}var lr=Rt(it());function zt({window:t}={},e={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){let r=ee,i=Ut(t),n={browserDetails:i,commonShim:st,extractVersion:z,disableLog:Mt,disableWarnings:At,sdp:lr};switch(i.browser){case"chrome":if(!ne||!re||!e.shimChrome)return r("Chrome shim is not included in this adapter release."),n;if(null===i.version)return r("Chrome shim can not determine version, not shimming."),n;r("adapter.js shimming chrome."),n.browserShim=ne,j(t,i),V(t),te(t,i),Oe(t),re(t,i),we(t),ze(t,i),Le(t),Be(t),Fe(t,i),F(t),ce(t),fe(t),N(t,i),$(t),he(t,i);break;case"firefox":if(!oe||!se||!e.shimFirefox)return r("Firefox shim is not included in this adapter release."),n;r("adapter.js shimming firefox."),n.browserShim=oe,j(t,i),V(t),ie(t,i),se(t,i),Ne(t),Ve(t),$e(t),je(t),Ge(t),Je(t),He(t),Ke(t),We(t),F(t),fe(t),N(t,i),$(t);break;case"safari":if(!ae||!e.shimSafari)return r("Safari shim is not included in this adapter release."),n;r("adapter.js shimming safari."),n.browserShim=ae,j(t,i),V(t),Qe(t),tt(t),qe(t),Ye(t),Xe(t),et(t),Ze(t),rt(t),F(t),ce(t),N(t,i),$(t),he(t,i);break;default:r("Unsupported browser!")}return n}var dr=zt({window:typeof window>"u"?void 0:window}),ot=dr,R=4294967295;function pe(t,e,r){var i=Math.floor(r/4294967296),n=r;t.setUint32(e,i),t.setUint32(e+4,n)}function ue(t,e){return 4294967296*t.getInt32(e)+t.getUint32(e+4)}var at,ct,ft,le=(typeof __Process$>"u"||"never"!==(null===(at=__Process$?.env)||void 0===at?void 0:at.TEXT_ENCODING))&&typeof TextEncoder<"u"&&typeof TextDecoder<"u",G=le?new TextEncoder:void 0;function mr(t,e,r){e.set(G.encode(t),r)}function gr(t,e,r){G.encodeInto(t,e.subarray(r))}le&&typeof __Process$<"u"&&(null===(ct=__Process$?.env)||void 0===ct||ct.TEXT_ENCODING);var yr=4096;function de(t,e,r){for(var i=e,n=i+r,s=[],a="";i<n;){var o=t[i++];if(128&o)if(192==(224&o)){var h=63&t[i++];s.push((31&o)<<6|h)}else if(224==(240&o)){h=63&t[i++];var c=63&t[i++];s.push((31&o)<<12|h<<6|c)}else if(240==(248&o)){var l=(7&o)<<18|(h=63&t[i++])<<12|(c=63&t[i++])<<6|63&t[i++];l>65535&&(l-=65536,s.push(l>>>10&1023|55296),l=56320|1023&l),s.push(l)}else s.push(o);else s.push(o);s.length>=yr&&(a+=String.fromCharCode.apply(String,s),s.length=0)}return s.length>0&&(a+=String.fromCharCode.apply(String,s)),a}le&&new TextDecoder,le&&typeof __Process$<"u"&&(null===(ft=__Process$?.env)||void 0===ft||ft.TEXT_DECODER);var J=function(t,e){this.type=t,this.data=e},_r=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])})(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),b=function(t){function e(r){var i=t.call(this,r)||this,n=Object.create(e.prototype);return Object.setPrototypeOf(i,n),Object.defineProperty(i,"name",{configurable:!0,enumerable:!1,value:e.name}),i}return _r(e,t),e}(Error),xr=-1,Cr=4294967295,Sr=17179869183;function br(t){var e=t.sec,r=t.nsec;if(e>=0&&r>=0&&e<=Sr){if(0===r&&e<=Cr){var i=new Uint8Array(4);return(a=new DataView(i.buffer)).setUint32(0,e),i}var n=e/4294967296,s=4294967295&e;i=new Uint8Array(8);return(a=new DataView(i.buffer)).setUint32(0,r<<2|3&n),a.setUint32(4,s),i}var a;i=new Uint8Array(12);return(a=new DataView(i.buffer)).setUint32(0,r),pe(a,4,e),i}function Tr(t){var e=t.getTime(),r=Math.floor(e/1e3),i=1e6*(e-1e3*r),n=Math.floor(i/1e9);return{sec:r+n,nsec:i-1e9*n}}function kr(t){return t instanceof Date?br(Tr(t)):null}function Er(t){var e=new DataView(t.buffer,t.byteOffset,t.byteLength);switch(t.byteLength){case 4:return{sec:e.getUint32(0),nsec:0};case 8:var r=e.getUint32(0);return{sec:4294967296*(3&r)+e.getUint32(4),nsec:r>>>2};case 12:return{sec:ue(e,4),nsec:e.getUint32(0)};default:throw new b("Unrecognized data size for timestamp (expected 4, 8, or 12): ".concat(t.length))}}function Rr(t){var e=Er(t);return new Date(1e3*e.sec+e.nsec/1e6)}var Ht={type:xr,encode:kr,decode:Rr};!function(){function t(){this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(Ht)}t.prototype.register=function(t){var e=t.type,r=t.encode,i=t.decode;if(e>=0)this.encoders[e]=r,this.decoders[e]=i;else{var n=1+e;this.builtInEncoders[n]=r,this.builtInDecoders[n]=i}},t.prototype.tryToEncode=function(t,e){for(var r=0;r<this.builtInEncoders.length;r++){if(null!=(i=this.builtInEncoders[r]))if(null!=(n=i(t,e)))return new J(-1-r,n)}for(r=0;r<this.encoders.length;r++){var i,n;if(null!=(i=this.encoders[r]))if(null!=(n=i(t,e)))return new J(r,n)}return t instanceof J?t:null},t.prototype.decode=function(t,e,r){var i=e<0?this.builtInDecoders[-1-e]:this.decoders[e];return i?i(t,e,r):new J(e,t)},t.defaultCodec=new t}();var Ir=16,Mr=16,Wt=function(){function t(t,e){void 0===t&&(t=Ir),void 0===e&&(e=Mr),this.maxKeyLength=t,this.maxLengthPerKey=e,this.hit=0,this.miss=0,this.caches=[];for(var r=0;r<this.maxKeyLength;r++)this.caches.push([])}return t.prototype.canBeCached=function(t){return t>0&&t<=this.maxKeyLength},t.prototype.find=function(t,e,r){t:for(var i=0,n=this.caches[r-1];i<n.length;i++){for(var s=n[i],a=s.bytes,o=0;o<r;o++)if(a[o]!==t[e+o])continue t;return s.str}return null},t.prototype.store=function(t,e){var r=this.caches[t.length-1],i={bytes:t,str:e};r.length>=this.maxLengthPerKey?r[Math.random()*r.length|0]=i:r.push(i)},t.prototype.decode=function(t,e,r){var i=this.find(t,e,r);if(null!=i)return this.hit++,i;this.miss++;var n=de(t,e,r),s=Uint8Array.prototype.slice.call(t,e,e+r);return this.store(s,n),n},t}(),dt=new DataView(new ArrayBuffer(0));new Uint8Array(dt.buffer);var lt=function(){try{dt.getInt8(0)}catch(t){return t.constructor}throw new Error("never reached")}();function I(t,e,r,i){Object.defineProperty(t,e,{get:r,set:i,enumerable:!0,configurable:!0})}new lt("Insufficient data"),new Wt;var ve=class{constructor(){this.chunkedMTU=16300,this._dataCount=1,this.chunk=t=>{let e=[],r=t.byteLength,i=Math.ceil(r/this.chunkedMTU),n=0,s=0;for(;s<r;){let a=Math.min(r,s+this.chunkedMTU),o=t.slice(s,a),h={__peerData:this._dataCount,n:n,data:o,total:i};e.push(h),s=a,n++}return this._dataCount++,e}}};function jr(t){let e=0;for(let r of t)e+=r.byteLength;let r=new Uint8Array(e),i=0;for(let e of t)r.set(e,i),i+=e.byteLength;return r}var tr,gt=ot.default||ot,K=new class{isWebRTCSupported(){return typeof RTCPeerConnection<"u"}isBrowserSupported(){let t=this.getBrowser(),e=this.getVersion();return!!this.supportedBrowsers.includes(t)&&("chrome"===t?e>=this.minChromeVersion:"firefox"===t?e>=this.minFirefoxVersion:"safari"===t&&(!this.isIOS&&e>=this.minSafariVersion))}getBrowser(){return gt.browserDetails.browser}getVersion(){return gt.browserDetails.version||0}isUnifiedPlanSupported(){let t=this.getBrowser(),e=gt.browserDetails.version||0;if("chrome"===t&&e<this.minChromeVersion)return!1;if("firefox"===t&&e>=this.minFirefoxVersion)return!0;if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;let r,i=!1;try{r=new RTCPeerConnection,r.addTransceiver("audio"),i=!0}catch{}finally{r&&r.close()}return i}toString(){return`Supports:\n    browser:${this.getBrowser()}\n    version:${this.getVersion()}\n    isIOS:${this.isIOS}\n    isWebRTCSupported:${this.isWebRTCSupported()}\n    isBrowserSupported:${this.isBrowserSupported()}\n    isUnifiedPlanSupported:${this.isUnifiedPlanSupported()}`}constructor(){this.isIOS=typeof navigator<"u"&&["iPad","iPhone","iPod"].includes(navigator.platform),this.supportedBrowsers=["firefox","chrome","safari"],this.minFirefoxVersion=59,this.minChromeVersion=72,this.minSafariVersion=605}},Vr=t=>!t||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.test(t),nr=()=>Math.random().toString(36).slice(2),er={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:["turn:eu-0.turn.peerjs.com:3478","turn:us-0.turn.peerjs.com:3478"],username:"peerjs",credential:"peerjsp"}],sdpSemantics:"unified-plan"},yt=class extends ve{noop(){}blobToArrayBuffer(t,e){let r=new FileReader;return r.onload=function(t){t.target&&e(t.target.result)},r.readAsArrayBuffer(t),r}binaryStringToArrayBuffer(t){let e=new Uint8Array(t.length);for(let r=0;r<t.length;r++)e[r]=255&t.charCodeAt(r);return e.buffer}isSecure(){return"https:"===location.protocol}constructor(...t){super(...t),this.CLOUD_HOST="0.peerjs.com",this.CLOUD_PORT=443,this.chunkedBrowsers={Chrome:1,chrome:1},this.defaultConfig=er,this.browser=K.getBrowser(),this.browserVersion=K.getVersion(),this.pack=Ie,this.unpack=De,this.supports=function(){let t,e={browser:K.isBrowserSupported(),webRTC:K.isWebRTCSupported(),audioVideo:!1,data:!1,binaryBlob:!1,reliable:!1};if(!e.webRTC)return e;try{let r;t=new RTCPeerConnection(er),e.audioVideo=!0;try{r=t.createDataChannel("_PEERJSTEST",{ordered:!0}),e.data=!0,e.reliable=!!r.ordered;try{r.binaryType="blob",e.binaryBlob=!K.isIOS}catch{}}catch{}finally{r&&r.close()}}catch{}finally{t&&t.close()}return e}(),this.validateId=Vr,this.randomToken=nr}},S=new yt,Gr="PeerJS: ";!function(t){t[t.Disabled=0]="Disabled",t[t.Errors=1]="Errors",t[t.Warnings=2]="Warnings",t[t.All=3]="All"}(tr||(tr={}));var vt=class{get logLevel(){return this._logLevel}set logLevel(t){this._logLevel=t}log(...t){this._logLevel>=3&&this._print(3,...t)}warn(...t){this._logLevel>=2&&this._print(2,...t)}error(...t){this._logLevel>=1&&this._print(1,...t)}setLogFunction(t){this._print=t}_print(t,...e){let r=[Gr,...e];for(let t in r)r[t]instanceof Error&&(r[t]="("+r[t].name+") "+r[t].message);t>=3?console.log(...r):t>=2?console.warn("WARNING",...r):t>=1&&console.error("ERROR",...r)}constructor(){this._logLevel=0}},d=new vt,kt={},Jr=Object.prototype.hasOwnProperty,C="~";function Y(){}function Hr(t,e,r){this.fn=t,this.context=e,this.once=r||!1}function ir(t,e,r,i,n){if("function"!=typeof r)throw new TypeError("The listener must be a function");var s=new Hr(r,i||t,n),a=C?C+e:e;return t._events[a]?t._events[a].fn?t._events[a]=[t._events[a],s]:t._events[a].push(s):(t._events[a]=s,t._eventsCount++),t}function ye(t,e){0==--t._eventsCount?t._events=new Y:delete t._events[e]}function x(){this._events=new Y,this._eventsCount=0}Object.create&&(Y.prototype=Object.create(null),(new Y).__proto__||(C=!1)),x.prototype.eventNames=function(){var t,e,r=[];if(0===this._eventsCount)return r;for(e in t=this._events)Jr.call(t,e)&&r.push(C?e.slice(1):e);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(t)):r},x.prototype.listeners=function(t){var e=C?C+t:t,r=this._events[e];if(!r)return[];if(r.fn)return[r.fn];for(var i=0,n=r.length,s=new Array(n);i<n;i++)s[i]=r[i].fn;return s},x.prototype.listenerCount=function(t){var e=C?C+t:t,r=this._events[e];return r?r.fn?1:r.length:0},x.prototype.emit=function(t,e,r,i,n,s){var a=C?C+t:t;if(!this._events[a])return!1;var o,h,c=this._events[a],l=arguments.length;if(c.fn){switch(c.once&&this.removeListener(t,c.fn,void 0,!0),l){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,r),!0;case 4:return c.fn.call(c.context,e,r,i),!0;case 5:return c.fn.call(c.context,e,r,i,n),!0;case 6:return c.fn.call(c.context,e,r,i,n,s),!0}for(h=1,o=new Array(l-1);h<l;h++)o[h-1]=arguments[h];c.fn.apply(c.context,o)}else{var u,d=c.length;for(h=0;h<d;h++)switch(c[h].once&&this.removeListener(t,c[h].fn,void 0,!0),l){case 1:c[h].fn.call(c[h].context);break;case 2:c[h].fn.call(c[h].context,e);break;case 3:c[h].fn.call(c[h].context,e,r);break;case 4:c[h].fn.call(c[h].context,e,r,i);break;default:if(!o)for(u=1,o=new Array(l-1);u<l;u++)o[u-1]=arguments[u];c[h].fn.apply(c[h].context,o)}}return!0},x.prototype.on=function(t,e,r){return ir(this,t,e,r,!1)},x.prototype.once=function(t,e,r){return ir(this,t,e,r,!0)},x.prototype.removeListener=function(t,e,r,i){var n=C?C+t:t;if(!this._events[n])return this;if(!e)return ye(this,n),this;var s=this._events[n];if(s.fn)s.fn===e&&(!i||s.once)&&(!r||s.context===r)&&ye(this,n);else{for(var a=0,o=[],h=s.length;a<h;a++)(s[a].fn!==e||i&&!s[a].once||r&&s[a].context!==r)&&o.push(s[a]);o.length?this._events[n]=1===o.length?o[0]:o:ye(this,n)}return this},x.prototype.removeAllListeners=function(t){var e;return t?(e=C?C+t:t,this._events[e]&&ye(this,e)):(this._events=new Y,this._eventsCount=0),this},x.prototype.off=x.prototype.removeListener,x.prototype.addListener=x.prototype.on,x.prefixed=C,x.EventEmitter=x,kt=x;var E,v,X,q,B,k,_,M={};I(M,"ConnectionType",(()=>E)),I(M,"PeerErrorType",(()=>v)),I(M,"BaseConnectionErrorType",(()=>X)),I(M,"DataConnectionErrorType",(()=>q)),I(M,"SerializationType",(()=>B)),I(M,"SocketEventType",(()=>k)),I(M,"ServerMessageType",(()=>_)),function(t){t.Data="data",t.Media="media"}(E||(E={})),function(t){t.BrowserIncompatible="browser-incompatible",t.Disconnected="disconnected",t.InvalidID="invalid-id",t.InvalidKey="invalid-key",t.Network="network",t.PeerUnavailable="peer-unavailable",t.SslUnavailable="ssl-unavailable",t.ServerError="server-error",t.SocketError="socket-error",t.SocketClosed="socket-closed",t.UnavailableID="unavailable-id",t.WebRTC="webrtc"}(v||(v={})),function(t){t.NegotiationFailed="negotiation-failed",t.ConnectionClosed="connection-closed"}(X||(X={})),function(t){t.NotOpenYet="not-open-yet",t.MessageToBig="message-too-big"}(q||(q={})),function(t){t.Binary="binary",t.BinaryUTF8="binary-utf8",t.JSON="json",t.None="raw"}(B||(B={})),function(t){t.Message="message",t.Disconnected="disconnected",t.Error="error",t.Close="close"}(k||(k={})),function(t){t.Heartbeat="HEARTBEAT",t.Candidate="CANDIDATE",t.Offer="OFFER",t.Answer="ANSWER",t.Open="OPEN",t.Error="ERROR",t.IdTaken="ID-TAKEN",t.InvalidKey="INVALID-KEY",t.Leave="LEAVE",t.Expire="EXPIRE"}(_||(_={}));var Et={};Et=JSON.parse('{"name":"peerjs","version":"1.5.4","keywords":["peerjs","webrtc","p2p","rtc"],"description":"PeerJS client","homepage":"https://peerjs.com","bugs":{"url":"https://github.com/peers/peerjs/issues"},"repository":{"type":"git","url":"https://github.com/peers/peerjs"},"license":"MIT","contributors":["Michelle Bu <michelle@michellebu.com>","afrokick <devbyru@gmail.com>","ericz <really.ez@gmail.com>","Jairo <kidandcat@gmail.com>","Jonas Gloning <34194370+jonasgloning@users.noreply.github.com>","Jairo Caro-Accino Viciana <jairo@galax.be>","Carlos Caballero <carlos.caballero.gonzalez@gmail.com>","hc <hheennrryy@gmail.com>","Muhammad Asif <capripio@gmail.com>","PrashoonB <prashoonbhattacharjee@gmail.com>","Harsh Bardhan Mishra <47351025+HarshCasper@users.noreply.github.com>","akotynski <aleksanderkotbury@gmail.com>","lmb <i@lmb.io>","Jairooo <jairocaro@msn.com>","Moritz Stückler <moritz.stueckler@gmail.com>","Simon <crydotsnakegithub@gmail.com>","Denis Lukov <denismassters@gmail.com>","Philipp Hancke <fippo@andyet.net>","Hans Oksendahl <hansoksendahl@gmail.com>","Jess <jessachandler@gmail.com>","khankuan <khankuan@gmail.com>","DUODVK <kurmanov.work@gmail.com>","XiZhao <kwang1imsa@gmail.com>","Matthias Lohr <matthias@lohr.me>","=frank tree <=frnktrb@googlemail.com>","Andre Eckardt <aeckardt@outlook.com>","Chris Cowan <agentme49@gmail.com>","Alex Chuev <alex@chuev.com>","alxnull <alxnull@e.mail.de>","Yemel Jardi <angel.jardi@gmail.com>","Ben Parnell <benjaminparnell.94@gmail.com>","Benny Lichtner <bennlich@gmail.com>","fresheneesz <bitetrudpublic@gmail.com>","bob.barstead@exaptive.com <bob.barstead@exaptive.com>","chandika <chandika@gmail.com>","emersion <contact@emersion.fr>","Christopher Van <cvan@users.noreply.github.com>","eddieherm <edhermoso@gmail.com>","Eduardo Pinho <enet4mikeenet@gmail.com>","Evandro Zanatta <ezanatta@tray.net.br>","Gardner Bickford <gardner@users.noreply.github.com>","Gian Luca <gianluca.cecchi@cynny.com>","PatrickJS <github@gdi2290.com>","jonnyf <github@jonathanfoss.co.uk>","Hizkia Felix <hizkifw@gmail.com>","Hristo Oskov <hristo.oskov@gmail.com>","Isaac Madwed <i.madwed@gmail.com>","Ilya Konanykhin <ilya.konanykhin@gmail.com>","jasonbarry <jasbarry@me.com>","Jonathan Burke <jonathan.burke.1311@googlemail.com>","Josh Hamit <josh.hamit@gmail.com>","Jordan Austin <jrax86@gmail.com>","Joel Wetzell <jwetzell@yahoo.com>","xizhao <kevin.wang@cloudera.com>","Alberto Torres <kungfoobar@gmail.com>","Jonathan Mayol <mayoljonathan@gmail.com>","Jefferson Felix <me@jsfelix.dev>","Rolf Erik Lekang <me@rolflekang.com>","Kevin Mai-Husan Chia <mhchia@users.noreply.github.com>","Pepijn de Vos <pepijndevos@gmail.com>","JooYoung <qkdlql@naver.com>","Tobias Speicher <rootcommander@gmail.com>","Steve Blaurock <sblaurock@gmail.com>","Kyrylo Shegeda <shegeda@ualberta.ca>","Diwank Singh Tomer <singh@diwank.name>","Sören Balko <Soeren.Balko@gmail.com>","Arpit Solanki <solankiarpit1997@gmail.com>","Yuki Ito <yuki@gnnk.net>","Artur Zayats <zag2art@gmail.com>"],"funding":{"type":"opencollective","url":"https://opencollective.com/peer"},"collective":{"type":"opencollective","url":"https://opencollective.com/peer"},"files":["dist/*"],"sideEffects":["lib/global.ts","lib/supports.ts"],"main":"dist/bundler.cjs","module":"dist/bundler.mjs","browser-minified":"dist/peerjs.min.js","browser-unminified":"dist/peerjs.js","browser-minified-msgpack":"dist/serializer.msgpack.mjs","types":"dist/types.d.ts","engines":{"node":">= 14"},"targets":{"types":{"source":"lib/exports.ts"},"main":{"source":"lib/exports.ts","sourceMap":{"inlineSources":true}},"module":{"source":"lib/exports.ts","includeNodeModules":["eventemitter3"],"sourceMap":{"inlineSources":true}},"browser-minified":{"context":"browser","outputFormat":"global","optimize":true,"engines":{"browsers":"chrome >= 83, edge >= 83, firefox >= 80, safari >= 15"},"source":"lib/global.ts"},"browser-unminified":{"context":"browser","outputFormat":"global","optimize":false,"engines":{"browsers":"chrome >= 83, edge >= 83, firefox >= 80, safari >= 15"},"source":"lib/global.ts"},"browser-minified-msgpack":{"context":"browser","outputFormat":"esmodule","isLibrary":true,"optimize":true,"engines":{"browsers":"chrome >= 83, edge >= 83, firefox >= 102, safari >= 15"},"source":"lib/dataconnection/StreamConnection/MsgPack.ts"}},"scripts":{"contributors":"git-authors-cli --print=false && prettier --write package.json && git add package.json package-lock.json && git commit -m \\"chore(contributors): update and sort contributors list\\"","check":"tsc --noEmit && tsc -p e2e/tsconfig.json --noEmit","watch":"parcel watch","build":"rm -rf dist && parcel build","prepublishOnly":"npm run build","test":"jest","test:watch":"jest --watch","coverage":"jest --coverage --collectCoverageFrom=\\"./lib/**\\"","format":"prettier --write .","format:check":"prettier --check .","semantic-release":"semantic-release","e2e":"wdio run e2e/wdio.local.conf.ts","e2e:bstack":"wdio run e2e/wdio.bstack.conf.ts"},"devDependencies":{"@parcel/config-default":"^2.9.3","@parcel/packager-ts":"^2.9.3","@parcel/transformer-typescript-tsc":"^2.9.3","@parcel/transformer-typescript-types":"^2.9.3","@semantic-release/changelog":"^6.0.1","@semantic-release/git":"^10.0.1","@swc/core":"^1.3.27","@swc/jest":"^0.2.24","@types/jasmine":"^4.3.4","@wdio/browserstack-service":"^8.11.2","@wdio/cli":"^8.11.2","@wdio/globals":"^8.11.2","@wdio/jasmine-framework":"^8.11.2","@wdio/local-runner":"^8.11.2","@wdio/spec-reporter":"^8.11.2","@wdio/types":"^8.10.4","http-server":"^14.1.1","jest":"^29.3.1","jest-environment-jsdom":"^29.3.1","mock-socket":"^9.0.0","parcel":"^2.9.3","prettier":"^3.0.0","semantic-release":"^21.0.0","ts-node":"^10.9.1","typescript":"^5.0.0","wdio-geckodriver-service":"^5.0.1"},"dependencies":{"@msgpack/msgpack":"^2.8.0","eventemitter3":"^4.0.7","peerjs-js-binarypack":"^2.1.0","webrtc-adapter":"^9.0.0"},"alias":{"process":false,"buffer":false}}');var _t=class extends kt.EventEmitter{constructor(t,e,r,i,n,s=5e3){super(),this.pingInterval=s,this._disconnected=!0,this._messagesQueue=[];let a=t?"wss://":"ws://";this._baseUrl=a+e+":"+r+i+"peerjs?key="+n}start(t,e){this._id=t;let r=`${this._baseUrl}&id=${t}&token=${e}`;this._socket||!this._disconnected||(this._socket=new WebSocket(r+"&version="+Et.version),this._disconnected=!1,this._socket.onmessage=t=>{let e;try{e=JSON.parse(t.data),d.log("Server message received:",e)}catch{return void d.log("Invalid server message",t.data)}this.emit(k.Message,e)},this._socket.onclose=t=>{this._disconnected||(d.log("Socket closed.",t),this._cleanup(),this._disconnected=!0,this.emit(k.Disconnected))},this._socket.onopen=()=>{this._disconnected||(this._sendQueuedMessages(),d.log("Socket open"),this._scheduleHeartbeat())})}_scheduleHeartbeat(){this._wsPingTimer=setTimeout((()=>{this._sendHeartbeat()}),this.pingInterval)}_sendHeartbeat(){if(!this._wsOpen())return void d.log("Cannot send heartbeat, because socket closed");let t=JSON.stringify({type:_.Heartbeat});this._socket.send(t),this._scheduleHeartbeat()}_wsOpen(){return!!this._socket&&1===this._socket.readyState}_sendQueuedMessages(){let t=[...this._messagesQueue];this._messagesQueue=[];for(let e of t)this.send(e)}send(t){if(this._disconnected)return;if(!this._id)return void this._messagesQueue.push(t);if(!t.type)return void this.emit(k.Error,"Invalid message");if(!this._wsOpen())return;let e=JSON.stringify(t);this._socket.send(e)}close(){this._disconnected||(this._cleanup(),this._disconnected=!0)}_cleanup(){this._socket&&(this._socket.onopen=this._socket.onmessage=this._socket.onclose=null,this._socket.close(),this._socket=void 0),clearTimeout(this._wsPingTimer)}},_e=class{constructor(t){this.connection=t}startConnection(t){let e=this._startPeerConnection();if(this.connection.peerConnection=e,this.connection.type===E.Media&&t._stream&&this._addTracksToConnection(t._stream,e),t.originator){let r=this.connection,i={ordered:!!t.reliable},n=e.createDataChannel(r.label,i);r._initializeDataChannel(n),this._makeOffer()}else this.handleSDP("OFFER",t.sdp)}_startPeerConnection(){d.log("Creating RTCPeerConnection.");let t=new RTCPeerConnection(this.connection.provider.options.config);return this._setupListeners(t),t}_setupListeners(t){let e=this.connection.peer,r=this.connection.connectionId,i=this.connection.type,n=this.connection.provider;d.log("Listening for ICE candidates."),t.onicecandidate=t=>{!t.candidate||!t.candidate.candidate||(d.log(`Received ICE candidates for ${e}:`,t.candidate),n.socket.send({type:_.Candidate,payload:{candidate:t.candidate,type:i,connectionId:r},dst:e}))},t.oniceconnectionstatechange=()=>{switch(t.iceConnectionState){case"failed":d.log("iceConnectionState is failed, closing connections to "+e),this.connection.emitError(X.NegotiationFailed,"Negotiation of connection to "+e+" failed."),this.connection.close();break;case"closed":d.log("iceConnectionState is closed, closing connections to "+e),this.connection.emitError(X.ConnectionClosed,"Connection to "+e+" closed."),this.connection.close();break;case"disconnected":d.log("iceConnectionState changed to disconnected on the connection with "+e);break;case"completed":t.onicecandidate=()=>{}}this.connection.emit("iceStateChanged",t.iceConnectionState)},d.log("Listening for data channel"),t.ondatachannel=t=>{d.log("Received data channel");let i=t.channel;n.getConnection(e,r)._initializeDataChannel(i)},d.log("Listening for remote stream"),t.ontrack=t=>{d.log("Received remote stream");let i=t.streams[0],s=n.getConnection(e,r);if(s.type===E.Media){let t=s;this._addStreamToMediaConnection(i,t)}}}cleanup(){d.log("Cleaning up PeerConnection to "+this.connection.peer);let t=this.connection.peerConnection;if(!t)return;this.connection.peerConnection=null,t.onicecandidate=t.oniceconnectionstatechange=t.ondatachannel=t.ontrack=()=>{};let e="closed"!==t.signalingState,r=!1,i=this.connection.dataChannel;i&&(r=!!i.readyState&&"closed"!==i.readyState),(e||r)&&t.close()}async _makeOffer(){let t=this.connection.peerConnection,e=this.connection.provider;try{let r=await t.createOffer(this.connection.options.constraints);d.log("Created offer."),this.connection.options.sdpTransform&&"function"==typeof this.connection.options.sdpTransform&&(r.sdp=this.connection.options.sdpTransform(r.sdp)||r.sdp);try{await t.setLocalDescription(r),d.log("Set localDescription:",r,`for:${this.connection.peer}`);let i={sdp:r,type:this.connection.type,connectionId:this.connection.connectionId,metadata:this.connection.metadata};if(this.connection.type===E.Data){let t=this.connection;i={...i,label:t.label,reliable:t.reliable,serialization:t.serialization}}e.socket.send({type:_.Offer,payload:i,dst:this.connection.peer})}catch(t){"OperationError: Failed to set local offer sdp: Called in wrong state: kHaveRemoteOffer"!=t&&(e.emitError(v.WebRTC,t),d.log("Failed to setLocalDescription, ",t))}}catch(t){e.emitError(v.WebRTC,t),d.log("Failed to createOffer, ",t)}}async _makeAnswer(){let t=this.connection.peerConnection,e=this.connection.provider;try{let r=await t.createAnswer();d.log("Created answer."),this.connection.options.sdpTransform&&"function"==typeof this.connection.options.sdpTransform&&(r.sdp=this.connection.options.sdpTransform(r.sdp)||r.sdp);try{await t.setLocalDescription(r),d.log("Set localDescription:",r,`for:${this.connection.peer}`),e.socket.send({type:_.Answer,payload:{sdp:r,type:this.connection.type,connectionId:this.connection.connectionId},dst:this.connection.peer})}catch(t){e.emitError(v.WebRTC,t),d.log("Failed to setLocalDescription, ",t)}}catch(t){e.emitError(v.WebRTC,t),d.log("Failed to create answer, ",t)}}async handleSDP(t,e){e=new RTCSessionDescription(e);let r=this.connection.peerConnection,i=this.connection.provider;d.log("Setting remote description",e);let n=this;try{await r.setRemoteDescription(e),d.log(`Set remoteDescription:${t} for:${this.connection.peer}`),"OFFER"===t&&await n._makeAnswer()}catch(t){i.emitError(v.WebRTC,t),d.log("Failed to setRemoteDescription, ",t)}}async handleCandidate(t){d.log("handleCandidate:",t);try{await this.connection.peerConnection.addIceCandidate(t),d.log(`Added ICE candidate for:${this.connection.peer}`)}catch(t){this.connection.provider.emitError(v.WebRTC,t),d.log("Failed to handleCandidate, ",t)}}_addTracksToConnection(t,e){if(d.log(`add tracks from stream ${t.id} to peer connection`),!e.addTrack)return d.error("Your browser does't support RTCPeerConnection#addTrack. Ignored.");t.getTracks().forEach((r=>{e.addTrack(r,t)}))}_addStreamToMediaConnection(t,e){d.log(`add stream ${t.id} to media connection ${e.connectionId}`),e.addStream(t)}},xe=class extends kt.EventEmitter{emitError(t,e){d.error("Error:",e),this.emit("error",new xt(`${t}`,e))}},xt=class extends Error{constructor(t,e){"string"==typeof e?super(e):(super(),Object.assign(this,e)),this.type=t}},Ce=class extends xe{get open(){return this._open}constructor(t,e,r){super(),this.peer=t,this.provider=e,this.options=r,this._open=!1,this.metadata=r.metadata}},Se=class t extends Ce{static#t=this.ID_PREFIX="mc_";get type(){return E.Media}get localStream(){return this._localStream}get remoteStream(){return this._remoteStream}constructor(e,r,i){super(e,r,i),this._localStream=this.options._stream,this.connectionId=this.options.connectionId||t.ID_PREFIX+S.randomToken(),this._negotiator=new _e(this),this._localStream&&this._negotiator.startConnection({_stream:this._localStream,originator:!0})}_initializeDataChannel(t){this.dataChannel=t,this.dataChannel.onopen=()=>{d.log(`DC#${this.connectionId} dc connection success`),this.emit("willCloseOnRemote")},this.dataChannel.onclose=()=>{d.log(`DC#${this.connectionId} dc closed for:`,this.peer),this.close()}}addStream(t){d.log("Receiving stream",t),this._remoteStream=t,super.emit("stream",t)}handleMessage(t){let e=t.type,r=t.payload;switch(t.type){case _.Answer:this._negotiator.handleSDP(e,r.sdp),this._open=!0;break;case _.Candidate:this._negotiator.handleCandidate(r.candidate);break;default:d.warn(`Unrecognized message type:${e} from peer:${this.peer}`)}}answer(t,e={}){if(this._localStream)return void d.warn("Local stream already exists on this MediaConnection. Are you answering a call twice?");this._localStream=t,e&&e.sdpTransform&&(this.options.sdpTransform=e.sdpTransform),this._negotiator.startConnection({...this.options._payload,_stream:t});let r=this.provider._getMessages(this.connectionId);for(let t of r)this.handleMessage(t);this._open=!0}close(){this._negotiator&&(this._negotiator.cleanup(),this._negotiator=null),this._localStream=null,this._remoteStream=null,this.provider&&(this.provider._removeConnection(this),this.provider=null),this.options&&this.options._stream&&(this.options._stream=null),this.open&&(this._open=!1,super.emit("close"))}},Ct=class{constructor(t){this._options=t}_buildRequest(t){let e=this._options.secure?"https":"http",{host:r,port:i,path:n,key:s}=this._options,a=new URL(`${e}://${r}:${i}${n}${s}/${t}`);return a.searchParams.set("ts",`${Date.now()}${Math.random()}`),a.searchParams.set("version",Et.version),fetch(a.href,{referrerPolicy:this._options.referrerPolicy})}async retrieveId(){try{let t=await this._buildRequest("id");if(200!==t.status)throw new Error(`Error. Status:${t.status}`);return t.text()}catch(t){d.error("Error retrieving ID",t);let e="";throw"/"===this._options.path&&this._options.host!==S.CLOUD_HOST&&(e=" If you passed in a `path` to your self-hosted PeerServer, you'll also need to pass in that same path when creating a new Peer."),new Error("Could not get an ID from the server."+e)}}async listAllPeers(){try{let t=await this._buildRequest("peers");if(200!==t.status){if(401===t.status){let t="";throw t=this._options.host===S.CLOUD_HOST?"It looks like you're using the cloud server. You can email team@peerjs.com to enable peer listing for your API key.":"You need to enable `allow_discovery` on your self-hosted PeerServer to use this feature.",new Error("It doesn't look like you have permission to list peers IDs. "+t)}throw new Error(`Error. Status:${t.status}`)}return t.json()}catch(t){throw d.error("Error retrieving list peers",t),new Error("Could not get list peers from the server."+t)}}},D=class t extends Ce{static#t=this.ID_PREFIX="dc_";static#e=this.MAX_BUFFERED_AMOUNT=8388608;get type(){return E.Data}constructor(e,r,i){super(e,r,i),this.connectionId=this.options.connectionId||t.ID_PREFIX+nr(),this.label=this.options.label||this.connectionId,this.reliable=!!this.options.reliable,this._negotiator=new _e(this),this._negotiator.startConnection(this.options._payload||{originator:!0,reliable:this.reliable})}_initializeDataChannel(t){this.dataChannel=t,this.dataChannel.onopen=()=>{d.log(`DC#${this.connectionId} dc connection success`),this._open=!0,this.emit("open")},this.dataChannel.onmessage=t=>{d.log(`DC#${this.connectionId} dc onmessage:`,t.data)},this.dataChannel.onclose=()=>{d.log(`DC#${this.connectionId} dc closed for:`,this.peer),this.close()}}close(t){t?.flush?this.send({__peerData:{type:"close"}}):(this._negotiator&&(this._negotiator.cleanup(),this._negotiator=null),this.provider&&(this.provider._removeConnection(this),this.provider=null),this.dataChannel&&(this.dataChannel.onopen=null,this.dataChannel.onmessage=null,this.dataChannel.onclose=null,this.dataChannel=null),this.open&&(this._open=!1,super.emit("close")))}send(t,e=!1){if(this.open)return this._send(t,e);this.emitError(q.NotOpenYet,"Connection is not open. You should listen for the `open` event before sending messages.")}async handleMessage(t){let e=t.payload;switch(t.type){case _.Answer:await this._negotiator.handleSDP(t.type,e.sdp);break;case _.Candidate:await this._negotiator.handleCandidate(e.candidate);break;default:d.warn("Unrecognized message type:",t.type,"from peer:",this.peer)}}},Z=class extends D{get bufferSize(){return this._bufferSize}_initializeDataChannel(t){super._initializeDataChannel(t),this.dataChannel.binaryType="arraybuffer",this.dataChannel.addEventListener("message",(t=>this._handleDataMessage(t)))}_bufferedSend(t){(this._buffering||!this._trySend(t))&&(this._buffer.push(t),this._bufferSize=this._buffer.length)}_trySend(t){if(!this.open)return!1;if(this.dataChannel.bufferedAmount>D.MAX_BUFFERED_AMOUNT)return this._buffering=!0,setTimeout((()=>{this._buffering=!1,this._tryBuffer()}),50),!1;try{this.dataChannel.send(t)}catch(t){return d.error(`DC#:${this.connectionId} Error when sending:`,t),this._buffering=!0,this.close(),!1}return!0}_tryBuffer(){if(!this.open||0===this._buffer.length)return;let t=this._buffer[0];this._trySend(t)&&(this._buffer.shift(),this._bufferSize=this._buffer.length,this._tryBuffer())}close(t){t?.flush?this.send({__peerData:{type:"close"}}):(this._buffer=[],this._bufferSize=0,super.close())}constructor(...t){super(...t),this._buffer=[],this._bufferSize=0,this._buffering=!1}},W=class extends Z{close(t){super.close(t),this._chunkedData={}}constructor(t,e,r){super(t,e,r),this.chunker=new ve,this.serialization=B.Binary,this._chunkedData={}}_handleDataMessage({data:t}){let e=De(t),r=e.__peerData;if(r)return"close"===r.type?void this.close():void this._handleChunk(e);this.emit("data",e)}_handleChunk(t){let e=t.__peerData,r=this._chunkedData[e]||{data:[],count:0,total:t.total};if(r.data[t.n]=new Uint8Array(t.data),r.count++,this._chunkedData[e]=r,r.total===r.count){delete this._chunkedData[e];let t=jr(r.data);this._handleDataMessage({data:t})}}_send(t,e){let r=Ie(t);if(r instanceof Promise)return this._send_blob(r);!e&&r.byteLength>this.chunker.chunkedMTU?this._sendChunks(r):this._bufferedSend(r)}async _send_blob(t){let e=await t;e.byteLength>this.chunker.chunkedMTU?this._sendChunks(e):this._bufferedSend(e)}_sendChunks(t){let e=this.chunker.chunk(t);d.log(`DC#${this.connectionId} Try to send ${e.length} chunks...`);for(let t of e)this.send(t,!0)}},St=class extends Z{_handleDataMessage({data:t}){super.emit("data",t)}_send(t,e){this._bufferedSend(t)}constructor(...t){super(...t),this.serialization=B.None}},bt=class extends Z{_handleDataMessage({data:t}){let e=this.parse(this.decoder.decode(t)),r=e.__peerData;r&&"close"===r.type?this.close():this.emit("data",e)}_send(t,e){let r=this.encoder.encode(this.stringify(t));r.byteLength>=S.chunkedMTU?this.emitError(q.MessageToBig,"Message too big for JSON channel"):this._bufferedSend(r)}constructor(...t){super(...t),this.serialization=B.JSON,this.encoder=new TextEncoder,this.decoder=new TextDecoder,this.stringify=JSON.stringify,this.parse=JSON.parse}},be=class t extends xe{static#t=this.DEFAULT_KEY="peerjs";get id(){return this._id}get options(){return this._options}get open(){return this._open}get socket(){return this._socket}get connections(){let t=Object.create(null);for(let[e,r]of this._connections)t[e]=r;return t}get destroyed(){return this._destroyed}get disconnected(){return this._disconnected}constructor(e,r){let i;super(),this._serializers={raw:St,json:bt,binary:W,"binary-utf8":W,default:W},this._id=null,this._lastServerId=null,this._destroyed=!1,this._disconnected=!1,this._open=!1,this._connections=new Map,this._lostMessages=new Map,e&&e.constructor==Object?r=e:e&&(i=e.toString()),r={debug:0,host:S.CLOUD_HOST,port:S.CLOUD_PORT,path:"/",key:t.DEFAULT_KEY,token:S.randomToken(),config:S.defaultConfig,referrerPolicy:"strict-origin-when-cross-origin",serializers:{},...r},this._options=r,this._serializers={...this._serializers,...this.options.serializers},"/"===this._options.host&&(this._options.host=window.location.hostname),this._options.path&&("/"!==this._options.path[0]&&(this._options.path="/"+this._options.path),"/"!==this._options.path[this._options.path.length-1]&&(this._options.path+="/")),void 0===this._options.secure&&this._options.host!==S.CLOUD_HOST?this._options.secure=S.isSecure():this._options.host==S.CLOUD_HOST&&(this._options.secure=!0),this._options.logFunction&&d.setLogFunction(this._options.logFunction),d.logLevel=this._options.debug||0,this._api=new Ct(r),this._socket=this._createServerConnection(),S.supports.audioVideo||S.supports.data?!i||S.validateId(i)?i?this._initialize(i):this._api.retrieveId().then((t=>this._initialize(t))).catch((t=>this._abort(v.ServerError,t))):this._delayedAbort(v.InvalidID,`ID "${i}" is invalid`):this._delayedAbort(v.BrowserIncompatible,"The current browser does not support WebRTC")}_createServerConnection(){let t=new _t(this._options.secure,this._options.host,this._options.port,this._options.path,this._options.key,this._options.pingInterval);return t.on(k.Message,(t=>{this._handleMessage(t)})),t.on(k.Error,(t=>{this._abort(v.SocketError,t)})),t.on(k.Disconnected,(()=>{this.disconnected||(this.emitError(v.Network,"Lost connection to server."),this.disconnect())})),t.on(k.Close,(()=>{this.disconnected||this._abort(v.SocketClosed,"Underlying socket is already closed.")})),t}_initialize(t){this._id=t,this.socket.start(t,this._options.token)}_handleMessage(t){let e=t.type,r=t.payload,i=t.src;switch(e){case _.Open:this._lastServerId=this.id,this._open=!0,this.emit("open",this.id);break;case _.Error:this._abort(v.ServerError,r.msg);break;case _.IdTaken:this._abort(v.UnavailableID,`ID "${this.id}" is taken`);break;case _.InvalidKey:this._abort(v.InvalidKey,`API KEY "${this._options.key}" is invalid`);break;case _.Leave:d.log(`Received leave message from ${i}`),this._cleanupPeer(i),this._connections.delete(i);break;case _.Expire:this.emitError(v.PeerUnavailable,`Could not connect to peer ${i}`);break;case _.Offer:{let t=r.connectionId,e=this.getConnection(i,t);if(e&&(e.close(),d.warn(`Offer received for existing Connection ID:${t}`)),r.type===E.Media){let n=new Se(i,this,{connectionId:t,_payload:r,metadata:r.metadata});e=n,this._addConnection(i,e),this.emit("call",n)}else{if(r.type!==E.Data)return void d.warn(`Received malformed connection type:${r.type}`);{let n=new this._serializers[r.serialization](i,this,{connectionId:t,_payload:r,metadata:r.metadata,label:r.label,serialization:r.serialization,reliable:r.reliable});e=n,this._addConnection(i,e),this.emit("connection",n)}}let n=this._getMessages(t);for(let t of n)e.handleMessage(t);break}default:{if(!r)return void d.warn(`You received a malformed message from ${i} of type ${e}`);let n=r.connectionId,s=this.getConnection(i,n);s&&s.peerConnection?s.handleMessage(t):n?this._storeMessage(n,t):d.warn("You received an unrecognized message:",t);break}}}_storeMessage(t,e){this._lostMessages.has(t)||this._lostMessages.set(t,[]),this._lostMessages.get(t).push(e)}_getMessages(t){let e=this._lostMessages.get(t);return e?(this._lostMessages.delete(t),e):[]}connect(t,e={}){if(e={serialization:"default",...e},this.disconnected)return d.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect, or call reconnect on this peer if you believe its ID to still be available."),void this.emitError(v.Disconnected,"Cannot connect to new Peer after disconnecting from server.");let r=new this._serializers[e.serialization](t,this,e);return this._addConnection(t,r),r}call(t,e,r={}){if(this.disconnected)return d.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect."),void this.emitError(v.Disconnected,"Cannot connect to new Peer after disconnecting from server.");if(!e)return void d.error("To call a peer, you must provide a stream from your browser's `getUserMedia`.");let i=new Se(t,this,{...r,_stream:e});return this._addConnection(t,i),i}_addConnection(t,e){d.log(`add connection ${e.type}:${e.connectionId} to peerId:${t}`),this._connections.has(t)||this._connections.set(t,[]),this._connections.get(t).push(e)}_removeConnection(t){let e=this._connections.get(t.peer);if(e){let r=e.indexOf(t);-1!==r&&e.splice(r,1)}this._lostMessages.delete(t.connectionId)}getConnection(t,e){let r=this._connections.get(t);if(!r)return null;for(let t of r)if(t.connectionId===e)return t;return null}_delayedAbort(t,e){setTimeout((()=>{this._abort(t,e)}),0)}_abort(t,e){d.error("Aborting!"),this.emitError(t,e),this._lastServerId?this.disconnect():this.destroy()}destroy(){this.destroyed||(d.log(`Destroy peer with ID:${this.id}`),this.disconnect(),this._cleanup(),this._destroyed=!0,this.emit("close"))}_cleanup(){for(let t of this._connections.keys())this._cleanupPeer(t),this._connections.delete(t);this.socket.removeAllListeners()}_cleanupPeer(t){let e=this._connections.get(t);if(e)for(let t of e)t.close()}disconnect(){if(this.disconnected)return;let t=this.id;d.log(`Disconnect peer with ID:${t}`),this._disconnected=!0,this._open=!1,this.socket.close(),this._lastServerId=t,this._id=null,this.emit("disconnected",t)}reconnect(){if(this.disconnected&&!this.destroyed)d.log(`Attempting reconnection to server with ID ${this._lastServerId}`),this._disconnected=!1,this._initialize(this._lastServerId);else{if(this.destroyed)throw new Error("This peer cannot reconnect to the server. It has already been destroyed.");if(this.disconnected||this.open)throw new Error(`Peer ${this.id} cannot reconnect because it is not disconnected from the server!`);d.error("In a hurry? We're still trying to make the initial connection!")}}listAllPeers(t=t=>{}){this._api.listAllPeers().then((e=>t(e))).catch((t=>this._abort(v.ServerError,t)))}};class Client{id;audio;video;close;input;state;data;constructor(t,e,r,i,n,s,a){this.id=t,this.audio=e,this.video=r,this.close=i,this.input=n,this.state=s,this.data=a}}let no_client=t=>new Client((()=>0),(()=>0),(()=>0),(()=>0),(()=>new Input(0,0,(()=>!1),[],[],[])),(()=>"empty"),(()=>t)),camera=(t,e,r)=>{let i=[e,translate(0,0,0)];return!1===t.init||!1===t.xr_support||null===t.xr_cameras?i:t.xr_cameras[r]};class HostClient{id;conn;canvas;canvas_sync;state;data;input;audio_context;audio_destination;init;xr_support;xr_cameras;xr_hands;constructor(t,e,r,i,n,s,a,o,h,c,l,u,d){this.id=t,this.conn=e,this.canvas=r,this.canvas_sync=i,this.state=n,this.data=s,this.input=a,this.audio_context=o,this.audio_destination=h,this.init=c,this.xr_support=l,this.xr_cameras=u,this.xr_hands=d}}let peer_on_connection=t=>new Promise((e=>{t.on("open",(t=>{e(t)}))}));const host=(t,e)=>{let r=null;return{open:i=>{if(null!==r)throw new Error;return r=new_host(i,t,e),r.open()},clients:()=>null===r?[]:r.clients()}};let new_host=(t,e,r)=>{let i=r?.slots,n=players_new(i),s=[],a=0,o="playcon-",h=new be(o+t,{secure:!1});h.on("error",(t=>{console.error(t)}));let c=null;peer_on_connection(h).then((t=>{c=t.slice(8),h.on("connection",(t=>{a++;let r=new Map,i=new Input(0,0,(t=>!!r.get(t)),[],[],[]),n=new HostClient(a,t,document.createElement("canvas"),!1,"connect",e(),i,null,null,!1,!1,null,null);t.on("open",(()=>{s.push(n),t.on("data",(e=>{let i=()=>t.send(""),s=JSON.parse(e);return!0===s?.log?(console.warn(s?.text),i()):s?.login?(n.init=!0,n.xr_support=!!s?.xr,i()):!1===n.init?i():(n.xr_cameras=s.xr_mat4s,n.xr_hands=s.xr_hands,n.input.keys=n.input.keys.concat(s.keys),n.input.ptrs=n.input.ptrs.concat(s.ptrs),n.input.clicks=n.input.clicks.concat(s.clicks),s.keys.forEach((t=>{r.set(t.code,"down"===t.action)})),void i())}))})),t.on("close",(()=>{n.state="closed"}))}))}));return{open:()=>new Promise((t=>{let e=()=>{null===c?setTimeout(e,1):t()};e()})),clients:()=>{let t=s.map((t=>{let e=t.input,r=t.state;return new Client((()=>t.id),(e=>{if(null!==t.audio_context){let r=new Audio(e),i=t.audio_context.createMediaElementSource(r);null!==t.audio_destination&&i.connect(t.audio_destination),r.loop=!1,r.play()}}),((e,r)=>{if(!1===t.init)return;let i=camera(t,e,0),n=r(i[0],i[1]);if(!1===t.canvas_sync){let e=new AudioContext;if("suspended"===e.state)return;t.canvas_sync=!0,t.canvas.width=n.width*(t.xr_support?2:1),t.canvas.height=n.height;let r=t.canvas.captureStream(60);t.audio_context=e,t.audio_destination=t.audio_context.createMediaStreamDestination();let i=t.audio_destination.stream.getAudioTracks()[0];r.addTrack(i),h.call(t.conn.peer,r)}if(t.canvas.getContext("2d")?.drawImage(n,0,0,n.width,n.height),!1===t.xr_support)return;if(i=camera(t,e,1),n=r(i[0],i[1]),t.canvas.getContext("2d")?.drawImage(n,n.width,0,n.width,n.height),null===t.xr_hands)return;let s=e=>{e.forEach((e=>{let r=n.width/2+e[12]*n.width,i=n.height/2+-e[13]*n.height,s=t.canvas.getContext("2d");s.beginPath(),s.arc(r,i,5,0,2*Math.PI),s.fillStyle="black",s.fill()}))};s(t.xr_hands[0]),s(t.xr_hands[1])}),(()=>{}),(()=>e),(()=>r),(()=>t.data))}));return s=s.filter((t=>(t.input=new Input(0,0,t.input.key,[],[],[]),"connect"===t.state&&(t.state="ready"),"ready"===t.state))),null!==n&&(t=n.from_clients(t,e)),t}}},players_new=t=>{let e=[];for(let r=0;r<t;r++)e.push(0);let r={join:r=>{for(let i=0;i<t;i++)if(0===e[i])return e[i]=r,!0;return!1},leave:r=>{for(let i=0;i<t;i++)if(e[i]===r)return e[i]=0,!0;return!1},get:r=>{for(let i=0;i<t;i++)if(e[i]===r)return i+1;return 0},from_clients:(t,i)=>{t.forEach((t=>{"connect"===t.state()&&!1===r.join(t.id())&&t.close()}));let n=e.map((e=>{let r=t.findIndex((t=>t.id()===e));return-1!==r?t[r]:no_client(i())}));return t.forEach((t=>{"closed"===t.state()&&r.leave(t.id())})),n}};return r};class Player{x;z;constructor(t,e){this.x=t,this.z=e}}let app=async(t,e)=>{let r=e(1e3,1e3),i=gfx(r),n=i.buffer({depth:!0}),s=i.mesh(sphere()),a=host((()=>new Player(0,0)),{slots:3}),o=new Player(0,0),h=[];for(let t=-10;t<10;t+=2)h.push([t,10*Math.random(),-2-10*Math.random()]);return async t=>{if(t.keys.some((t=>"KeyX"===t.code&&"up"===t.action))){let t="http://localhost:777/C:/@astor/@gkit/rtc/rtc.html?id=",e="eee";a.open(e),console.log(t+e)}let e=a.clients();[[t,o]].concat(e.map((t=>[t.input(),t.data()]))).forEach((([t,e])=>{t.key("KeyA")&&(e.x-=.01),t.key("KeyD")&&(e.x+=.01),t.key("KeyW")&&(e.z-=.01),t.key("KeyS")&&(e.z+=.01)})),e.forEach((t=>{t.input().clicks.length&&t.audio("13_jammer.ogg"),t.input().ptrs.length}));let c=(e,r,a)=>{a=mul(translate(e.x,0,e.z),a),n.clear(),n.draw({uniforms:[["time",t.time]],shader:"\n                    vec4 pixel(px p) {\n                        return vec4(wave(p.time), 0, 1, 1);\n                    }\n                "}),h.forEach((([e,r,i])=>{n.draw({depth:!0,mesh:s,uniforms:[["x",e],["y",r],["z",i],["time",t.time]],shader:"\n                        mat4[3] vertex(vx v) {\n                            mat4 model = translate(v.x, v.y, v.z);\n                            model = translate(0., 0., -10.);\n                            mat4 proj = perspective(90., 1., 0.1, 1000.);\n                            mat4 view = translate(0., 0., 0.);\n                            return mat4[3](proj, inverse(view), model);\n                        }\n                        vec4 pixel(px p) {\n                            return hue(vec4(p.normal.x, p.normal.y, p.normal.z, 1), 0.);\n                        }\n                    "})})),i.flush(n)},l=perspective(90,i.width()/i.height(),.1,1e3);e.forEach(((t,e)=>{0!==t.id()&&t.video(l,((e,i)=>(c(t.data(),0,i),r)))})),c(o,0,translate(0,0,0))}},main=()=>run(app,"");export{app,main};